<p style='text-align:center;font-size:30px;font-weight:bold'>NSQ v1.2.0ä¸­æ–‡æ–‡æ¡£</p>

# æ¦‚è§ˆ

## å¿«é€Ÿå¼€å§‹

ä¸‹è¿°æ­¥éª¤å°†åœ¨ä½ çš„æœ¬åœ°æœºå™¨ä¸Šè¿è¡Œä¸€ä¸ªå°å‹**NSQ**é›†ç¾¤ï¼Œè´¯ç©¿äº†æ¶ˆæ¯çš„å‘å¸ƒã€æ¶ˆè´¹ä»¥åŠå½’æ¡£è‡³ç£ç›˜ã€‚

1. é¦–å…ˆè·Ÿéš[å®‰è£…è¯´æ˜](https://juejin.cn/post/6932866637519552525/)æ–‡æ¡£è¿›è¡Œå®‰è£…ï¼›

2. åœ¨shellä¸­å¼€å¯`nsqlookupd`:

   ```shell
   $ nsqlookupd
   ```

3. åœ¨å¦ä¸€ä¸ªshellä¸­å¼€å¯`nsqd`:

   ```shell
   $ nsqd --lookupd-tcp-address=127.0.0.1:4160
   ```

4. åœ¨å¦ä¸€ä¸ªshellä¸­å¼€å¯`nsqadmin`ï¼š

   ```shell
   $ nsqadmin --lookupd-http-address=127.0.0.1:4161
   ```

5. å‘å¸ƒä¸€ä¸ªåˆå§‹æ¶ˆæ¯ï¼ˆä¹Ÿå°±æ˜¯åœ¨é›†ç¾¤ä¸­åˆ›å»ºä¸€ä¸ªä¸»é¢˜ï¼‰

   ```shell
   $ curl -d 'hello world 1' 'http://127.0.0.1:4151/pub?topic=test'
   ```

6. æœ€åï¼Œåœ¨å¦ä¸€ä¸ªshellä¸­å¼€å¯`nsq_to_file`:

   ```shell
   $ nsq_to_file --topic=test --output-dir=/tmp --lookupd-http-address=127.0.0.1:4161
   ```

7. å‘å¸ƒæ›´å¤šæ¶ˆæ¯åˆ°`nsqd`:

   ```shell
   $ curl -d 'hello world 2' 'http://127.0.0.1:4151/pub?topic=test'
   $ curl -d 'hello world 3' 'http://127.0.0.1:4151/pub?topic=test'
   ```

8. ä¸ºäº†éªŒè¯ä¸Šè¿°å·¥ä½œæ˜¯å¦å¦‚é¢„æœŸè¿›è¡Œï¼Œå¯ä»¥æ‰“å¼€æµè§ˆå™¨åœ°å€http://127.0.0.1:4171/ é€šè¿‡`nsqadmin`UIç•Œé¢æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥æ£€æŸ¥å†™åˆ°`/tmp`ç›®å½•ä¸‹çš„æ—¥å¿—æ–‡ä»¶(`test.*.log`)å†…å®¹ã€‚

è¿™é‡Œæœ‰ä¸ªæ¯”è¾ƒé‡è¦çš„å†…å®¹æ˜¯ï¼Œå®¢æˆ·ç«¯å¹¶æ²¡æœ‰æ˜ç¡®åœ°æŒ‡æ˜`test`ä¸»é¢˜ä»å“ªé‡Œäº§ç”Ÿï¼Œ`nsq_to_file`å°†ä»`nsqlookupd`æå–è¿™äº›ä¿¡æ¯ï¼Œå³ä½¿æ­£å¤„äºè¿æ¥ä¸­ï¼Œä¹Ÿä¸ä¼šæœ‰æ¶ˆæ¯ä¸¢å¤±ã€‚

## ç‰¹å¾ä¸ä¿è¯

`NSQ`æ˜¯ä¸€ä¸ªå®æ—¶åˆ†å¸ƒå¼æ¶ˆæ¯å¹³å°ã€‚

### ç‰¹å¾

* æ”¯æŒæ— SPOFçš„åˆ†å¸ƒå¼æ‹“æ‰‘
* æ°´å¹³æ‰©å±•(æ— ä»£ç†ï¼Œå¯æ— ç¼åœ°å‘é›†ç¾¤ä¸­æ·»åŠ æ›´å¤šèŠ‚ç‚¹)
* æ¶ˆæ¯ä¼ é€’ä½å»¶è¿Ÿæ¨é€ï¼ˆ[æ€§èƒ½](https://nsq.io/overview/performance.html)ï¼‰
* è´Ÿè½½å‡è¡¡ä»¥åŠå¤šç§é£æ ¼æ¶ˆæ¯è·¯ç”±ç»„åˆ
* æ“…é•¿æµå¼å¤„ç†ï¼ˆé«˜ååé‡ï¼‰å’Œé¢å‘ä½œä¸šï¼ˆä½ååé‡ï¼‰çš„å·¥ä½œè´Ÿè½½
* ä¸»è¦åœ¨å†…å­˜ä¸­ï¼ˆè¶…å‡ºæŸä¸ªæ°´å¹³ï¼Œæ¶ˆæ¯å°†ä»¥é€æ˜çš„æ–¹å¼ä¿å­˜åœ¨ç£ç›˜ä¸Šï¼‰
* è¿è¡Œæ—¶æœåŠ¡å‘ç°ï¼Œå¯¹äºæ¶ˆè´¹è€…æŸ¥æ‰¾ç”Ÿäº§è€…[(nsqlookupd)](https://github.com/nsqio/nsq/tree/master/nsqlookupd/README.md)
* ä¼ è¾“å±‚å®‰å…¨ ï¼ˆTLSï¼‰
* æ•°æ®æ ¼å¼ä¸å¯çŸ¥
* ä¾èµ–å°‘ï¼Œæ˜“äºéƒ¨ç½²ï¼Œå…·æœ‰åˆç†ã€æ¸…æ™°æœ‰ç•Œçš„é»˜è®¤é…ç½®
* ç®€å• TCP åè®®æ”¯æŒä»»ä½•è¯­è¨€çš„å®¢æˆ·ç«¯åº“
* ç”¨äºç»Ÿè®¡ä¿¡æ¯ã€ç®¡ç†æ“ä½œå’Œç”Ÿäº§è€…ï¼ˆæ— éœ€å‘å¸ƒå®¢æˆ·ç«¯åº“ï¼‰çš„ HTTP æ¥å£
* ä¸å®æ—¶æ£€æµ‹çš„[statsd](https://github.com/etsy/statsd/)é›†æˆ
* å¼ºå¤§çš„é›†ç¾¤ç®¡ç†æ¥å£ ï¼ˆ[nsqadmin](https://github.com/nsqio/nsq/tree/master/nsqadmin/README.md))

### ä¿è¯

ä¸ä»»ä½•åˆ†å¸ƒå¼ç³»ç»Ÿä¸€æ ·ï¼Œå®ç°ä½ çš„ç›®æ ‡éƒ½éœ€è¦ä¸€ä¸ªæ˜æ™ºçš„æƒè¡¡è¿‡ç¨‹ã€‚é€šè¿‡é€æ˜åœ°æƒè¡¡è¿™äº›æŠ˜è¡·çš„ç°å®ï¼Œæˆ‘ä»¬å¸Œæœ›å¯¹NSQåœ¨ç”Ÿäº§ä¸­éƒ¨ç½²æ—¶çš„è¡Œä¸ºè®¾å®šå¦‚ä¸‹æœŸæœ›ï¼š

* **æ¶ˆæ¯ä¸æ˜¯æŒä¹…åŒ–çš„(é»˜è®¤)**
  å°½ç®¡ç³»ç»Ÿæ”¯æŒé€šè¿‡`--mem-queue-size`è®¾ç½®"é‡Šæ”¾é˜€(release valve)",æ¶ˆæ¯å°†è¢«é€æ˜åœ°ä¿å­˜åœ¨ç£ç›˜ä¸Šï¼Œä½†NSQä¸»è¦è¿˜æ˜¯ä¸€ä¸ªåŸºäºå†…å­˜çš„æ¶ˆæ¯å¹³å°ã€‚

  **`--mem-queue-size`å¯ä»¥è¢«è®¾ç½®ä¸º0ä»¥ç¡®ä¿æ‰€æœ‰åˆ°æ¥çš„æ¶ˆæ¯è¢«æŒä¹…åŒ–åˆ°ç£ç›˜**ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœèŠ‚ç‚¹å‘ç”Ÿæ•…éšœï¼Œé‚£ä¹ˆæ‚¨å¾ˆå®¹æ˜“æ„ŸçŸ¥åˆ°é¢ä¸´çš„æ•…éšœä¼šå‡å°‘ï¼ˆä¾‹å¦‚OSæˆ–åº•å±‚IOå­ç³»ç»Ÿæ˜¯å¦å‘ç”Ÿæ•…éšœï¼‰

  å¹¶**æ²¡æœ‰å†…ç½®çš„å¤åˆ¶é›†ã€‚**ä½†æ˜¯ï¼Œç®¡ç†è¿™ç§æƒè¡¡çš„æ–¹æ³•æœ‰å¾ˆå¤šç§ï¼Œä¾‹å¦‚éƒ¨ç½²æ‹“æ‰‘å’ŒæŠ€æœ¯ä»¥å®¹é”™çš„æ–¹å¼ä¸»åŠ¨æŒä¹…åŒ–ä¸»é¢˜åˆ°ç£ç›˜ã€‚

* **æ¶ˆæ¯è‡³å°‘ä¼ é€’ä¸€æ¬¡**

  ä¸ä¸Šè¿°å¯†åˆ‡ç›¸å…³ï¼Œå‡å®šç»™å®šçš„`nsqd`èŠ‚ç‚¹ä¸ä¼šå¤±è´¥ã€‚

  è¿™æ„å‘³ç€ï¼Œ**ç”±äºå„ç§åŸå› ï¼ˆå®¢æˆ·ç«¯è¶…æ—¶ã€æ–­å¼€è¿æ¥ã€é‡æ–°å…¥é˜Ÿç­‰ï¼‰ï¼Œæ¶ˆæ¯å¯ä»¥å¤šæ¬¡ä¼ é€’**ã€‚è€Œæ‰§è¡Œå¹‚ç­‰æ“ä½œæˆ–åˆ é™¤é‡å¤ä¿¡æ¯æ˜¯å®¢æˆ·ç«¯çš„èŒè´£ã€‚

* **æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯æ— åºçš„**

  **ä¸èƒ½ä¾èµ–ä¼ é€’ç»™æ¶ˆè´¹è€…çš„æ¶ˆæ¯é¡ºåºã€‚**

  ä¸æ¶ˆæ¯ä¼ é€’çš„å­—é¢æ„ä¹‰ç±»ä¼¼ï¼Œæ¶ˆæ¯æ˜¯é‡æ–°æ’åˆ—é˜Ÿåˆ—çš„ç»“æœï¼Œæ˜¯å†…å­˜å’Œç£ç›˜å­˜å‚¨çš„ç»„åˆã€‚äº‹å®ä¸Šæ¯ä¸€ä¸ª`nsqd`èŠ‚ç‚¹ä¹‹é—´å¹¶ä¸å…±äº«ä»»ä½•ä¸œè¥¿ã€‚

  é€šè¿‡åœ¨ä½ çš„æ¶ˆè´¹è€…ä¸­å¼•å…¥ä¸€ä¸ªå»¶è¿Ÿçª—å£æ¥æ¥æ”¶æ¶ˆæ¯å¹¶ä¸”åœ¨å¤„ç†è¿™äº›æ¶ˆæ¯ä¹‹å‰ï¼ˆå°½ç®¡ä¸ºäº†ä¿æŒè¿™äº›ä¸å˜çš„æ¶ˆæ¯ï¼Œå¿…é¡»ä¸¢å¼ƒæ‰ä½äºè¯¥çª—å£ä¹‹å¤–çš„æ¶ˆæ¯ï¼‰è¿›è¡Œæ’åºï¼Œä»¥æ­¤æ¥å®å®½æ¾çš„æ’åº(å³å¯¹äºç»™å®šçš„æ¶ˆè´¹è€…ï¼Œå®ƒçš„æ¶ˆæ¯æ˜¯æœ‰åºçš„ï¼Œä½†æ˜¯åœ¨æ•´ä¸ªé›†ç¾¤ä¸­å´ä¸èƒ½ä¿è¯)æ˜¯ç›¸å¯¹ç›´æˆªäº†å½“çš„ã€‚

* **æ¶ˆè´¹è€…æœ€ç»ˆå¯ä»¥æ‰¾åˆ°æ‰€æœ‰ä¸»é¢˜ç”Ÿäº§è€…**

  å‘ç°æœåŠ¡[(nsqlookupd)](https://github.com/nsqio/nsq/tree/master/nsqlookupd/README.md)è¢«è®¾è®¡ä¸ºæœ€ç»ˆä¸€è‡´ã€‚ `nsqlookupd`èŠ‚ç‚¹ä¸ä¼šå…±åŒç»´æŠ¤çŠ¶æ€æˆ–åº”ç­”æŸ¥è¯¢ã€‚

  ç½‘ç»œåˆ†åŒºä¸ä¼šå½±å“å¯ç”¨æ€§ï¼Œä»è¿™å±‚æ„ä¹‰ä¸Šæ¥è¯´ï¼Œåˆ†åŒºçš„ä¸¤ä¾§ä»ç„¶å¯ä»¥åº”ç­”æŸ¥è¯¢ã€‚éƒ¨ç½²æ‹“æ‰‘å¯¹ç¼“è§£è¿™äº›ç±»å‹çš„é—®é¢˜å…·æœ‰æœ€é‡è¦çš„ä½œç”¨ã€‚

## å¸¸è§é—®é¢˜

### éƒ¨ç½²

- **`nsqd`çš„æ¨èæ‹“æ‰‘æ˜¯ä»€ä¹ˆï¼Ÿ**

  æˆ‘ä»¬å¼ºçƒˆå»ºè®®**åœ¨ç”Ÿæˆæ¶ˆæ¯çš„ä»»ä½•æœåŠ¡æ—è¾¹è¿è¡Œä¸€ä¸ª`nsqd`**

  `nsqd`æ˜¯ä¸€ä¸ªç›¸å¯¹è½»é‡çº§çš„è¿›ç¨‹ï¼Œå¯é™å®šå†…å­˜å ç”¨ï¼Œè¿™ä½¿å¾—å®ƒéå¸¸é€‚åˆ"ä¸åˆ«äººå¥½å¥½ç©è€"ï¼ˆ*â€œplaying nice with othersâ€*.ï¼‰ã€‚

  è¿™ç§æ¨¡å¼æœ‰åŠ©äºå°†æ¶ˆæ¯æµæ„å»ºä¸ºæ¶ˆè´¹é—®é¢˜ï¼Œè€Œä¸æ˜¯ç”Ÿäº§é—®é¢˜ã€‚

  å¦ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œè¿™ç§æ¨¡å¼åœ¨ç»™å®šä¸»æœºä¸Šä¸ºä¸»é¢˜å½¢æˆäº†ä¸€ä¸ªç‹¬ç«‹çš„ã€åˆ†ç‰‡çš„æ•°æ®å­¤å²›ã€‚

  æ³¨æ„ï¼šè¿™ä¸æ˜¯ä¸€ä¸ªç»å¯¹çš„è¦æ±‚ï¼Œå®ƒåªæ˜¯æ›´ä¸ºç®€å•ï¼ˆè§ä¸‹é¢çš„é—®é¢˜ï¼‰ã€‚

- **ä¸ºä»€ä¹ˆç”Ÿäº§è€…ä¸èƒ½ä½¿ç”¨`nsqlookupd`æ¥æŸ¥æ‰¾å‘å¸ƒåˆ°å“ªå„¿ï¼Ÿ**

  å› ä¸ºå¿…é¡»å‘Šè¯‰æ¶ˆè´¹è€…åœ¨å“ªé‡Œæ‰¾åˆ°ä»–ä»¬éœ€è¦çš„ä¸»é¢˜ï¼ŒNSQæå€¡**æ¶ˆè´¹è€…ç«¯å‘ç°**æ¨¡å‹ï¼Œä»¥å‡è½»å‰æœŸé…ç½®è´Ÿæ‹…ã€‚

  ç„¶è€Œï¼Œå¯¹äºæœåŠ¡åº”å‘å¸ƒåˆ°å“ªé‡Œï¼Œè¿™å¹¶æ²¡æœ‰æä¾›ä»»ä½•è§£å†³é—®é¢˜çš„æ‰‹æ®µã€‚è¿™æ˜¯é¸¡å’Œè›‹çš„é—®é¢˜ï¼Œä¸»é¢˜åœ¨å‘å¸ƒä¹‹å‰å¹¶ä¸å­˜åœ¨ã€‚

  é€šè¿‡å¯¹`nsqd`çš„å…±åŒå®šä½ï¼ˆè¯·å‚é˜…ä¸Šé¢çš„é—®é¢˜ï¼‰ï¼Œä½ å®Œå…¨å›é¿äº†æ­¤é—®é¢˜ï¼ˆä½ çš„æœåŠ¡åªæ˜¯å‘å¸ƒåˆ°æœ¬åœ°`nsqd`ï¼‰ï¼Œ NSQ çš„è¿è¡Œæ—¶å‘ç°ç³»ç»Ÿè‡ªç„¶åœ°è¿›è¡Œå·¥ä½œã€‚

- **æˆ‘åªæƒ³åœ¨å•ä¸ªèŠ‚ç‚¹ä¸Šä½¿ç”¨ `nsqd`ä½œä¸ºå·¥ä½œé˜Ÿåˆ—ï¼Œ è¿™æ˜¯ä¸€ä¸ªåˆé€‚çš„ç”¨ä¾‹å—ï¼Ÿ**

  æ˜¯çš„ï¼Œ `nsqd`åœ¨å•èŠ‚ç‚¹ä¸Šä¹Ÿå¯ä»¥è¿è¡Œå¾—å¾ˆå¥½ã€‚

  `nsqlookupd`æ›´æœ‰åˆ©äºåœ¨è¾ƒå¤§çš„åˆ†å¸ƒå¼ç¯å¢ƒä¸­ä½¿ç”¨ã€‚

- **æˆ‘åº”è¯¥è¿è¡Œå¤šå°‘ `nsqlookupd`?**

  é€šå¸¸åªæœ‰å‡ ä¸ªï¼Œå…·ä½“å–å†³äºé›†ç¾¤å¤§å°ã€`nsqd`èŠ‚ç‚¹æ•°å’Œæ¶ˆè´¹è€…æ•°é‡ä»¥åŠä½ æ‰€éœ€çš„å®¹é”™æ€§ã€‚

  å¯¹äºå‡ ç™¾å°ä¸»æœºå’Œæ•°åƒä¸ªæ¶ˆè´¹è€…ï¼Œéƒ¨ç½²3ä¸ªæˆ–5ä¸ªå°±å¯ä»¥å¾ˆå¥½åœ°å·¥ä½œã€‚

  `nsqlookupd`èŠ‚ç‚¹**ä¸éœ€è¦**åä½œåº”ç­”æŸ¥è¯¢ã€‚é›†ç¾¤ä¸­çš„å…ƒæ•°æ®æœ€ç»ˆæ˜¯*ä¸€è‡´çš„*ã€‚

### å‘å¸ƒ

- **æˆ‘éœ€è¦å®¢æˆ·ç«¯åº“æ¥å‘å¸ƒæ¶ˆæ¯å—ï¼Ÿ**

  ä¸ï¼åªéœ€ä½¿ç”¨ HTTPç«¯ç‚¹æ¥å‘å¸ƒï¼ˆ `/pub`å’Œ`/mpub` ï¼‰ã€‚å®ƒå¾ˆç®€å•ï¼Œå¾ˆå®¹æ˜“ï¼Œè€Œä¸”å‡ ä¹åœ¨ä»»ä½•ç¼–ç¨‹ç¯å¢ƒä¸­éƒ½æ— å¤„ä¸åœ¨ã€‚

  äº‹å®ä¸Šï¼Œç»å¤§å¤šæ•° NSQ éƒ¨ç½²éƒ½ä½¿ç”¨ HTTP æ¥å‘å¸ƒã€‚

- **ä¸ºä»€ä¹ˆè¦å¼ºåˆ¶å®¢æˆ·ç«¯å¤„ç†TCP åè®®çš„ `PUB` å’Œ`MPUB`å‘½ä»¤çš„å“åº”ï¼Ÿ**

  æˆ‘ä»¬è®¤ä¸º NSQ çš„é»˜è®¤æ“ä½œæ¨¡å¼åº”ä¼˜å…ˆè€ƒè™‘å®‰å…¨æ€§ï¼Œæˆ‘ä»¬å¸Œæœ›åè®®ç®€å•ä¸”ä¸€è‡´ã€‚

- **`PUB` æˆ–`MPUB`ä»€ä¹ˆæ—¶å€™å¯èƒ½å¤±è´¥ï¼Ÿ**

  1. ä¸»é¢˜åç§°çš„æ ¼å¼ä¸æ­£ç¡®ï¼ˆå­—ç¬¦/é•¿åº¦é™åˆ¶ï¼‰ã€‚è¯·å‚é˜…[ä¸»é¢˜å’Œé¢‘é“åç§°è§„æ ¼](https://nsq.io/clients/tcp_protocol_spec.html#notes)ã€‚
  2. æ¶ˆæ¯å¤ªå¤§ï¼ˆæ­¤é™åˆ¶ä½œä¸ºå‚æ•°è¢«æš´éœ²ç»™`nsqd` ï¼‰ã€‚
  3. ä¸»é¢˜æ­£åœ¨è¢«åˆ é™¤ã€‚
  4. `nsqd`æ­£åœ¨æ¸…ç†é€€å‡ºã€‚
  5. å‘å¸ƒæœŸé—´ä¸å®¢æˆ·ç«¯è¿æ¥ç›¸å…³çš„ä»»ä½•å¤±è´¥æ—¶ã€‚

  1å’Œ 2 åº”è§†ä¸ºç¼–ç¨‹é”™è¯¯ã€‚3å’Œ4æ˜¯ä¸å¸¸è§çš„ã€‚5æ˜¯ä»»ä½•åŸºäº TCP åè®®è‡ªç„¶æœ‰çš„ã€‚

- **å¦‚ä½•ç¼“è§£ä¸Šè¿°ç¬¬3ä¸ªé—®é¢˜ï¼Ÿ**

  åˆ é™¤ä¸»é¢˜æ˜¯ä¸€ä¸ªç›¸å¯¹ä¸é¢‘ç¹çš„æ“ä½œã€‚å¦‚æœéœ€è¦åˆ é™¤ä¸»é¢˜ï¼Œè¯·åè°ƒæ—¶é—´ï¼Œåˆ é™¤è¦ç»è¿‡è¶³å¤Ÿçš„æ—¶é—´ï¼Œä»¥ä¾¿å‘å¸ƒæ‰€å¼•å‡ºçš„ä¸»é¢˜åˆ›å»ºæ°¸è¿œä¸ä¼šæ‰§è¡Œã€‚

### è®¾è®¡ä¸ç†è®º

- **å¦‚ä½•æ¨èå‘½åä¸»é¢˜å’Œé€šé“ï¼Ÿ**

  ä¸»é¢˜åç§°åº”æè¿°æµä¸­çš„æ•°æ®ã€‚

  é€šé“åç§°åº”æè¿°å…¶æ¶ˆè´¹è€…æ‰€æ‰§è¡Œçš„å·¥ä½œã€‚

  ä¾‹å¦‚ï¼Œå¥½çš„ä¸»é¢˜åç§°å¯ä»¥ä¸º `encodes`ï¼Œ`decodes`ï¼Œ`api_requests`ï¼Œ`page_views`ï¼›å¥½çš„é€šé“åç§°ä¸º `archive`ï¼Œ`analytics_increment`ï¼Œ`spam_analysis`ã€‚

- **å•ä¸ª`nsqd`å¯ä»¥æ”¯æŒçš„ä¸»é¢˜å’Œé€šé“çš„æ•°é‡æ˜¯å¦æœ‰ä»»ä½•é™åˆ¶ï¼Ÿ**

  æ²¡æœ‰æ–½åŠ å†…ç½®é™åˆ¶ã€‚å®ƒä»…å—é™äº`nsqd`æ‰€è¿è¡Œä¸»æœºçš„å†…å­˜å’Œ CPU ï¼ˆæ¯ä¸ªå®¢æˆ·ç«¯çš„ CPU ä½¿ç”¨ç‡æå¤§åœ°å‡å°‘[#236](https://github.com/nsqio/nsq/pull/236)ï¼‰ã€‚

- **å¦‚ä½•å‘ç¾¤é›†å®£å¸ƒæ–°ä¸»é¢˜ï¼Ÿ**

  ç¬¬ä¸€æ¬¡`PUB`æˆ–è€…`SUB`ä¸€ä¸ªä¸»é¢˜å°†åœ¨`nsqd`ä¸Šåˆ›å»ºä¸»é¢˜ã€‚ä¸»é¢˜å…ƒæ•°æ®æ¥ä¸‹æ¥å°†ä¼ æ’­åˆ°é…ç½®çš„`nsqlookupd` ã€‚å…¶ä»–è®¢é˜…è€…å°†å®šæœŸæŸ¥è¯¢`nsqlookupd` æ¥å‘ç°æ­¤ä¸»é¢˜ã€‚

- **NSQ èƒ½åš Rpc å—ï¼Ÿ**

  è¿™æ˜¯å¯èƒ½çš„ï¼Œä½†æ˜¯åœ¨è®¾è®¡NSQæ—¶å¹¶æœªè€ƒè™‘åˆ°è¯¥ç”¨ä¾‹ã€‚

  æˆ‘ä»¬æ‰“ç®—å‘å¸ƒä¸€äº›æ–‡æ¡£ï¼Œä»¥äº†è§£å¦‚ä½•æ„å»ºè¯¥å†…å®¹ï¼Œä½†åœ¨æ­¤æœŸé—´ï¼Œå¦‚æœæ‚¨æœ‰å…´è¶£ï¼Œè¯·ä¼¸å‡ºæ´æ‰‹ã€‚

### pynsq ç‰¹å®šçš„é—®é¢˜

- **ä½ ä¸ºä»€ä¹ˆå¼ºè¿«æˆ‘ä½¿ç”¨Tornadoï¼Ÿ**

  `pynsq`æœ€åˆæ‰“ç®—ä½œä¸ºä»¥æ¶ˆè´¹è€…ä¸ºå¯¼å‘çš„åº“ï¼Œåœ¨ Python çš„å¼‚æ­¥æ¡†æ¶ï¼ˆç‰¹åˆ«æ˜¯ç”±äº NSQ é¢å‘æ¨é€çš„åè®®ï¼‰ä¸­ä½¿ç”¨ NSQ åè®®è¦ç®€å•å¾—å¤šã€‚

  Tornadoçš„ API å¾ˆç®€å•ï¼Œæ€§èƒ½ç›¸å½“å¥½ã€‚

- **Tornadoçš„ IOLoopéœ€è¦å‘å¸ƒå—ï¼Ÿ**

  ä¸éœ€è¦ï¼Œ`nsqd`æš´éœ²äº† HTTP ç«¯ç‚¹(`/PUB`å’Œ`/MPUB`)ä»¥éå¸¸ç®€å•çš„ç”¨äºç¼–ç¨‹è¯­è¨€ä¸å¯çŸ¥çš„å‘å¸ƒï¼ˆagnostic publishingï¼‰ã€‚

  å¦‚æœä½ æ‹…å¿ƒ HTTP çš„å¼€é”€ï¼Œé‚£æ²¡æœ‰å¿…è¦ã€‚æ­¤å¤–ï¼Œ`/mpub`é€šè¿‡æ‰¹é‡å‘å¸ƒï¼ˆåŸå­å‘å¸ƒï¼ï¼‰æ¥å‡å°‘ HTTP çš„å¼€é”€ã€‚

- **æˆ‘ä»€ä¹ˆæ—¶å€™è¦ä½¿ç”¨`Writer`?**

  å½“é«˜æ€§èƒ½å’Œä½å¼€é”€æ˜¯ä¸€ä¸ªä¼˜å…ˆäº‹é¡¹ã€‚

  `Writer`ä½¿ç”¨TCPåè®®`PUB`å’Œ`MPUB`å‘½ä»¤ï¼Œä¸å…¶ä»–HTTPåŒè¡Œç›¸æ¯”æ‹¥æœ‰æ›´å°çš„å¼€é”€ã€‚

- **å¦‚æœæˆ‘åªæƒ³ "fire and forget" ï¼ˆæˆ‘å¯ä»¥å®¹å¿æ¶ˆæ¯ä¸¢å¤±ï¼**

  ä½¿ç”¨ `Writer`å¹¶ä¸”å¯¹å‘å¸ƒæ–¹æ³•ä¸æŒ‡å®šå›è°ƒã€‚

  æ³¨æ„ï¼šè¿™åªæœ‰åˆ©äºäº§ç”Ÿæ›´ç®€å•çš„`pynsq`å®¢æˆ·ç«¯ä»£ç ï¼Œåœ¨å¹•åä»è¦å¤„ç†æ¥è‡ª`nsqd`çš„å“åº”ï¼ˆå°±æ˜¯è¯´è¿™æ ·åšæ²¡æœ‰ä»€ä¹ˆæ€§èƒ½ä¼˜åŠ¿ï¼‰ã€‚

ç‰¹åˆ«æ„Ÿè°¢Dustin Oprea ([@DustinOprea](https://twitter.com/DustinOprea))å¯åŠ¨è¿™ä¸ªå¸¸è§é—®é¢˜

## æ€§èƒ½

ä¸»ä»“åº“æœ‰ä¸€ä¸ªè„šæœ¬(`bench/bench.py`)ï¼Œå®ƒä¼šè‡ªåŠ¨æ‰§è¡Œä¸€ä¸ªEC2ä¸Šçš„åˆ†å¸ƒå¼åŸºå‡†æµ‹è¯•ã€‚å®ƒä¼šå¼•å¯¼Nä¸ªèŠ‚ç‚¹ï¼Œä¸€äº›èŠ‚ç‚¹æ­£åœ¨è¿è¡Œ`nsqd`ï¼Œä¸€äº›èŠ‚ç‚¹åœ¨è´Ÿè½½ç”ŸæˆPUBå’ŒSUBåº”ç”¨ï¼Œç„¶åè§£æè¿™äº›èŠ‚ç‚¹çš„è¾“å‡ºä»¥ä¾›æ€»ä½“èšåˆã€‚

### å®‰è£…

ä¸‹é¢è¿è¡Œçš„å‘½ä»¤ååº”äº†6ä¸ª`c3.2xlarge`çš„é»˜è®¤å‚æ•°ï¼Œæœ€ä¾¿å®œçš„å®ä¾‹ç±»å‹æ”¯æŒ1gbitçš„é“¾æ¥ã€‚3ä¸ªèŠ‚ç‚¹åˆ†åˆ«è¿è¡Œäº†ä¸€ä¸ª`nsqd`å®ä¾‹ï¼Œå…¶ä½™èŠ‚ç‚¹è¿è¡Œç€`bench_reader(SUB)`å®ä¾‹å’Œ`bench_writer(PUB)`å®ä¾‹ï¼Œä»¥æ­¤ç”Ÿæˆä¾èµ–äºåŸºå‡†æµ‹è¯•æ¨¡å¼çš„è´Ÿè½½ã€‚

```shell
$ ./bench/bench.py --access-key=... --secret-key=... --ssh-key-name=...
[I 140917 10:58:10 bench:102] launching 6 instances
[I 140917 10:58:12 bench:111] waiting for instances to launch...
...
[I 140917 10:58:37 bench:130] (1) bootstrapping ec2-54-160-145-64.compute-1.amazonaws.com (i-0a018ce1)
[I 140917 10:59:37 bench:130] (2) bootstrapping ec2-54-90-195-149.compute-1.amazonaws.com (i-0f018ce4)
[I 140917 11:00:00 bench:130] (3) bootstrapping ec2-23-22-236-55.compute-1.amazonaws.com (i-0e018ce5)
[I 140917 11:00:41 bench:130] (4) bootstrapping ec2-23-23-40-113.compute-1.amazonaws.com (i-0d018ce6)
[I 140917 11:01:10 bench:130] (5) bootstrapping ec2-54-226-180-44.compute-1.amazonaws.com (i-0c018ce7)
[I 140917 11:01:43 bench:130] (6) bootstrapping ec2-54-90-83-223.compute-1.amazonaws.com (i-10018cfb)
```

### ç”Ÿäº§è€…ååé‡

æ­¤åŸºå‡†æµ‹è¯•ä»…æµ‹é‡äº†ç”Ÿäº§è€…çš„ååé‡ï¼Œæ²¡æœ‰é¢å¤–çš„è´Ÿè½½ã€‚æ¶ˆæ¯çš„å¤§å°æ˜¯100å­—èŠ‚ï¼Œå¹¶ä¸”æ¶ˆæ¯åˆ†å¸ƒäº3ä¸ªä¸»é¢˜ä¸­ã€‚

```shell
$ ./bench/bench.py --access-key=... --secret-key=... --ssh-key-name=... --mode=pub --msg-size=100 run
[I 140917 12:39:37 bench:140] launching nsqd on 3 host(s)
[I 140917 12:39:41 bench:163] launching 9 producer(s) on 3 host(s)
...
[I 140917 12:40:20 bench:248] [bench_writer] 10.002s - 197.463mb/s - 2070549.631ops/s - 4.830us/op
```

è¿›å…¥é€Ÿåº¦(`ingress`)çº¦ä¸º`2.07mm` msgs/secï¼Œæ¶ˆè€—äº†æ€»è®¡197mb/sçš„å¸¦å®½ã€‚

### ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ååé‡

æ­¤åŸºå‡†é€šè¿‡ä¸ºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æä¾›æœåŠ¡ï¼Œæ›´å‡†ç¡®åœ°åæ˜ äº†çœŸå®æƒ…å†µã€‚åŒæ ·ï¼Œæ¶ˆæ¯å¤§å°ä¸º 100 å­—èŠ‚ï¼Œæ¶ˆæ¯åˆ†å¸ƒåœ¨ 3 ä¸ªä¸»é¢˜ä¸­ï¼Œæ¯ä¸ªä¸»é¢˜å…·æœ‰å•ä¸ª*é€šé“*ï¼ˆæ¯ä¸ªé€šé“ 24 ä¸ªå®¢æˆ·ç«¯ï¼‰ã€‚

```
$ ./bench/bench.py --access-key=... --secret-key=... --ssh-key-name=... --msg-size=100 run
[I 140917 12:41:11 bench:140] launching nsqd on 3 host(s)
[I 140917 12:41:15 bench:163] launching 9 producer(s) on 3 host(s)
[I 140917 12:41:22 bench:186] launching 9 consumer(s) on 3 host(s)
...
[I 140917 12:41:55 bench:248] [bench_reader] 10.252s - 76.946mb/s - 806838.610ops/s - 12.706us/op
[I 140917 12:41:55 bench:248] [bench_writer] 10.030s - 80.315mb/s - 842149.615ops/s - 11.910us/op
```

åœ¨å¤§çº¦`842k `å’Œ `806k` msgs/s çš„å…¥å£å’Œå‡ºå£æ—¶ï¼Œæ¶ˆè€—äº† æ€»è®¡156mb/s çš„å¸¦å®½ï¼Œæˆ‘ä»¬ç°åœ¨åœ¨`nsqd`èŠ‚ç‚¹ä¸Šæœ€å¤§åŒ–äº† CPU å®¹é‡ã€‚é€šè¿‡å¼•å…¥æ¶ˆè´¹è€…ï¼Œ`nsqd`éœ€è¦ç»´æŠ¤æ¯ä¸ªé€šé“çš„æ¶ˆæ¯ä¼ é€’ï¼Œå› æ­¤è´Ÿè½½è‡ªç„¶ä¼šæ›´é«˜ã€‚

æ¶ˆè´¹è€…çš„æ•°é‡ç•¥ä½äºç”Ÿäº§è€…ï¼Œå› ä¸ºæ¶ˆè´¹è€…å‘é€çš„å‘½ä»¤æ•°é‡æ˜¯ç”Ÿäº§è€…çš„ä¸¤å€ï¼ˆå¿…é¡»ä¸ºæ¯æ¡æ¶ˆæ¯å‘é€ä¸€ä¸ª`FIN`å‘½ä»¤ï¼‰ï¼Œä»è€Œå½±å“äº†ååé‡ã€‚

å†æ·»åŠ  2 ä¸ªèŠ‚ç‚¹ï¼ˆä¸€ä¸ª`nsqd`å’Œä¸€ä¸ªè´Ÿè½½ç”Ÿæˆ(load-generating)ï¼‰è¾¾åˆ°è¶…è¿‡ `1mm` msgs/s:

```shell
$ ./bench/bench.py --access-key=... --secret-key=... --ssh-key-name=... --msg-size=100 run
[I 140917 13:38:28 bench:140] launching nsqd on 4 host(s)
[I 140917 13:38:32 bench:163] launching 16 producer(s) on 4 host(s)
[I 140917 13:38:43 bench:186] launching 16 consumer(s) on 4 host(s)
...
[I 140917 13:39:12 bench:248] [bench_reader] 10.561s - 100.956mb/s - 1058624.012ops/s - 9.976us/op
[I 140917 13:39:12 bench:248] [bench_writer] 10.023s - 105.898mb/s - 1110408.953ops/s - 9.026us/op
```

### å•èŠ‚ç‚¹æ€§èƒ½

å…è´£å£°æ˜ï¼šè¯·è®°ä½**ï¼ŒNSQ**æ—¨åœ¨ä»¥åˆ†å¸ƒå¼æ–¹å¼ä½¿ç”¨ã€‚å•èŠ‚ç‚¹æ€§èƒ½è™½ç„¶å¾ˆé‡è¦ï¼Œä½†ä¸æ˜¯æˆ‘ä»¬æ‰€è¦å®ç°çš„ä¸€åˆ‡ã€‚æ­¤å¤–ï¼Œ åŸºå‡†æµ‹è¯•æ˜¯æ„šè ¢çš„ï¼Œ ä½†è¿™é‡Œå¤šå°‘åšä¸ªå±•ç¤ºï¼š

- 2012 MacBook Air i7 2ghz

- go1.2

- NSQ v0.2.24

- 200 byte message

**GOMAXPROCS=1ï¼ˆ1ä¸ªå‘å¸ƒè€…ã€1ä¸ªæ¶ˆè´¹è€…ï¼‰**

```shell
$ ./bench.sh 
results...
PUB: 2014/01/12 22:09:08 duration: 2.311925588s - 82.500mb/s - 432539.873ops/s - 2.312us/op
SUB: 2014/01/12 22:09:19 duration: 6.009749983s - 31.738mb/s - 166396.273ops/s - 6.010us/op
```

**GOMAXPROCS=4ï¼ˆ4ä¸ªå‘å¸ƒè€…ï¼Œ4ä¸ªæ¶ˆè´¹è€…)**

```shell
$ ./bench.sh 
results...
PUB: 2014/01/13 16:58:05 duration: 1.411492441s - 135.130mb/s - 708469.965ops/s - 1.411us/op
SUB: 2014/01/13 16:58:16 duration: 5.251380583s - 36.321mb/s - 190426.114ops/s - 5.251us/op
```

## è®¾è®¡

æ³¨ï¼šæœ‰å…³éšé™„çš„è§†è§‰æ’å›¾ï¼Œè¯·å‚é˜…æ­¤[å¹»ç¯ç‰‡ç»„](https://speakerdeck.com/snakes/nsq-nyc-golang-meetup)ã€‚

> ä¸ç¿»å¢™ä½ æ˜¯æ‰“ä¸å¼€çš„ã€‚

**NSQ**æ˜¯[simplequeue](https://github.com/bitly/simplehttp/tree/master/simplequeue) ([simplehttp](https://github.com/bitly/simplehttp)çš„ä¸€éƒ¨åˆ†)çš„åç»§è€…ï¼Œå› æ­¤è®¾è®¡ä¸ºï¼ˆæ²¡æœ‰ç‰¹å®šé¡ºåºï¼‰ï¼š

- æ”¯æŒé«˜å¯ç”¨ä¸”æ¶ˆé™¤äº† SPOFs çš„æ‹“æ‰‘
- æ»¡è¶³äº†æ›´å¼ºæœ‰åŠ›çš„ä¿è¯æ¶ˆæ¯ä¼ é€’çš„éœ€è¦
- é™åˆ¶äº†å•ä¸ªè¿›ç¨‹çš„å†…å­˜å ç”¨ï¼ˆé€šè¿‡å°†æŸäº›æ¶ˆæ¯æŒä¹…åŒ–åˆ°ç£ç›˜ï¼‰
- æå¤§åœ°ç®€åŒ–äº†ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„é…ç½®è¦æ±‚
- æä¾›äº†ç®€å•ç›´æ¥çš„å‡çº§è·¯å¾„
- æé«˜äº†æ•ˆç‡

### ç®€åŒ–é…ç½®å’Œç®¡ç†

å•ä¸ª`nsqd`å®ä¾‹è®¾è®¡ä¸ºä¸€æ¬¡å¤„ç†å¤šä¸ªæ•°æ®æµã€‚æ•°æ®æµç§°ä¸º"ä¸»é¢˜"ï¼Œä¸»é¢˜æœ‰ 1 ä¸ªæˆ–å¤šä¸ª"é€šé“"ï¼ˆchannelsï¼‰ã€‚æ¯ä¸ªé€šé“æ¥æ”¶ä¸»é¢˜çš„æ‰€æœ‰æ¶ˆæ¯å‰¯æœ¬ã€‚å®é™…ä¸Šï¼Œä¸€ä¸ªé€šé“å¯¹åº”ç€ä¸€ä¸ªä¸‹æ¸¸æ¶ˆè´¹ä¸»é¢˜çš„æœåŠ¡ã€‚

ä¸»é¢˜å’Œé€šé“å¹¶æœªä¼˜å…ˆé…ç½®ã€‚é€šè¿‡å‘å¸ƒåˆ°å‘½åä¸»é¢˜æˆ–è®¢é˜…æœ‰å…³å‘½åä¸»é¢˜çš„é€šé“ï¼Œä¸»é¢˜åœ¨é¦–æ¬¡ä½¿ç”¨æ—¶åˆ›å»ºã€‚è€Œé€šè¿‡è®¢é˜…å‘½åé€šé“ï¼Œé€šé“åœ¨é¦–æ¬¡ä½¿ç”¨æ—¶åˆ›å»ºã€‚

ä¸»é¢˜å’Œé€šé“æ‰€æœ‰ç¼“å†²åŒºæ•°æ®å½¼æ­¤ç‹¬ç«‹ï¼Œä»¥é˜²æ­¢ç¼“æ…¢çš„æ¶ˆè´¹å¯¼è‡´å…¶ä»–é€šé“çš„ç§¯å‹ï¼ˆè¿™åŒæ ·é€‚ç”¨äºä¸»é¢˜çº§åˆ«ï¼‰ã€‚

ä¸€ä¸ªé€šé“é€šå¸¸å¯ä»¥è¿æ¥å¤šä¸ªå®¢æˆ·ç«¯ã€‚å‡è®¾æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯å¤„äºå‡†å¤‡æ¥æ”¶æ¶ˆæ¯çš„çŠ¶æ€ï¼Œåˆ™æ¯æ¡æ¶ˆæ¯éƒ½å°†ä¼ é€’åˆ°ä¸€ä¸ªéšæœºçš„å®¢æˆ·ç«¯ã€‚ä¾‹å¦‚ï¼š

![nsqd clients](./images/nsqd_clients.gif)

æ€»ä¹‹ï¼Œæ¶ˆæ¯æ¥è‡ªä¸»é¢˜ -> é€šé“ï¼ˆæ¯ä¸ªé€šé“æ¥æ”¶è¯¥ä¸»é¢˜çš„æ‰€æœ‰æ¶ˆæ¯å‰¯æœ¬ï¼‰ï¼Œä½†ä»é€šé“ -> æ¶ˆè´¹è€…ï¼Œæ¶ˆæ¯æ˜¯å‡åŒ€åˆ†å¸ƒçš„ï¼ˆæ¯ä¸ªæ¶ˆè´¹è€…æ¥æ”¶è¯¥é€šé“çš„éƒ¨åˆ†æ¶ˆæ¯ï¼‰ã€‚

**NSQ**è¿˜åŒ…æ‹¬ä¸€ä¸ªè¾…åŠ©åº”ç”¨ç¨‹åº`nsqlookupd` ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªç›®å½•æœåŠ¡ï¼Œæ¶ˆè´¹è€…å¯ä»¥åœ¨å…¶ä¸­æŸ¥æ‰¾åˆ°æä¾›ç»™ä»–ä»¬è®¢é˜…ä¸»é¢˜çš„`nsqd`å®ä¾‹åœ°å€ã€‚åœ¨é…ç½®æ–¹é¢ï¼Œè¿™ä½¿æ¶ˆè´¹è€…ä¸ç”Ÿäº§è€…åˆ†ç¦»ï¼ˆä»–ä»¬åªéœ€è¦çŸ¥é“åœ¨å“ªé‡Œè”ç³»`nsqlookupd`é€šç”¨å®ä¾‹ï¼Œä»ä¸æ˜¯å½¼æ­¤ä¹‹é—´ç›´æ¥è”ç³»ï¼‰ï¼Œé™ä½äº†å¤æ‚æ€§å’Œç»´æŠ¤æˆæœ¬ã€‚

åœ¨åº•å±‚ï¼Œæ¯ä¸ª`nsqd`ä¸`nsqlookupd`ä¹‹é—´éƒ½å…·æœ‰ä¸€ä¸ª TCP é•¿è¿æ¥(long-lived)ï¼Œå¹¶å®šæœŸæ¨é€å…¶çŠ¶æ€ç»™`nsqlookupd`ã€‚æ­¤æ•°æ®ç”¨äº`nsqlookupd`å°†å“ªäº›`nsqd`åœ°å€é€šçŸ¥ç»™æ¶ˆè´¹è€…ã€‚å¯¹äºæ¶ˆè´¹è€…ï¼Œå°†æš´éœ² HTTP ç«¯ç‚¹`/lookup`ä»¥è¿›è¡Œè½®è¯¢ã€‚

è¦å¼•å…¥æ–°çš„ä¸»é¢˜æ¶ˆè´¹è€…ï¼Œåªéœ€å¯åŠ¨ä¸€ä¸ªé…ç½®äº†`nsqlookupd`å®ä¾‹åœ°å€çš„**NSQ**å®¢æˆ·ç«¯ã€‚æ·»åŠ æ–°çš„æ¶ˆè´¹è€…æˆ–æ–°çš„å‘å¸ƒè€…æ— éœ€æ›´æ”¹é…ç½®ï¼Œä»è€Œå¤§å¤§é™ä½äº†å¼€é”€å’Œå¤æ‚æ€§ã€‚

æ³¨æ„ï¼šåœ¨å°†æ¥çš„ç‰ˆæœ¬ä¸­ï¼Œå¯å‘å¼`nsqlookupd` å¯èƒ½åŸºäºæ·±åº¦ã€è¿æ¥çš„å®¢æˆ·ç«¯æ•°é‡æˆ–å…¶ä»–"æ™ºèƒ½"ç­–ç•¥æ¥è¿”å›`nsqd`åœ°å€ã€‚å½“å‰çš„å®ç°å°±æ˜¯å…¨éƒ¨ã€‚å½’æ ¹ç»“åº•ï¼Œç›®æ ‡æ˜¯æ·±åº¦ä¿æŒåœ¨æ¥è¿‘äºé›¶çš„æ°´å¹³ï¼Œç¡®ä¿æ‰€æœ‰ç”Ÿäº§è€…éƒ½èƒ½å¤Ÿè¢«è®¢é˜…ã€‚

éœ€è¦æ³¨æ„çš„é‡è¦ç‚¹æ˜¯ï¼Œ`nsqd`å’Œ `nsqlookupd`å®ˆæŠ¤è¿›ç¨‹è¢«è®¾è®¡ä¸ºç‹¬ç«‹è¿è¡Œï¼ŒåŒç±»è¿›ç¨‹ä¹‹é—´æ²¡æœ‰æ²Ÿé€šä¸åä½œã€‚

æˆ‘ä»¬ä¹Ÿè®¤ä¸ºï¼Œé€šè¿‡ä¸€ç§æ–¹æ³•æ¥æŸ¥çœ‹ã€æ€è€ƒå’Œæ•´ä½“ç®¡ç†é›†ç¾¤éå¸¸é‡è¦ã€‚æˆ‘ä»¬ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹è€Œæ„å»ºäº†`nsqadmin`ã€‚å®ƒæä¾›äº†ä¸€ä¸ª Web UI æ¥æµè§ˆä¸»é¢˜/é€šé“/æ¶ˆè´¹è€…çš„å±‚æ¬¡ç»“æ„ï¼Œå¹¶æ£€æŸ¥æ¯ä¸ªå±‚çš„æ·±åº¦å’Œå…¶ä»–å…³é”®ç»Ÿè®¡ä¿¡æ¯ã€‚æ­¤å¤–ï¼Œå®ƒæ”¯æŒä¸€äº›ç®¡ç†å‘½ä»¤ï¼Œå¦‚åˆ é™¤å’Œæ¸…ç©ºé€šé“ï¼ˆå½“é€šé“ä¸­çš„æ¶ˆæ¯å¯ä»¥å®‰å…¨åœ°æŠ›å‡ºä»¥å°†æ·±åº¦å¸¦å› 0 æ—¶ï¼Œè¿™æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„å·¥å…·ï¼‰ã€‚

![nsqadmin](./images/nsqadmin.png)

### ç®€å•ç›´æ¥çš„å‡çº§è·¯å¾„

è¿™æ˜¯æˆ‘ä»¬çš„æœ€é«˜ä¼˜å…ˆäº‹é¡¹ä¹‹ä¸€ã€‚æˆ‘ä»¬çš„ç”Ÿäº§ç³»ç»Ÿå¤„ç†ç€å¤§é‡çš„æµé‡ï¼Œå…¨éƒ¨éƒ½åŸºäºæˆ‘ä»¬ç°æœ‰çš„æ¶ˆæ¯å·¥å…·ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¸€ç§ç¼“æ…¢ä¸”æœ‰æ¡ç†çš„æ–¹æ³•æ¥å‡çº§åŸºç¡€æ¶æ„çš„ç‰¹å®šéƒ¨åˆ†ï¼Œå¸¦æ¥çš„å½±å“å¾®ä¹å…¶å¾®ã€‚

é¦–å…ˆï¼Œåœ¨æ¶ˆæ¯ç”Ÿäº§è€…æ–¹é¢ï¼Œæˆ‘ä»¬æ„å»ºäº†`nsqd`æ¥åŒ¹é…[simplequeue](https://github.com/bitly/simplehttp/tree/master/simplequeue)ã€‚å…·ä½“åœ°è¯´ï¼Œ`nsqd` æš´éœ²äº† HTTP `/pub`ç«¯ç‚¹ï¼Œå°±åƒ`simplequeue`ä¸€æ ·å‘é€äºŒè¿›åˆ¶æ•°æ®ï¼ˆéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç«¯ç‚¹éœ€è¦ä¸€ä¸ªé¢å¤–çš„æŸ¥è¯¢å‚æ•°æ¥æŒ‡å®š"ä¸»é¢˜"ï¼‰ã€‚æƒ³è¦åˆ‡æ¢æœåŠ¡ï¼Œå‘`nsqd`å‘å¸ƒæ¶ˆæ¯ï¼Œåªéœ€è¿›è¡Œå°‘é‡çš„ä»£ç æ›´æ”¹ã€‚

å…¶æ¬¡ï¼Œæˆ‘ä»¬æ„å»ºäº†ä¸ç°æœ‰åº“åŠŸèƒ½å’Œä¹ æƒ¯ç›¸åŒ¹é…çš„Python å’Œ Go åº“ã€‚é€šè¿‡å°†ä»£ç æ›´æ”¹é™åˆ¶ä¸ºè‡ªä¸¾ï¼ˆbootstrapï¼‰ï¼Œä»è€Œç¼“è§£äº†åœ¨æ¶ˆè´¹è€…ç«¯çš„è¿‡æ¸¡ã€‚æ‰€æœ‰ä¸šåŠ¡é€»è¾‘ä¿æŒä¸å˜ã€‚

æœ€åï¼Œæˆ‘ä»¬æ„å»ºäº†å°†æ–°æ—§ç»„ä»¶ç²˜åˆåœ¨ä¸€èµ·çš„å®ç”¨ç¨‹åºã€‚è¿™äº›éƒ½å¯åœ¨å­˜å‚¨åº“ä¸­çš„`examples`ç›®å½•ä¸­è·å¾—ï¼š

- `nsq_to_file`- å°†ç»™å®šä¸»é¢˜çš„æ‰€æœ‰æ¶ˆæ¯æŒä¹…åŒ–å†™å…¥æ–‡ä»¶
- `nsq_to_http`- å¯¹ä¸»é¢˜ä¸­çš„æ‰€æœ‰æ¶ˆæ¯å‘(å¤šä¸ª)ç«¯ç‚¹æ‰§è¡Œ HTTP è¯·æ±‚

### æ¶ˆé™¤ SPOFs

**NSQ**ä¸“ä¸ºåˆ†å¸ƒå¼ä½¿ç”¨è€Œè®¾è®¡ã€‚`nsqd` å®¢æˆ·ç«¯ï¼ˆé€šè¿‡ TCPï¼‰è¿æ¥åˆ°æ‰€æœ‰å®ä¾‹ï¼Œå¹¶æä¾›ç‰¹å®šçš„ä¸»é¢˜æ¶ˆæ¯ã€‚æ²¡æœ‰ä¸­é—´äººï¼Œæ²¡æœ‰æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œä¹Ÿæ²¡æœ‰SPOFsï¼š

![nsq clients](./images/nsq_clients.png)

æ­¤æ‹“æ‰‘æ¶ˆé™¤äº†å¯¹å•ä¸ªçš„ã€èšåˆçš„æºè¿›è¡Œé“¾æ¥çš„å¿…è¦ã€‚ç›¸åï¼Œç›´æ¥ä»**æ‰€æœ‰ç”Ÿäº§è€…**å¤„è¿›è¡Œæ¶ˆè´¹ã€‚ä»æŠ€æœ¯ä¸Šè®²ï¼Œå“ªä¸ªå®¢æˆ·ç«¯è¿æ¥åˆ°å“ªä¸ª**NSQ**å¹¶ä¸é‡è¦ï¼Œåªè¦æœ‰è¶³å¤Ÿçš„å®¢æˆ·ç«¯è¿æ¥åˆ°æ‰€æœ‰çš„ç”Ÿäº§è€…æ¥æ»¡è¶³æ¶ˆæ¯é‡ï¼Œå°±èƒ½ä¿è¯æ¶ˆæ¯æœ€ç»ˆå¾—åˆ°å¤„ç†ã€‚

å¯¹äº `nsqdlookupd`ï¼Œé€šè¿‡è¿è¡Œå¤šä¸ªå®ä¾‹å®ç°äº†é«˜å¯ç”¨ã€‚å®ƒä»¬ä¹‹é—´ä¸ç›´æ¥ç›¸äº’é€šä¿¡ï¼Œå¹¶ä¸”æ•°æ®æœ€ç»ˆè¢«è®¤ä¸ºæ˜¯ä¸€è‡´çš„ã€‚æ¶ˆè´¹è€…ä¼šè½®è¯¢å…¶é…ç½®çš„æ‰€æœ‰`nsqlookupd`å®ä¾‹å¹¶è”åˆ(union)å“åº”ç»“æœã€‚é™ˆæ—§è¿‡æ—¶ã€æ— æ³•è®¿é—®æˆ–å…¶ä»–èŠ‚ç‚¹æ•…éšœéƒ½ä¸ä¼šä½¿ç³»ç»Ÿåœæ­¢è¿è¡Œã€‚

### æ¶ˆæ¯ä¼ é€’ä¿è¯

**NSQ**ä¿è¯æ¶ˆæ¯å°†è‡³å°‘**ä¼ é€’ä¸€æ¬¡ï¼Œ**å°½ç®¡æ¶ˆæ¯å¯èƒ½é‡å¤ã€‚æ¶ˆè´¹è€…åº”è¯¥å¯¹æ­¤æœ‰æ‰€æ„æ–™ï¼Œå¹¶è¿›è¡Œé‡å¤æ¶ˆæ¯åˆ é™¤æˆ–æ‰§è¡Œå¹‚ç­‰æ“ä½œã€‚

æ­¤ä¿è¯å¼ºåˆ¶ä½œä¸ºåè®®çš„ä¸€éƒ¨åˆ†ï¼Œå…¶å·¥ä½œæ–¹å¼å¦‚ä¸‹ï¼ˆå‡è®¾å®¢æˆ·ç«¯å·²æˆåŠŸè¿æ¥å¹¶è®¢é˜…äº†ä¸»é¢˜ï¼‰ï¼š

1. å®¢æˆ·ç«¯è¡¨ç¤ºä»–ä»¬å·²å‡†å¤‡å¥½æ¥æ”¶æ¶ˆæ¯
2. **NSQ**å‘é€æ¶ˆæ¯å¹¶ä¸´æ—¶å°†æ•°æ®å­˜å‚¨åœ¨æœ¬åœ°ï¼ˆåœ¨é‡æ–°å…¥é˜Ÿæˆ–è¶…æ—¶æ—¶ï¼‰
3. å®¢æˆ·ç«¯ç­”å¤ FINï¼ˆå®Œæˆfinishï¼‰æˆ– REQï¼ˆé‡æ–°å…¥é˜Ÿre-queueï¼‰ï¼Œåˆ†åˆ«è¡¨ç¤ºæˆåŠŸæˆ–å¤±è´¥ã€‚å¦‚æœ**NSQ**è¶…æ—¶(å¯é…ç½®)æœªæ”¶åˆ°å®¢æˆ·ç«¯çš„ç­”å¤ï¼Œæ¶ˆæ¯ä¹Ÿä¼šè‡ªåŠ¨é‡æ–°å…¥é˜Ÿï¼‰

è¿™å¯ç¡®ä¿å¯¼è‡´æ¶ˆæ¯ä¸¢å¤±çš„å”¯ä¸€è¾¹ç¼˜æƒ…å†µæ˜¯`nsqd`è¿›ç¨‹æœªæ­£å¸¸å…³é—­(unclean shutdown)ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå†…å­˜ä¸­çš„ä»»ä½•æ¶ˆæ¯ï¼ˆæˆ–ä»»ä½•æœªåˆ·æ–°åˆ°ç£ç›˜çš„ç¼“å†²æ¶ˆæ¯ï¼‰éƒ½ä¼šä¸¢å¤±ã€‚

å¦‚æœé˜²æ­¢æ¶ˆæ¯ä¸¢å¤±è‡³å…³é‡è¦ï¼Œåˆ™å³ä½¿æ­¤è¾¹ç¼˜æƒ…å†µä¹Ÿå¯ä»¥ç¼“å’Œã€‚ä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯æ”¯æŒæ¥æ”¶ç›¸åŒæ¶ˆæ¯å‰¯æœ¬çš„å†—ä½™`nsqd`å¯¹ï¼ˆåœ¨å•ç‹¬çš„ä¸»æœºä¸Šï¼‰ã€‚ç”±äºå·²å°†æ¶ˆè´¹è€…å†™ä¸ºå¹‚ç­‰çš„ï¼Œå› æ­¤åœ¨è¿™äº›æ¶ˆæ¯ä¸Šé‡å¤æ‰§è¡Œä¸¤æ¬¡æ“ä½œä¸ä¼šå¯¹ä¸‹æ¸¸äº§ç”Ÿå½±å“ï¼Œç³»ç»Ÿå¯ä»¥æ‰¿å—ä»»ä½•å•ç‚¹æ•…éšœè€Œä¸ä¸¢å¤±æ¶ˆæ¯ã€‚

é‡è¦çš„æ˜¯**NSQ**æä¾›äº†æ„å»ºåŸºç¡€ï¼ˆbuilding blocksï¼‰ï¼Œä»¥æ”¯æŒå„ç§ç”Ÿäº§ç”¨ä¾‹å’ŒæŒä¹…åŒ–æ·±åº¦çš„é…ç½®ã€‚

### å¯é™å®šå†…å­˜å ç”¨

`nsqd`æä¾›äº†ä¸€ä¸ªé…ç½®é€‰é¡¹`--mem-queue-size`ï¼Œç”¨ä»¥ç¡®å®šç»™å®šçš„é˜Ÿåˆ—åœ¨å†…å­˜ä¸­ä¿ç•™æ¶ˆæ¯çš„æ•°é‡ã€‚å¦‚æœé˜Ÿåˆ—çš„æ·±åº¦è¶…è¿‡æ­¤é˜ˆå€¼ï¼Œåˆ™æ¶ˆæ¯å°†é€æ˜åœ°å†™å…¥ç£ç›˜ã€‚è¿™ä½¿å¾—`nsqd`è¿›ç¨‹çš„å†…å­˜å ç”¨é‡é™åˆ¶ä¸ºï¼š`mem-queue-size * #_of_channels_and_topics`

![message overflow](./images/message_overflow.png)

æ­¤å¤–ï¼Œç²¾æ˜çš„äººå¯èƒ½å·²ç»å‘ç°äº†ä¸€ä¸ªä¾¿æ·çš„æ–¹å¼ï¼Œå³é€šè¿‡è®¾ç½®æ­¤å€¼ä¸ºè¾ƒä½çš„æ•°ï¼ˆæ¯”å¦‚ 1ç”šè‡³ 0ï¼‰ï¼Œä»¥è·å¾—æ›´é«˜çš„ä¼ é€’ä¿è¯ã€‚ç£ç›˜é˜Ÿåˆ—æ—¨åœ¨æ‰¿å—éæ­£å¸¸å¯åŠ¨ï¼ˆå°½ç®¡æ¶ˆæ¯å¯èƒ½ä¼ é€’ä¸¤æ¬¡ï¼‰ã€‚

æ­¤å¤–ï¼Œä¸æ¶ˆæ¯ä¼ é€’ä¿è¯æœ‰å…³çš„æ˜¯ï¼Œæ­£å¸¸å…³é—­(clean shutdowns)ï¼ˆé€šè¿‡å‘`nsqd`è¿›ç¨‹å‘é€TERM ä¿¡å·ï¼‰å¯ä»¥å®‰å…¨åœ°æŒä¹…åŒ–å½“å‰å†…å­˜ä¸­çš„ã€æ­£åœ¨ä¼ é€’çš„ã€å»¶è¿Ÿçš„å’Œå„ç§å†…éƒ¨ç¼“å†²çš„æ¶ˆæ¯ã€‚

è¯·æ³¨æ„ï¼Œä¸»é¢˜æˆ–é€šé“çš„åç§°ä»¥`#ephemeral`ç»“å°¾çš„ï¼Œå°†ä¸ä¼šç¼“å†²åˆ°ç£ç›˜ï¼Œç›¸ååœ¨è¶…è¿‡`mem-queue-size`åä¼šè¢«åˆ é™¤æ¶ˆæ¯ã€‚è¿™ä½¿çš„ä¸éœ€è¦æ¶ˆæ¯ä¿è¯çš„æ¶ˆè´¹è€…ä¹Ÿèƒ½å¤Ÿè®¢é˜…é¢‘é“ã€‚è¿™äº›ä¸´æ—¶çš„(ephemeral)é€šé“åœ¨æœ€åä¸€ä¸ªå®¢æˆ·ç«¯æ–­å¼€è¿æ¥æ—¶ä¹Ÿä¼šæ¶ˆå¤±ã€‚å¯¹äºä¸´æ—¶ä¸»é¢˜ï¼Œè¿™æ„å‘³ç€è‡³å°‘æœ‰ä¸€ä¸ªé€šé“å·²åˆ›å»ºã€ä½¿ç”¨å’Œåˆ é™¤ï¼ˆé€šå¸¸æ˜¯ä¸´æ—¶é€šé“ï¼‰ã€‚

### æ•ˆç‡

**NSQ**è®¾è®¡ä¸ºä½¿ç”¨"åƒ memcached ä¸€æ ·"çš„å‘½ä»¤åè®®æ¥è¿›è¡Œé€šä¿¡ï¼Œå…·æœ‰ç®€å•çš„ä»¥å¤§å°ä¸ºå‰ç¼€çš„å“åº”ç»“æœã€‚æ‰€æœ‰çš„æ¶ˆæ¯æ•°æ®éƒ½ä¿å­˜åœ¨æ ¸å¿ƒä¸­ï¼ŒåŒ…æ‹¬å°è¯•æ¬¡æ•°ã€æ—¶é—´æˆ³ç­‰å…ƒæ•°æ®ã€‚è¿™æ¶ˆé™¤äº†æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯ä¹‹é—´æ¥æ¥å›å›çš„æ•°æ®å¤åˆ¶ï¼Œè¿™æ˜¯é‡æ–°å…¥é˜Ÿæ¶ˆæ¯æ—¶ä¸Šä¸€ä¸ªå·¥å…·é“¾çš„å›ºæœ‰å±æ€§ã€‚è¿™ä¹Ÿç®€åŒ–äº†å®¢æˆ·ç«¯ï¼Œå› ä¸ºå®ƒä»¬ä¸å†éœ€è¦è´Ÿè´£ç»´æŠ¤æ¶ˆæ¯çŠ¶æ€ã€‚

æ­¤å¤–ï¼Œé€šè¿‡é™ä½é…ç½®å¤æ‚æ€§ï¼Œè®¾ç½®å’Œå¼€å‘çš„æ—¶é—´å¤§å¤§ç¼©çŸ­ï¼ˆå°¤å…¶æ˜¯åœ¨ä¸»é¢˜æ¶ˆè´¹è€… >1 çš„æƒ…å†µä¸‹ï¼‰ã€‚

å¯¹äºæ•°æ®åè®®ï¼Œæˆ‘ä»¬åšäº†ä¸€ä¸ªå…³é”®çš„è®¾è®¡å†³ç­–ï¼Œé‚£å°±æ˜¯é€šè¿‡å°†æ•°æ®æ¨é€åˆ°å®¢æˆ·ç«¯è€Œä¸æ˜¯ç­‰å¾…å®¢æˆ·ç«¯æ¥æå–ï¼Œä»¥æ­¤æœ€å¤§åŒ–æ€§èƒ½å’Œååé‡ã€‚è¿™ä¸ªæ¦‚å¿µï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º`RDY`çŠ¶æ€ï¼Œæœ¬è´¨ä¸Šæ˜¯å®¢æˆ·ç«¯æµæ§çš„ä¸€ç§å½¢å¼ã€‚

å½“å®¢æˆ·ç«¯è¿æ¥åˆ°å¹¶è®¢é˜…é€šé“æ—¶ï¼Œå®ƒè¢«æ”¾ç½®åœ¨`RDY` 0 çš„çŠ¶æ€ã€‚è¿™æ„å‘³ç€ä¸ä¼šå‘å®¢æˆ·ç«¯å‘é€ä»»ä½•æ¶ˆæ¯ã€‚å½“å®¢æˆ·ç«¯å‡†å¤‡å¥½æ¥æ”¶æ¶ˆæ¯æ—¶ï¼Œå®ƒä¼šå‘é€ä¸€ä¸ªå‘½ä»¤ï¼Œå°†çŠ¶æ€æ›´æ–°åˆ°æŸä¸ªå®ƒå‡†å¤‡å¤„ç†(å¤šå°‘æ¡æ¶ˆæ¯)çš„#çŠ¶æ€ï¼Œä¾‹å¦‚#100ã€‚åœ¨æ²¡æœ‰ä»»ä½•é¢å¤–å‘½ä»¤çš„æƒ…å†µä¸‹ï¼Œ100 æ¡æ¶ˆæ¯å°†æ¨é€åˆ°å®¢æˆ·ç«¯ï¼ˆæœåŠ¡ç«¯å°†ä¼šä¸ºè¯¥å®¢æˆ·ç«¯è¿›è¡ŒRDY è®¡æ•°ï¼‰ã€‚

å®¢æˆ·ç«¯åº“çš„è®¾è®¡æ˜¯åœ¨è®¡æ•°è¾¾åˆ°é…ç½®çš„`max-in-flight`ï¼ˆé€‚å½“è€ƒè™‘ä¸å¤šä¸ª`nsqd`å®ä¾‹çš„è¿æ¥ï¼Œé€‚å½“æ‹†åˆ†ï¼‰çš„çº¦25% æ—¶ï¼Œå‘é€å‘½ä»¤æ¥æ›´æ–°RDYè®¡æ•°ã€‚

![nsq protocol](./images/nsq_protocol.png)

è¿™æ˜¯ä¸€ä¸ªæ˜¾è‘—çš„æ€§èƒ½æ—‹é’®ï¼Œå› ä¸ºä¸€äº›ä¸‹æ¸¸ç³»ç»Ÿèƒ½å¤Ÿæ›´å®¹æ˜“åœ°æ‰¹é‡å¤„ç†æ¶ˆæ¯ï¼Œå¹¶å—ç›Šäºæ›´é«˜çš„`max-in-flight`ã€‚

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå› ä¸ºå®ƒæ—¢æœ‰ç¼“å†²åˆæœ‰æ¨é€åŠŸèƒ½ï¼Œå¹¶ä¸”èƒ½å¤Ÿæ»¡è¶³å¯¹æµï¼ˆé€šé“ï¼‰çš„ç‹¬ç«‹å‰¯æœ¬éœ€æ±‚ï¼Œå› æ­¤æˆ‘ä»¬ç”Ÿæˆäº†ä¸€ä¸ªç±»ä¼¼äº`simplequeue`å’Œ`pubsub` ç»„åˆçš„å®ˆæŠ¤ç¨‹åºï¼Œæˆ‘ä»¬ä¼ ç»Ÿä¸Šä¼šç»´æŠ¤ä¸Šé¢è®¨è®ºè¿‡çš„è¾ƒæ—§çš„å·¥å…·é“¾ï¼Œè¿™åœ¨ç®€åŒ–æˆ‘ä»¬ç³»ç»Ÿçš„æ‹“æ‰‘æ–¹é¢éå¸¸å¼ºå¤§ã€‚

### Go

æˆ‘ä»¬å¾ˆæ—©å°±åšå‡ºäº†ä¸€ä¸ªæˆ˜ç•¥å†³ç­–ï¼Œåœ¨Go ä¸­æ„å»ºNSQ [æ ¸å¿ƒ](https://golang.org/)ã€‚æˆ‘ä»¬æœ€è¿‘å†™äº†å…³äºæˆ‘ä»¬ä½¿ç”¨Goçš„[åšå®¢](https://word.bitly.com/post/29550171827/go-go-gadget)å¹¶æåˆ°è¿™ä¸ªé¡¹ç›® - æµè§ˆè¯¥å¸–ï¼Œäº†è§£æˆ‘ä»¬å¯¹è¯­è¨€çš„æ€è€ƒå¯èƒ½ä¼šæœ‰æ‰€å¸®åŠ©ã€‚

å…³äº**NSQ**ï¼ŒGo é€šé“ï¼ˆä¸è¦ä¸**NSQ**é€šé“æ··æ·†ï¼‰å’Œè¯­è¨€å†…ç½®çš„å¹¶å‘åŠŸèƒ½éå¸¸é€‚åˆ`nsqd`çš„å†…éƒ¨å·¥ä½œã€‚æˆ‘ä»¬åˆ©ç”¨ç¼“å†²é€šé“æ¥ç®¡ç†å†…å­˜ä¸­çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¹¶æ— ç¼åœ°å°†æº¢å‡ºçš„æ¶ˆæ¯å†™å…¥ç£ç›˜ã€‚

é€šè¿‡æ ‡å‡†åº“ï¼Œå¯ä»¥è½»æ¾åœ°ç¼–å†™ç½‘ç»œå±‚å’Œå®¢æˆ·ç«¯ä»£ç ã€‚å†…ç½®å†…å­˜å’Œ cpu åˆ†æé’©å­çªæ˜¾äº†ä¼˜åŒ–æœºä¼šï¼Œå¹¶ä¸”é›†æˆéœ€è¦å¾ˆå°‘çš„ç²¾åŠ›ã€‚æˆ‘ä»¬è¿˜å‘ç°ï¼Œåœ¨éš”ç¦»ä¸­æµ‹è¯•ç»„ä»¶ã€ä½¿ç”¨æ¥å£æ¨¡æ‹Ÿç±»å‹ä»¥åŠè¿­ä»£æ„å»ºåŠŸèƒ½éå¸¸å®¹æ˜“ã€‚

## å†…éƒ¨

NSQ ç”± 3 ä¸ªå®ˆæŠ¤è¿›ç¨‹ç»„æˆï¼š

- **[nsqd](https://nsq.io/components/nsqd.html)**æ˜¯æ¶ˆæ¯æ¥æ”¶ã€æ’é˜Ÿå’Œä¼ é€’æ¶ˆæ¯ç»™å®¢æˆ·ç«¯çš„å®ˆæŠ¤è¿›ç¨‹ã€‚
- **[nsqlookupd](https://nsq.io/components/nsqlookupd.html)**æ˜¯ç®¡ç†æ‹“æ‰‘ä¿¡æ¯å¹¶æä¾›æœ€ç»ˆä¸€è‡´çš„å‘ç°æœåŠ¡çš„å®ˆæŠ¤è¿›ç¨‹ã€‚
- **[nsqadmin](https://nsq.io/components/nsqadmin.html)**æ˜¯ä¸€ä¸ª Web UIï¼Œå¯ä»¥å®æ—¶çœå¯Ÿé›†ç¾¤ï¼ˆå¹¶æ‰§è¡Œå„ç§ç®¡ç†ä»»åŠ¡ï¼‰ã€‚

NSQ ä¸­çš„æ•°æ®æµè¢«æ¨¡å‹åŒ–ä¸ºæµå’Œæ¶ˆè´¹è€…çš„æ ‘ç»“æ„ã€‚ä¸€ä¸ª**ä¸»é¢˜**ä»£è¡¨ä¸€ç§æ•°æ®æµã€‚**é€šé“**æ˜¯è®¢é˜…ç‰¹å®šä¸»é¢˜çš„æ¶ˆè´¹è€…çš„é€»è¾‘åˆ†ç»„ã€‚

![topics/channels](./images/topics_channels.gif)

å•ä¸ª**nsqd**å¯ä»¥åŒ…å«å¤šä¸ªä¸»é¢˜ï¼Œæ¯ä¸ªä¸»é¢˜å¯ä»¥å…·æœ‰å¤šä¸ªé€šé“ã€‚é€šé“æ¥æ”¶ä¸»é¢˜çš„æ‰€æœ‰æ¶ˆæ¯å‰¯æœ¬ï¼Œå¯ç”¨å¤šæ’­æ ·å¼(multicast style)ä¼ é€’ï¼Œè€Œé€šé“ä¸Šçš„æ¯æ¡æ¶ˆæ¯éƒ½åœ¨å…¶è®¢é˜…è€…ä¹‹é—´åˆ†å‘ï¼Œä»è€Œå®ç°è´Ÿè½½å‡è¡¡ã€‚

è¿™äº›åŸºå…ƒæ„æˆäº†ä¸€ä¸ªå¼ºå¤§çš„æ¡†æ¶ï¼Œç”¨äºè¡¨è¾¾[å„ç§ç®€å•è€Œå¤æ‚çš„æ‹“æ‰‘](https://nsq.io/deployment/topology_patterns.html)ã€‚

æœ‰å…³ NSQ è®¾è®¡çš„ä¿¡æ¯ï¼Œè¯·å‚é˜…[è®¾è®¡æ–‡æ¡£](https://nsq.io/overview/design.html)ã€‚

### ä¸»é¢˜å’Œé€šé“

ä¸»é¢˜å’Œé€šé“æ˜¯ NSQ çš„æ ¸å¿ƒåŸºå…ƒ(primitives)ï¼Œå®ƒå¾ˆå¥½åœ°ä½“ç°äº†ç³»ç»Ÿè®¾è®¡å¦‚ä½•æ— ç¼åœ°è½¬æ¢ä¸º Go çš„åŠŸèƒ½ã€‚

Go çš„é€šé“ï¼ˆå› æ­¤ç§°ä¸º"go-chan"ï¼Œç”¨äºæ¶ˆé™¤æ­§ä¹‰ï¼‰æ˜¯è¡¨è¾¾é˜Ÿåˆ—çš„è‡ªç„¶æ–¹å¼ï¼Œå› æ­¤ï¼ŒNSQ ä¸»é¢˜/é€šé“çš„æ ¸å¿ƒåªæ˜¯æ¶ˆæ¯ç»“æ„ä½“`Message`æŒ‡é’ˆçš„ç¼“å†²"go-chan"ã€‚ç¼“å†²çš„å¤§å°ç­‰äºé…ç½®å‚æ•°`--mem-queue-size`

åœ¨ä»ç½‘ç»œä¸­è¯»å–æ•°æ®åï¼Œå°†æ¶ˆæ¯å‘å¸ƒåˆ°ä¸»é¢˜æ¶‰åŠå¦‚ä¸‹è¡Œä¸ºï¼š

1. `Message`ç»“æ„ä½“çš„å®ä¾‹åŒ–ï¼ˆä»¥åŠæ¶ˆæ¯ä½“`[]byte`çš„åˆ†é…ï¼‰
2. è¯»é”(read-lock)è·å¾—`Topic`
3. è¯»é”(read-lock)æ£€æŸ¥å‘å¸ƒèƒ½åŠ›
4. å‘é€ç»™ä¸€ä¸ªç¼“å†²"go-chan"

è‹¥è¦å°†æ¶ˆæ¯ä»ä¸»é¢˜å‘é€åˆ°å…¶é€šé“ï¼Œè¯¥ä¸»é¢˜ä¸èƒ½ä¾èµ–äºå…¸å‹çš„ go-chan æ¥æ”¶è¯­ä¹‰ï¼Œå› ä¸ºåœ¨ go-chan ä¸Šæ¥æ”¶çš„å¤šä¸ª goroutineå°†åˆ†å‘æ¶ˆæ¯ï¼Œè€Œæ‰€éœ€çš„æœ€ç»ˆç»“æœæ˜¯å°†æ¯æ¡æ¶ˆæ¯å¤åˆ¶åˆ°æ¯ä¸ªé€šé“ï¼ˆgoroutineï¼‰ã€‚

ç›¸åï¼Œæ¯ä¸ªä¸»é¢˜ç»´æŠ¤äº† 3 ä¸ªä¸»è¦ çš„goroutineï¼š

ç¬¬ä¸€ä¸ªç§°ä¸º`router` ï¼Œè´Ÿè´£ä»ä¼ å…¥ go-chan çš„æ¶ˆæ¯ä¸­è¯»å–æœ€æ–°å‘å¸ƒçš„æ¶ˆæ¯ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨é˜Ÿåˆ—ï¼ˆå†…å­˜æˆ–ç£ç›˜ï¼‰ä¸­ã€‚

ç¬¬äºŒä¸ªç§°ä¸º`messagePump` ï¼Œè´Ÿè´£å¤åˆ¶å¹¶æ¨é€æ¶ˆæ¯åˆ°ä¸Šè¿°é€šé“ã€‚

ç¬¬ä¸‰ä¸ªè´Ÿè´£ ç£ç›˜é˜Ÿåˆ—(`DiskQueue`)IOï¼Œç¨åå°†è®¨è®º.

é€šé“è¦å¤æ‚ä¸€äº›ï¼Œä½†å…±æœ‰ä¸€ä¸ªåº•å±‚ç›®æ ‡ï¼šæš´éœ²ä¸€ä¸ªå•è¾“å…¥å’Œå•è¾“å‡ºçš„go-chan (ä»¥æŠ½è±¡å‡ºåœ¨å†…éƒ¨æ¶ˆæ¯å¯èƒ½å­˜åœ¨äºå†…å­˜æˆ–ç£ç›˜ä¸­çš„äº‹å®)ï¼š

![queue goroutine](./images/queue_goroutine.png)

æ­¤å¤–ï¼Œæ¯ä¸ªé€šé“ç»´æŠ¤ 2 ä¸ªæŒ‰æ—¶é—´æ’åºçš„ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œè´Ÿè´£å»¶è¿Ÿå’Œåœ¨é€”(in-flight)æ¶ˆæ¯çš„è¶…æ—¶ï¼ˆ é™„å¸¦2ä¸ªç›‘è§†å®ƒä»¬çš„goroutineï¼‰ã€‚

é€šè¿‡ç®¡ç†æ¯ä¸ªé€šé“çš„æ•°æ®ç»“æ„ï¼ˆè€Œä¸æ˜¯ä¾èµ–äº Go è¿è¡Œæ—¶çš„å…¨å±€è®¡æ—¶å™¨è°ƒåº¦ï¼‰å¹¶è¡ŒåŒ–å¾—ä»¥æ”¹è¿›ã€‚

**æ³¨ï¼š**åœ¨å†…éƒ¨ï¼ŒGo è¿è¡Œæ—¶ä½¿ç”¨å•ä¼˜å…ˆçº§é˜Ÿåˆ—å’Œ goroutineæ¥ç®¡ç†è®¡æ—¶å™¨ã€‚è¿™æ”¯æŒï¼ˆä½†ä¸é™äºï¼‰æ•´ä¸ª`time`åŒ…ã€‚å®ƒé€šå¸¸ä¸éœ€è¦æ—¶é—´æ’åºçš„ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œä½†é‡è¦çš„æ˜¯è¦è®°ä½ï¼Œå®ƒæ˜¯ä¸€ä¸ªå•ä¸€çš„æ•°æ®ç»“æ„ï¼Œåªæœ‰ä¸€ä¸ªé”ï¼Œå¯èƒ½ä¼šå½±å“`GOMAXPROCS > 1`æ—¶çš„æ€§èƒ½ã€‚è¯·å‚é˜…[runtime/time.go](https://github.com/golang/go/blob/release-branch.go1.9/src/runtime/time.go#L92)ã€‚ï¼ˆåœ¨ go-1.10+ä¸­ä¸å†æ˜¯äº†ï¼‰

### åå°/ç£ç›˜é˜Ÿåˆ—

NSQ çš„è®¾è®¡ç›®æ ‡ä¹‹ä¸€æ˜¯é™åˆ¶å†…å­˜ä¸­ä¿ç•™çš„æ¶ˆæ¯æ•°ã€‚å®ƒé€šè¿‡`DiskQueue`(ä¸»é¢˜æˆ–é€šé“çš„ç¬¬ä¸‰ä¸ªä¸»è¦goroutine)é€æ˜åœ°å°†æ¶ˆæ¯æº¢å‡ºå†™å…¥ç£ç›˜ã€‚

ç”±äºå†…å­˜é˜Ÿåˆ—ä»…ä»…æ˜¯ä¸€ä¸ªgo-chanï¼Œå¦‚æœå¯èƒ½çš„è¯ï¼Œå®ƒé¦–å…ˆä¼šå°è¯•å°†æ¶ˆæ¯è·¯ç”±è‡³å†…å­˜ï¼Œç„¶åå›è°ƒè‡³ç£ç›˜ï¼š

```go
for msg := range c.incomingMsgChan {
	select {
	case c.memoryMsgChan <- msg:
	default:
		err := WriteMessageToBackend(&msgBuf, msg, c.backend)
		if err != nil {
			// ... handle errors ...
		}
	}
}
```

åˆ©ç”¨ Go çš„`select`è¯­å¥ï¼Œåªéœ€å‡ è¡Œä»£ç å°±å¯ä»¥è¡¨ç¤ºæ­¤åŠŸèƒ½ï¼šä¸Šè¿°`default`è¯­å¥åªæœ‰åœ¨`memoryMsgChan`æ»¡äº†ä¹‹åæ‰ä¼šæ‰§è¡Œã€‚

NSQ ä¹Ÿæœ‰ä¸´æ—¶**ä¸»é¢˜/é€šé“**çš„æ¦‚å¿µã€‚å®ƒä»¬ä¸¢å¼ƒäº†(discard)æ¶ˆæ¯æº¢å‡ºï¼ˆè€Œä¸æ˜¯å†™å…¥ç£ç›˜ï¼‰ï¼Œå¹¶åœ¨ä¸å†æœ‰è®¢é˜…çš„å®¢æˆ·ç«¯æ—¶æ¶ˆå¤±ã€‚è¿™æ˜¯ Go æ¥å£çš„å®Œç¾ç”¨ä¾‹ã€‚ä¸»é¢˜å’Œé€šé“å…·æœ‰ä¸€ä¸ªå£°æ˜ä¸ºæ¥å£è€Œä¸æ˜¯å…·ä½“ç±»å‹çš„ç»“æ„ä½“æˆå‘˜`Backend`ã€‚æ™®é€šä¸»é¢˜å’Œé€šé“ä½¿ç”¨çš„æ˜¯`DiskQueue`, è€Œä¸´æ—¶ä¸»é¢˜å’Œé€šé“æš‚å­˜åœ¨ `DummyBackendQueue`ä¸­ï¼Œå®ç°äº†æ— æ“ä½œåç«¯(Backend)ã€‚

### å‡å°‘GCå‹åŠ›

åœ¨ä»»ä½•åƒåœ¾å›æ”¶ç¯å¢ƒä¸­ï¼Œéƒ½ä¼šå—é™äºååé‡ï¼ˆæ‰§è¡Œæœ‰ç”¨çš„å·¥ä½œï¼‰ã€å»¶è¿Ÿï¼ˆå“åº”èƒ½åŠ›ï¼‰å’Œé©»ç•™é›†å¤§å°ï¼ˆresident set size, å ç”¨ç©ºé—´ï¼‰ã€‚

è‡ª Go 1.2 èµ·ï¼Œthe GC is mark-and-sweep (parallel), non-generational, non-compacting, stop-the-world and mostly preciseï¼ˆç¿»è¯‘ä¸æ¥ï¼Œè‡ªè¡Œä½“ä¼šğŸ¤ªï¼‰ã€‚å®ƒå¤§å¤šæ˜¯ç²¾ç¡®çš„ï¼Œå› ä¸ºå‰©ä½™çš„å·¥ä½œæ²¡æœ‰åŠæ—¶å®Œæˆï¼ˆé¢„å®šè¦åˆ°Go1.3ï¼‰ã€‚

Go çš„GCè‚¯å®šä¼šç»§ç»­æ”¹è¿›ï¼Œä½†æ™®éçš„äº‹å®æ˜¯ï¼šåˆ›é€ çš„åƒåœ¾è¶Šå°‘ï¼Œæ”¶é›†åƒåœ¾çš„æ—¶é—´å°±è¶Šå°‘ã€‚

é¦–å…ˆï¼Œäº†è§£GCåœ¨å®é™…å·¥ä½œè´Ÿè½½ä¸‹çš„è¡¨ç°éå¸¸é‡è¦ã€‚ä¸ºæ­¤ï¼Œ**nsqd**ä»¥[statsd](https://github.com/etsy/statsd/)æ ¼å¼ï¼ˆä¸å…¶ä»–å†…éƒ¨æŒ‡æ ‡ä¸€èµ·ï¼‰å‘å¸ƒäº† GC ç»Ÿè®¡ä¿¡æ¯ã€‚**nsqadmin**å±•ç¤ºäº†è¿™äº›æŒ‡æ ‡çš„å›¾è¡¨ï¼Œè®©æ‚¨æ·±å…¥äº†è§£ GC åœ¨é¢‘ç‡å’ŒæŒç»­æ—¶é—´æ–¹é¢çš„å½±å“ï¼š

![single node view](./images/single_node_view.png)

ä¸ºäº†çœŸæ­£å‡å°‘åƒåœ¾ï¼Œæ‚¨éœ€è¦çŸ¥é“åƒåœ¾çš„ç”Ÿæˆåœ°ç‚¹ã€‚Go å·¥å…·é“¾æä¾›äº†ç­”æ¡ˆï¼š

1. ä½¿ç”¨[`test`](https://golang.org/pkg/testing/)åŒ…å’Œ`go test -benchmem`æ¥åŸºå‡†æµ‹è¯•çƒ­ä»£ç è·¯å¾„ï¼ˆto benchmark hot code pathsï¼‰ã€‚å®ƒæè¿°äº†æ¯æ¬¡è¿­ä»£çš„åˆ†é…æ•°ï¼ˆåŸºå‡†æµ‹è¯•å¯ä»¥ä¸[`benchcmp`](https://godoc.org/golang.org/x/tools/cmd/benchcmp) è¿›è¡Œæ¯”è¾ƒè¿è¡Œã€‚
2. ä½¿ç”¨`go build -gcflags -m`ç¼–è¯‘ ï¼Œè¾“å‡º[escape analysis](https://en.wikipedia.org/wiki/Escape_analysis)çš„ç»“æœã€‚

æœ‰é‰´äºæ­¤ï¼Œä»¥ä¸‹ä¼˜åŒ–è¯æ˜å¯¹**nsqd å¾ˆæœ‰ç”¨**ï¼š

1. é¿å…`[]byte`è½¬æ¢`string`ã€‚
2. é‡ç”¨ç¼“å†²åŒº(buffers)æˆ–å¯¹è±¡(objects)ï¼ˆä¹‹åå¯èƒ½ä¼šæ˜¯[`sync.Pool`](https://groups.google.com/forum/#!topic/golang-dev/kJ_R6vYVYHU)ä¹Ÿå°±æ˜¯[issue 4720](https://code.google.com/p/go/issues/detail?id=4720)ï¼‰ã€‚
3. é¢„åˆ†é…åˆ‡ç‰‡(åœ¨ `make`ä¸­æŒ‡å®šå®¹é‡)ï¼Œå¹¶å§‹ç»ˆçŸ¥é“æ¡ç›®çš„æ•°é‡å’Œå¤§å°ã€‚
4. å¯¹å„ç§å¯é…ç½®çš„`dials`ï¼ˆä¾‹å¦‚æ¶ˆæ¯å¤§å°ï¼‰åº”ç”¨åˆç†çš„é™åˆ¶ã€‚
5. é¿å…è£…ç®±`boxing`ï¼ˆä½¿ç”¨ `interface{}`ï¼‰ æˆ–ä¸å¿…è¦çš„ç±»å‹åŒ…è£…ï¼ˆå¦‚"å¤šä¸ªå€¼"çš„`go-chan`ç»“æ„ä½“ï¼‰ã€‚
6. é¿å…åœ¨çƒ­ä»£ç è·¯å¾„ï¼ˆhot code pathsï¼‰ä¸­ä½¿ç”¨`defer`ã€‚

### TCP åè®®

[NSQ TCP åè®®](https://nsq.io/clients/tcp_protocol_spec.html)æ˜¯ä½¿ç”¨ GC ä¼˜åŒ–æ¦‚å¿µä»¥äº§ç”Ÿå·¨å¤§æ•ˆæœçš„å…‰è¾‰ç¤ºä¾‹ã€‚

è¯¥åè®®ç”¨é•¿åº¦å‰ç¼€å¸§(length prefixed frames)è¿›è¡Œç»“æ„åŒ–ï¼Œä½¿å¾—å®ƒç¼–ç å’Œè§£ç ç®€å•ç›´æ¥ï¼Œæ€§èƒ½å¥½ï¼š

```shell
[x][x][x][x][x][x][x][x][x][x][x][x]...
|  (int32) ||  (int32) || (binary)
|  4-byte  ||  4-byte  || N-byte
------------------------------------...
    size      frame ID     data
```

ç”±äºå¸§ç»„ä»¶çš„ç¡®åˆ‡ç±»å‹å’Œå¤§å°æ˜¯æå‰çŸ¥é“çš„ï¼Œæˆ‘ä»¬å¯ä»¥é¿å…[`encoding/binary`](https://golang.org/pkg/encoding/binary/)åŒ…çš„ä¾¿åˆ©æ€§[`Readï¼ˆï¼‰`](https://golang.org/pkg/encoding/binary/#Read)å’Œ[`Writeï¼ˆï¼‰`](https://golang.org/pkg/encoding/binary/#Write)å°è£…ï¼ˆåŠå…¶æ— å…³çš„æ¥å£æŸ¥æ‰¾å’Œè½¬æ¢ï¼‰ï¼Œç›¸åç›´æ¥è°ƒç”¨åˆé€‚çš„äºŒ[`binary.BigEndian`](https://golang.org/pkg/encoding/binary/#ByteOrder)æ–¹æ³•ã€‚

ä¸ºäº†å‡å°‘å¥—æ¥å­— IO çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå®¢æˆ·ç«¯`net.Conn`ç”¨[`bufio.Readerå’Œbufio.Writer`è¿›è¡Œå°è£…ã€‚`Reader`æš´éœ²äº†[`ReadSliceï¼ˆï¼‰`](https://golang.org/pkg/bufio/#Reader.ReadSlice)æ–¹æ³•ï¼Œå®ƒé‡ç”¨äº†å…¶å†…éƒ¨ç¼“å†²åŒºã€‚è¿™å‡ ä¹æ¶ˆé™¤äº†åœ¨è¯»å–å¥—æ¥å­—æ—¶çš„åˆ†é…ï¼Œå¤§å¤§é™ä½äº†GCå‹åŠ›ã€‚è¿™æ˜¯å¯èƒ½çš„ï¼Œå› ä¸ºä¸å¤§å¤šæ•°å‘½ä»¤å…³è”çš„æ•°æ®ä¸ä¼šè½¬ä¹‰ï¼ˆåœ¨è¾¹ç¼˜æƒ…å†µä¸‹ä¸æ˜¯å¦‚æ­¤ï¼Œæ•°æ®ä¼šè¢«æ˜¾å¼å¤åˆ¶ï¼‰ã€‚

åœ¨æ›´åº•å±‚ï¼Œä¸€ä¸ª`MessageID`è¢«å£°æ˜ä¸º`[16]byte`ï¼Œèƒ½å¤Ÿä½¿ç”¨å®ƒä½œä¸º`map`é”®ï¼ˆåˆ‡ç‰‡ä¸èƒ½ç”¨ä½œmapé”®ï¼‰ã€‚ä½†æ˜¯ï¼Œç”±äºä»å¥—æ¥å­—è¯»å–çš„æ•°æ®å­˜å‚¨ä¸º`[]byte` ï¼Œè€Œä¸æ˜¯é€šè¿‡åˆ†é…`string`é”®äº§ç”Ÿåƒåœ¾ï¼Œå¹¶ä¸”ä¸ºäº†é¿å…`MessageID`ä»åˆ‡ç‰‡åˆ°èƒŒåæ•°ç»„çš„å¤åˆ¶ï¼Œä½¿ç”¨äº†`unsafe`åŒ…æ¥å°†åˆ‡ç‰‡ç›´æ¥è½¬æ¢ä¸ºä¸€ä¸ª`MessageID` 

```go
id := *(*nsq.MessageID)(unsafe.Pointer(&msgID))
```

**æ³¨æ„ï¼š**è¿™æ˜¯ä¸€ä¸ªhackã€‚å¦‚æœç¼–è¯‘å™¨å¯¹æ­¤è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå°±æ²¡æœ‰å¿…è¦è¿™æ ·åšã€‚å¹¶ä¸”[æ‰“å¼€çš„issue 3512 ](https://code.google.com/p/go/issues/detail?id=3512)æœ‰å¯èƒ½è§£å†³æ­¤é—®é¢˜ã€‚å€¼å¾—ä¸€è¯»[issue 5376](https://code.google.com/p/go/issues/detail?id=5376)ï¼Œå…¶ä¸­è°ˆåˆ°"const like"`byte`ç±»å‹å¯ä»¥åœ¨æ¥å—å­—ç¬¦ä¸²çš„åœ°æ–¹ä¸å…¶äº’æ¢ä½¿ç”¨çš„å¯èƒ½æ€§ï¼Œè€Œæ— éœ€åˆ†é…å’Œå¤åˆ¶ã€‚

åŒæ ·ï¼ŒGo æ ‡å‡†åº“ä»…æä¾›äº†æ•°å­—è½¬æ¢`string`çš„æ–¹æ³•ã€‚ä¸ºäº†é¿å…`string`åˆ†é…ï¼Œ**nsqd**åœ¨æ“ä½œ`[]byte`ä¸Šç›´æ¥ä½¿ç”¨äº†[è‡ªå®šä¹‰åŸº10è½¬æ¢æ–¹æ³•](https://github.com/nsqio/nsq/blob/v1.2.0/internal/protocol/byte_base10.go#L9-L29)è½¬æ¢æ–¹æ³•ã€‚

è¿™äº›çœ‹èµ·æ¥åƒå¾®ä¼˜åŒ–ï¼Œä½†TCPåè®®åŒ…å«ä¸€äº›æœ€çƒ­é—¨çš„ä»£ç è·¯å¾„(hottest code paths)ã€‚æ€»çš„æ¥è¯´ï¼Œä»¥æ¯ç§’æ•°ä¸‡æ¡æ¶ˆæ¯çš„é€Ÿåº¦ï¼Œå®ƒä»¬å¯¹åˆ†é…å’Œå¼€é”€çš„é‡æœ‰é‡å¤§å½±å“ï¼š

```shell
benchmark                    old ns/op    new ns/op    delta
BenchmarkProtocolV2Data           3575         1963  -45.09%

benchmark                    old ns/op    new ns/op    delta
BenchmarkProtocolV2Sub256        57964        14568  -74.87%
BenchmarkProtocolV2Sub512        58212        16193  -72.18%
BenchmarkProtocolV2Sub1k         58549        19490  -66.71%
BenchmarkProtocolV2Sub2k         63430        27840  -56.11%

benchmark                   old allocs   new allocs    delta
BenchmarkProtocolV2Sub256           56           39  -30.36%
BenchmarkProtocolV2Sub512           56           39  -30.36%
BenchmarkProtocolV2Sub1k            56           39  -30.36%
BenchmarkProtocolV2Sub2k            58           42  -27.59%
```

### HTTP

NSQ çš„ HTTP API æ„å»ºåœ¨ Go çš„[`net/httpåŒ…`](https://golang.org/pkg/net/http/)ä¹‹ä¸Šã€‚å› ä¸ºå®ƒåªæ˜¯HTTPï¼Œæ‰€ä»¥å‡ ä¹åœ¨ä»»ä½•ç°ä»£ç¼–ç¨‹ç¯å¢ƒä¸­éƒ½å¯ä»¥åˆ©ç”¨å®ƒï¼Œè€Œæ— éœ€ç‰¹å®šçš„å®¢æˆ·ç«¯åº“ã€‚

å®ƒçš„ç®€å•æ€§æ©ç›–äº†å®ƒçš„åŠ›é‡ï¼Œå› ä¸º Go çš„ HTTP å·¥å…·ç®±ä¸­æœ€æœ‰è¶£çš„æ–¹é¢ä¹‹ä¸€æ˜¯å®ƒæ”¯æŒçš„å¹¿æ³›è°ƒè¯•åŠŸèƒ½ã€‚[`net/http/pprof`](https://golang.org/pkg/net/http/pprof/)åŒ…ç›´æ¥ä¸æœ¬æœº HTTP æœåŠ¡å™¨é›†æˆï¼Œæš´éœ²å‡ºç«¯ç‚¹ä»¥è·å– CPUã€heapã€goroutineå’Œos threadé…ç½®ã€‚å¯ä»¥ç›´æ¥é€šè¿‡`go tool`å®šä½ï¼š

```shell
$ go tool pprof http://127.0.0.1:4151/debug/pprof/profile
```

å¯¹äºè°ƒè¯•å’Œåˆ†ææ­£åœ¨è¿è¡Œçš„è¿›ç¨‹æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªæå…¶å®è´µçš„ä»·å€¼ï¼

æ­¤å¤–ï¼Œ`/stats`ç«¯ç‚¹å¯ä»¥ä»¥ JSON æˆ–æ–‡æœ¬çš„æ ¼å¼è¿”å›å¤§é‡æŒ‡æ ‡ï¼Œç®¡ç†å‘˜èƒ½å¤Ÿè½»æ¾åœ°ä»å‘½ä»¤è¡Œè¿›è¡Œå®æ—¶çœæŸ¥ï¼š

```shell
$ watch -n 0.5 'curl -s http://127.0.0.1:4151/stats | grep -v connected'
```

è¿™å°†ç”Ÿæˆè¿ç»­è¾“å‡ºï¼Œå¦‚ï¼š

```shell
[page_views     ] depth: 0     be-depth: 0     msgs: 105525994 e2e%: 6.6s, 6.2s, 6.2s
    [page_view_counter        ] depth: 0     be-depth: 0     inflt: 432  def: 0    re-q: 34684 timeout: 34038 msgs: 105525994 e2e%: 5.1s, 5.1s, 4.6s
    [realtime_score           ] depth: 1828  be-depth: 0     inflt: 1368 def: 0    re-q: 25188 timeout: 11336 msgs: 105525994 e2e%: 9.0s, 9.0s, 7.8s
    [variants_writer          ] depth: 0     be-depth: 0     inflt: 592  def: 0    re-q: 37068 timeout: 37068 msgs: 105525994 e2e%: 8.2s, 8.2s, 8.2s

[poll_requests  ] depth: 0     be-depth: 0     msgs: 11485060 e2e%: 167.5ms, 167.5ms, 138.1ms
    [social_data_collector    ] depth: 0     be-depth: 0     inflt: 2    def: 3    re-q: 7568  timeout: 402   msgs: 11485060 e2e%: 186.6ms, 186.6ms, 138.1ms

[social_data    ] depth: 0     be-depth: 0     msgs: 60145188 e2e%: 199.0s, 199.0s, 199.0s
    [events_writer            ] depth: 0     be-depth: 0     inflt: 226  def: 0    re-q: 32584 timeout: 30542 msgs: 60145188 e2e%: 6.7s, 6.7s, 6.7s
    [social_delta_counter     ] depth: 17328 be-depth: 7327  inflt: 179  def: 1    re-q: 155843 timeout: 11514 msgs: 60145188 e2e%: 234.1s, 234.1s, 231.8s

[time_on_site_ticks] depth: 0     be-depth: 0     msgs: 35717814 e2e%: 0.0ns, 0.0ns, 0.0ns
    [tail821042#ephemeral     ] depth: 0     be-depth: 0     inflt: 0    def: 0    re-q: 0     timeout: 0     msgs: 33909699 e2e%: 0.0ns, 0.0ns, 0.0ns
```

æœ€åï¼Œæ¯ä¸ªæ–°çš„ Go ç‰ˆæœ¬é€šå¸¸éƒ½ä¼šå¸¦æ¥[å¯è¡¡é‡çš„æ€§èƒ½æå‡](https://github.com/davecheney/autobench)ã€‚å½“é’ˆå¯¹æœ€æ–°ç‰ˆæœ¬çš„ Goé‡æ–°ç¼–è¯‘æ—¶ï¼Œç›¸å½“äºæä¾›äº†å…è´¹æå‡ï¼Œ è¿™æ€»æ˜¯å¾ˆå¥½çš„ï¼

### ä¾èµ–é¡¹

æ¥è‡ªå…¶ä»–ç”Ÿæ€ç³»ç»Ÿï¼ŒGo å…³äºä¾èµ–ç®¡ç†çš„ç†å¿µï¼ˆæˆ–ç¼ºä¹ä¾èµ–æ€§ï¼‰éœ€è¦ä¸€ç‚¹æ—¶é—´æ¥ä¹ æƒ¯ã€‚

NSQä»ä¸€ä¸ªå•ä¸€çš„å¤§å‹ä»“åº“å‘å±•è€Œæ¥ï¼Œå…·æœ‰ç›¸å¯¹å¯¼å…¥å’Œå†…éƒ¨è½¯ä»¶åŒ…ä¹‹é—´å‡ ä¹æ— åˆ†éš”çš„ç‰¹å¾ï¼Œå®Œå…¨é‡‡çº³äº†æœ‰å…³ç»“æ„å’Œä¾èµ–ç®¡ç†çš„æœ€ä½³å®è·µå»ºè®®ã€‚

æœ‰ä¸¤ç§ä¸»è¦çš„æ€æƒ³æµæ´¾ï¼š

1. **Vendoring**ï¼šä»¥æ­£ç¡®çš„ç‰ˆæœ¬å°†ä¾èµ–**é¡¹**å¤åˆ¶åˆ°åº”ç”¨ç¨‹åºçš„å­˜å‚¨åº“ä¸­ï¼Œå¹¶ä¿®æ”¹å¯¼å…¥è·¯å¾„ä»¥å¼•ç”¨æœ¬åœ°å‰¯æœ¬ã€‚
2. **Virtual Env**ï¼šåˆ—å‡ºæ‰€éœ€çš„ä¾èµ–é¡¹åŠç‰ˆæœ¬ï¼Œå¹¶åœ¨æ„å»ºæ—¶ç”ŸæˆåŒ…å«è¿™äº›å›ºå®šä¾èµ–é¡¹çš„`GOPATH`ç¯å¢ƒã€‚

**æ³¨æ„ï¼š**è¿™å®é™…ä¸Šä»…é€‚ç”¨äºäºŒè¿›åˆ¶è½¯ä»¶åŒ…ï¼Œå› ä¸ºå¯¹äºå¯å¯¼å…¥çš„è½¯ä»¶åŒ…è€Œè¨€ï¼Œå°±ä½¿ç”¨å“ªä¸ªç‰ˆæœ¬çš„ä¾èµ–é¡¹åšå‡ºä¸­é—´å†³ç­–æ²¡æœ‰ä»»ä½•æ„ä¹‰ã€‚

NSQä½¿ç”¨ä¸Šè¿°(2)æ–¹æ³•ã€‚ï¼ˆå®ƒæœ€å¼€å§‹ä½¿ç”¨[gpm](https://github.com/pote/gpm)ï¼Œç„¶åä½¿ç”¨[dep](https://github.com/golang/dep)ï¼Œç°åœ¨ä½¿ç”¨[Goæ¨¡å—](https://github.com/golang/go/wiki/Modules)ï¼‰ã€‚

### æµ‹è¯•

Goä¸ºç¼–å†™æµ‹è¯•å’ŒåŸºå‡†æä¾›äº†åšå®çš„å†…ç½®æ”¯æŒï¼Œå¹¶ä¸”ä½¿å¾—æ¨¡å‹åŒ–å¹¶å‘æ“ä½œéå¸¸å®¹æ˜“ï¼Œå› æ­¤åœ¨æµ‹è¯•ç¯å¢ƒä¸­å»ºç«‹èµ·ä¸€ä¸ªå®Œæ•´çš„**nsqd**å®ä¾‹å¾ˆç®€å• ã€‚

ç„¶è€Œï¼Œåˆå§‹å®ç°æ—¶æœ‰ä¸€ä¸ªæ–¹é¢å¯¹æµ‹è¯•é€ æˆäº†é—®é¢˜ï¼šå…¨å±€çŠ¶æ€(`global state`)ã€‚æœ€æ˜æ˜¾çš„"è¿æ³•è€…"(offendar)æ˜¯ä½¿ç”¨å…¨å±€å˜é‡ï¼Œè¯¥å…¨å±€å˜é‡åœ¨è¿è¡Œæ—¶ä¿ç•™äº†å¯¹**nsqd**å®ä¾‹çš„å¼•ç”¨ï¼Œä¾‹å¦‚ï¼š`var nsqd *NSQd`ã€‚

æŸäº›æµ‹è¯•ä¼šä½¿ç”¨çŸ­å˜é‡èµ‹å€¼ï¼Œå³åœ¨å±€éƒ¨ä½œç”¨åŸŸå†…ä½¿ç”¨`nsqd := NewNSQd(...)`æ— æ„ä¸­å±è”½äº†æ­¤å…¨å±€å˜é‡ã€‚è¿™æ„å‘³ç€å…¨å±€å¼•ç”¨æœªæŒ‡å‘å½“å‰æ­£åœ¨è¿è¡Œçš„å®ä¾‹ï¼Œä»è€Œç ´åäº†æµ‹è¯•ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¼ é€’äº†ä¸€ä¸ª`Context`ç»“æ„ï¼Œè¯¥ç»“æ„åŒ…å«é…ç½®å…ƒæ•°æ®å’Œå¯¹çˆ¶**nsqd**çš„å¼•ç”¨ã€‚æ‰€æœ‰å¯¹å…¨å±€çŠ¶æ€çš„å¼•ç”¨éƒ½è¢«æ›¿æ¢ä¸ºå±€éƒ¨ `Context`ï¼Œä»è€Œä½¿å­ç¨‹åºï¼ˆ`children`: ä¸»é¢˜`topics`ï¼Œé¢‘é“`channel`ï¼Œåè®®å¤„ç†ç¨‹åº`protocol handlers`ç­‰ï¼‰å¯ä»¥å®‰å…¨åœ°è®¿é—®æ­¤æ•°æ®ï¼Œå¹¶ä½¿æµ‹è¯•æ›´åŠ å¯é ã€‚

### é²æ£’æ€§

é¢å¯¹ä¸æ–­å˜åŒ–çš„ç½‘ç»œçŠ¶å†µæˆ–çªå‘äº‹ä»¶è€Œä¸å¤Ÿå¥å£®çš„ç³»ç»Ÿï¼Œåœ¨åˆ†å¸ƒå¼ç”Ÿäº§ç¯å¢ƒä¸­æ˜¯æ— æ³•æ­£å¸¸è¿è¡Œçš„ã€‚

NSQçš„è®¾è®¡å’Œå®ç°æ–¹å¼å…è®¸ç³»ç»Ÿå®¹å¿æ•…éšœå¹¶ä»¥ä¸€è‡´ã€å¯é¢„æµ‹å’Œå¹³å¸¸çš„æ–¹å¼è¿è¡Œã€‚

é¦–è¦åŸåˆ™æ˜¯å¿«é€Ÿå¤±è´¥ï¼Œå°†é”™è¯¯è§†ä¸ºè‡´å‘½é”™è¯¯ï¼Œå¹¶æä¾›ä¸€ç§æ–¹æ³•è°ƒè¯•æ‰€æœ‰å‘ç”Ÿçš„é—®é¢˜ã€‚

ä½†æ˜¯ï¼Œä¸ºäº†åšå‡ºååº”ï¼Œæ‚¨éœ€è¦èƒ½å¤Ÿå‘ç°å¼‚å¸¸æƒ…å†µâ€¦â€¦

### å¿ƒè·³å’Œè¶…æ—¶

NSQ TCPåè®®æ˜¯é¢å‘æ¨é€çš„ã€‚è¿æ¥ï¼Œæ¡æ‰‹å’Œè®¢é˜…åï¼Œæ¶ˆè´¹è€…å°†å¤„äºçš„`RDY`çŠ¶æ€`0`ã€‚å½“æ¶ˆè´¹è€…å‡†å¤‡å¥½æ¥æ”¶æ¶ˆæ¯æ—¶ï¼Œå®ƒå°†`RDY`çŠ¶æ€æ›´æ–°ä¸ºå°†è¦æ¥æ”¶çš„æ¶ˆæ¯æ•°ã€‚NSQå®¢æˆ·ç«¯åº“åœ¨å¹•åæŒç»­å¯¹å…¶è¿›è¡Œç®¡ç†ï¼Œä»è€Œå½¢æˆäº†æµæ§åˆ¶çš„æ¶ˆæ¯æµã€‚

**nsqd**ä¼šå®šæœŸé€šè¿‡è¿æ¥å‘é€å¿ƒè·³ã€‚å®¢æˆ·ç«¯å¯ä»¥é…ç½®å¿ƒè·³é—´éš”ï¼Œä½†æ˜¯**nsqd**åœ¨å‘é€ä¸‹ä¸€ä¸ªå¿ƒè·³ä¹‹å‰éœ€è¦å¾—åˆ°ä¸€ä¸ªå“åº”ã€‚

åº”ç”¨ç¨‹åºçº§åˆ«çš„å¿ƒè·³å’Œ`RDY`çŠ¶æ€çš„ç»„åˆé¿å…äº†[è¡Œé¦–é˜»å¡](https://en.wikipedia.org/wiki/Head-of-line_blocking)ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´å¿ƒè·³æ— ç”¨ï¼ˆå³ï¼Œå¦‚æœæ¶ˆè´¹è€…åœ¨å¤„ç†æ¶ˆæ¯æµæ—¶è½åï¼Œåˆ™æ“ä½œç³»ç»Ÿçš„æ¥æ”¶ç¼“å†²åŒºå°†å¡«æ»¡ï¼Œä»è€Œé˜»å¡å¿ƒè·³ï¼‰ã€‚

ä¸ºäº†ä¿è¯è¿›åº¦ï¼Œæ‰€æœ‰ç½‘ç»œIOéƒ½å¿…é¡»æœ‰ç›¸å¯¹äºé…ç½®çš„å¿ƒè·³é—´éš”æˆªæ­¢æ—¥æœŸã€‚è¿™æ„å‘³ç€æ‚¨å¯ä»¥ä»å­—é¢ä¸Šæ‹”å‡º**nsqd**ä¸æ¶ˆè´¹è€…ä¹‹é—´çš„ç½‘ç»œè¿æ¥ï¼Œå®ƒå°†æ£€æµ‹å¹¶æ­£ç¡®å¤„ç†è¯¥é”™è¯¯ã€‚

å½“æ£€æµ‹åˆ°è‡´å‘½é”™è¯¯æ—¶ï¼Œå®¢æˆ·ç«¯è¿æ¥å°†è¢«å¼ºåˆ¶å…³é—­ã€‚ä¼ è¾“ä¸­çš„æ¶ˆæ¯ä¼šè¶…æ—¶å¹¶é‡æ–°æ’é˜Ÿä»¥ä¼ é€’ç»™å…¶ä»–æ¶ˆè´¹è€…ã€‚æœ€åï¼Œå°†è®°å½•é”™è¯¯å¹¶å¢åŠ å„ç§å†…éƒ¨æŒ‡æ ‡ã€‚

### ç®¡ç†Goroutine

å¯åŠ¨`goroutines`éå¸¸å®¹æ˜“ã€‚ä¸å¹¸çš„æ˜¯ï¼Œå®‰æ’å®ƒä»¬çš„æ¸…ç†å´å¹¶ä¸æ˜¯é‚£ä¹ˆå®¹æ˜“ã€‚é¿å…æ­»é”ä¹Ÿå…·æœ‰æŒ‘æˆ˜æ€§ã€‚é€šå¸¸ï¼Œè¿™å½’ç»“ä¸ºä¸€ä¸ªæ’åºé—®é¢˜ï¼Œå³åœ¨`go-chan`ä¸Šæ¥æ”¶æ¶ˆæ¯çš„`goroutine`åœ¨ä¸Šæ¸¸`goroutine`å‘é€æ¶ˆæ¯ä¹‹å‰å°±é€€å‡ºäº†ã€‚

ä¸ºä»€ä¹ˆè¦å…³å¿ƒè¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œå­¤ç«‹çš„`goroutine`å°±æ˜¯å†…å­˜æ³„æ¼ã€‚å†…å­˜æ³„æ¼åœ¨é•¿æ—¶é—´è¿è¡Œçš„å®ˆæŠ¤è¿›ç¨‹ä¸­æ˜¯å¾ˆç³Ÿç³•çš„ï¼Œå°¤å…¶æ˜¯å½“å…¶ä»–æ‰€æœ‰æ“ä½œéƒ½å¤±è´¥æ—¶ï¼Œä½ æœŸæœ›ä½ çš„ç¨‹åºç¨³å®šè¿è¡Œã€‚

æ›´å¤æ‚çš„æ˜¯ï¼Œå…¸å‹çš„**nsqd**è¿›ç¨‹åœ¨æ¶ˆæ¯ä¼ é€’ä¸­æ¶‰åŠè®¸å¤š`goroutine`ã€‚åœ¨å†…éƒ¨ï¼Œæ¶ˆæ¯çš„"å½’å±æƒ"ç»å¸¸å‘ç”Ÿå˜åŒ–ã€‚ä¸ºäº†åœ¨å…³é—­æ—¶èƒ½å¤Ÿæ¸…ç†å¹²å‡€ï¼Œè€ƒè™‘æ‰€æœ‰è¿›ç¨‹å†…çš„æ¶ˆæ¯æ˜¯éå¸¸é‡è¦çš„ã€‚

å°½ç®¡æ²¡æœ‰ä»»ä½•çµä¸¹å¦™è¯(`magic bullets`)ï¼Œä½†ä»¥ä¸‹æŠ€æœ¯å¯ä»¥è®©ç®¡ç†æ›´å®¹æ˜“ä¸€äº›â€¦â€¦

#### ç­‰å¾…ç»„

[`sync`](https://golang.org/pkg/sync/)åŒ…æä¾›äº†[`sync.WaitGroup`](https://golang.org/pkg/sync/#WaitGroup)ï¼Œå¯ç”¨äºæ‰§è¡Œå®æ—¶goroutineè®¡æ•°ï¼ˆå¹¶æä¾›ä¸€ç§ç­‰å¾…å®ƒä»¬é€€å‡ºçš„æ–¹æ³•ï¼‰ã€‚

ä¸ºäº†å‡å°‘å…¸å‹çš„æ ·æ¿(`boilerplate`)ä»£ç ï¼Œ**nsqd**ä½¿ç”¨äº†ä»¥ä¸‹åŒ…è£…ï¼š

```go
type WaitGroupWrapper struct {
	sync.WaitGroup
}

func (w *WaitGroupWrapper) Wrap(cb func()) {
	w.Add(1)
	go func() {
		cb()
		w.Done()
	}()
}

// can be used as follows:
wg := WaitGroupWrapper{}
wg.Wrap(func() { n.idPump() })
...
wg.Wait()
```

#### é€€å‡ºä¿¡å·

åœ¨å¤šä¸ªå­`goroutine`ä¸­è§¦å‘äº‹ä»¶çš„æœ€ç®€å•æ–¹æ³•æ˜¯æä¾›ä¸€ä¸ªå‡†å¤‡å°±ç»ªæ—¶å¯ä»¥å…³é—­çš„`go-chan`ã€‚è¯¥`go-chan`ä¸Šçš„æ‰€æœ‰æœªå†³æ¥æ”¶(`pending receives`)å°†æ¿€æ´»ï¼Œè€Œä¸å¿…å‘æ¯ä¸ª`goroutine`å‘é€å•ç‹¬çš„ä¿¡å·ã€‚

```go
func work() {
    exitChan := make(chan int)
    go task1(exitChan)
    go task2(exitChan)
    time.Sleep(5 * time.Second)
    close(exitChan)
}
func task1(exitChan chan int) {
    <-exitChan
    log.Printf("task1 exiting")
}

func task2(exitChan chan int) {
    <-exitChan
    log.Printf("task2 exiting")
}
```

#### åŒæ­¥é€€å‡º

è¦å®ç°ä¸€ä¸ªå¯é çš„ï¼Œæ— æ­»é”çš„é€€å‡ºè·¯å¾„ï¼Œè¿™æ˜¯éå¸¸å›°éš¾çš„ã€‚ä¸€äº›æç¤ºï¼š

1. ç†æƒ³æƒ…å†µä¸‹ï¼Œè´Ÿè´£å‘`go-chan`å‘é€æ¶ˆæ¯çš„`goroutine`ä¹Ÿåº”è´Ÿè´£å…³é—­`go-chan`ã€‚
2. å¦‚æœä¸èƒ½ä¸¢å¤±æ¶ˆæ¯ï¼Œè¯·ç¡®ä¿æ¸…ç©ºç›¸å…³çš„`go-chans`ï¼ˆå°¤å…¶æ˜¯æ— ç¼“å†²çš„`go-chan`ï¼‰ï¼Œä»¥ç¡®ä¿å‘é€è€…å¯ä»¥å–å¾—è¿›å±•ã€‚
3. æ­¤å¤–ï¼Œå¦‚æœæ¶ˆæ¯ä¸å†ç›¸å…³ï¼Œåˆ™åº”è¯¥åœ¨å‘é€å•ä¸ª`go-chan`çš„æƒ…å†µä¸‹å°†å…¶è½¬æ¢ä¸º`select`ï¼Œå¹¶æ·»åŠ é€€å‡ºä¿¡å·ï¼ˆå¦‚ä¸Šæ‰€è¿°ï¼‰ï¼Œä»¥ç¡®ä¿è¿›åº¦ã€‚
4. ä¸€èˆ¬é¡ºåºåº”ä¸ºï¼š
   1. åœæ­¢æ¥å—æ–°çš„è¿æ¥ï¼ˆå…³é—­ç›‘å¬å™¨ï¼‰
   2. å‘å­`goroutine`å‘å‡ºé€€å‡ºä¿¡å·ï¼ˆå¦‚ä¸Šï¼‰
   3. ä½¿ç”¨`WaitGroup`ç­‰å¾…`goroutine`é€€å‡ºï¼ˆå¦‚ä¸Šï¼‰
   4. æ¢å¤ç¼“å†²çš„æ•°æ®
   5. æ¸…é™¤ç£ç›˜ä¸Šå‰©ä½™çš„æ‰€æœ‰å†…å®¹

#### æ—¥å¿—

æœ€åï¼Œæœ€é‡è¦çš„å·¥å…·æ˜¯è®°å½•`goroutine`çš„è¿›å…¥å’Œé€€å‡ºï¼åœ¨æ­»é”æˆ–å†…å­˜æ³„æ¼çš„æƒ…å†µä¸‹ï¼Œè¿™å°†ä½¿ç½ªé­ç¥¸é¦–çš„ç¡®å®šå˜å¾—æ— é™å®¹æ˜“ã€‚

**nsqd**æ—¥å¿—è¡ŒåŒ…å«`goroutine`ä¸å…¶åŒçº§ï¼ˆå’Œçˆ¶çº§ï¼‰ç›¸å…³è”çš„ä¿¡æ¯ï¼Œä¾‹å¦‚ å®¢æˆ·ç«¯çš„è¿œç¨‹åœ°å€ æˆ– ä¸»é¢˜/é€šé“åç§°ã€‚

æ—¥å¿—æ˜¯å†—é•¿çš„ï¼Œä½†ä¸æ˜¯è¯´éœ€è¦å†—é•¿çš„æ—¥å¿—ã€‚**nsqd**å€¾å‘äºåœ¨å‘ç”Ÿæ•…éšœæ—¶åœ¨æ—¥å¿—ä¸­æä¾›æ›´å¤šä¿¡æ¯ï¼Œè€Œä¸æ˜¯å°è¯•ä»¥ç‰ºç‰²æœ‰ç”¨æ€§æ¥å‡å°‘é—²è°ˆ(`chattiness`)ã€‚

# ç»„ä»¶

## nsqd

`nsqd` æ˜¯æ¥æ”¶æ¶ˆæ¯ï¼Œå½¢æˆæ¶ˆæ¯é˜Ÿåˆ—å¹¶å°†æ¶ˆæ¯ä¼ é€’åˆ°å®¢æˆ·ç«¯çš„å®ˆæŠ¤è¿›ç¨‹ã€‚

å®ƒå¯ä»¥ç‹¬ç«‹è¿è¡Œï¼Œä½†é€šå¸¸åœ¨å…·æœ‰`nsqlookupd` å®ä¾‹çš„é›†ç¾¤ä¸­é…ç½®ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒå°†å£°æ˜ä¸»é¢˜å’Œé€šé“ç”¨ä»¥æœåŠ¡å‘ç°ï¼‰ã€‚

å®ƒä¾¦å¬ä¸¤ä¸ªTCPç«¯å£ï¼Œä¸€ä¸ªä¾¦å¬å®¢æˆ·ç«¯ï¼Œå¦ä¸€ä¸ªä¾¦å¬HTTP APIã€‚ä¹Ÿå¯ä»¥é€‰æ‹©åœ¨ç¬¬ä¸‰ä¸ªç«¯å£ä¸Šä¾¦å¬HTTPSã€‚

### å‘½ä»¤è¡Œå‚æ•°é€‰é¡¹

```shell
-auth-http-address value
    <addr>:<port> to query auth server (may be given multiple times)
-broadcast-address string
    address that will be registered with lookupd (defaults to the OS hostname) (default "yourhost.local")
-broadcast-http-port int
    HTTP port that will be registered with lookupd (defaults to the HTTP port that this nsqd is listening to)
-broadcast-tcp-port int
    TCP port that will be registered with lookupd (defaults to the TCP port that this nsqd is listening to)
-config string
    path to config file
-data-path string
    path to store disk-backed messages
-deflate
    enable deflate feature negotiation (client compression) (default true)
-e2e-processing-latency-percentile value
    message processing time percentiles (as float (0, 1.0]) to track (can be specified multiple times or comma separated '1.0,0.99,0.95', default none)
-e2e-processing-latency-window-time duration
    calculate end to end latency quantiles for this duration of time (ie: 60s would only show quantile calculations from the past 60 seconds) (default 10m0s)
-http-address string
    <addr>:<port> to listen on for HTTP clients (default "0.0.0.0:4151")
-http-client-connect-timeout duration
    timeout for HTTP connect (default 2s)
-http-client-request-timeout duration
    timeout for HTTP request (default 5s)
-https-address string
    <addr>:<port> to listen on for HTTPS clients (default "0.0.0.0:4152")
-log-level value
    set log verbosity: debug, info, warn, error, or fatal (default INFO)
-log-prefix string
    log message prefix (default "[nsqd] ")
-lookupd-tcp-address value
    lookupd TCP address (may be given multiple times)
-max-body-size int
    maximum size of a single command body (default 5242880)
-max-bytes-per-file int
    number of bytes per diskqueue file before rolling (default 104857600)
-max-channel-consumers int
    maximum channel consumer connection count per nsqd instance (default 0, i.e., unlimited)
-max-deflate-level int
    max deflate compression level a client can negotiate (> values == > nsqd CPU usage) (default 6)
-max-heartbeat-interval duration
    maximum client configurable duration of time between client heartbeats (default 1m0s)
-max-msg-size int
    maximum size of a single message in bytes (default 1048576)
-max-msg-timeout duration
    maximum duration before a message will timeout (default 15m0s)
-max-output-buffer-size int
    maximum client configurable size (in bytes) for a client output buffer (default 65536)
-max-output-buffer-timeout duration
    maximum client configurable duration of time between flushing to a client (default 30s)
-max-rdy-count int
    maximum RDY count for a client (default 2500)
-max-req-timeout duration
    maximum requeuing timeout for a message (default 1h0m0s)
-mem-queue-size int
    number of messages to keep in memory (per topic/channel) (default 10000)
-min-output-buffer-timeout duration
    minimum client configurable duration of time between flushing to a client (default 25ms)
-msg-timeout duration
    default duration to wait before auto-requeing a message (default 1m0s)
-node-id int
    unique part for message IDs, (int) in range [0,1024) (default is hash of hostname) (default 248)
-output-buffer-timeout duration
    default duration of time between flushing data to clients (default 250ms)
-snappy
    enable snappy feature negotiation (client compression) (default true)
-statsd-address string
    UDP <addr>:<port> of a statsd daemon for pushing stats
-statsd-interval duration
    duration between pushing to statsd (default 1m0s)
-statsd-mem-stats
    toggle sending memory and GC stats to statsd (default true)
-statsd-prefix string
    prefix used for keys sent to statsd (%s for host replacement) (default "nsq.%s")
-statsd-udp-packet-size int
    the size in bytes of statsd UDP packets (default 508)
-sync-every int
    number of messages per diskqueue fsync (default 2500)
-sync-timeout duration
    duration of time per diskqueue fsync (default 2s)
-tcp-address string
    <addr>:<port> to listen on for TCP clients (default "0.0.0.0:4150")
-tls-cert string
    path to certificate file
-tls-client-auth-policy string
    client certificate auth policy ('require' or 'require-verify')
-tls-key string
    path to key file
-tls-min-version value
    minimum SSL/TLS version acceptable ('ssl3.0', 'tls1.0', 'tls1.1', or 'tls1.2') (default 769)
-tls-required
    require TLS for client connections (true, false, tcp-https)
-tls-root-ca-file string
    path to certificate authority file
-verbose
    [deprecated] has no effect, use --log-level
-version
    print version string
-worker-id
    [deprecated] use --node-id
```

### HTTP API

- [`/ping`](https://nsq.io/components/nsqd.html#get-ping) -æ˜¯å¦å­˜æ´»
- [`/info`](https://nsq.io/components/nsqd.html#get-info) - ç‰ˆæœ¬ä¿¡æ¯
- [`/stats`](https://nsq.io/components/nsqd.html#get-stats) -è¯¦å°½çš„è¿è¡Œæ—¶é¥æµ‹
- [`/pub`](https://nsq.io/components/nsqd.html#post-pub) -å‘å¸ƒä¸»é¢˜æ¶ˆæ¯
- [`/mpub`](https://nsq.io/components/nsqd.html#post-mpub) -å°†å¤šä¸ªæ¶ˆæ¯å‘å¸ƒåˆ°ä¸€ä¸ªä¸»é¢˜
- [`/config`](https://nsq.io/components/nsqd.html#get-confignsqlookupdtcpaddresses) -é…ç½®nsqd
- [`/debug/pprof`](https://nsq.io/components/nsqd.html#get-debugpprof) -pprofè°ƒè¯•é—¨æˆ·
- [`/debug/pprof/profile`](https://nsq.io/components/nsqd.html#get-debugpprofprofile) -ç”Ÿæˆpprof CPUé…ç½®æ–‡ä»¶
- [`/debug/pprof/goroutine`](https://nsq.io/components/nsqd.html#get-debugpprofgoroutine) -ç”Ÿæˆpprof goroutineé…ç½®æ–‡ä»¶
- [`/debug/pprof/heap`](https://nsq.io/components/nsqd.html#get-debugpprofheap) -ç”Ÿæˆpprofå †é…ç½®æ–‡ä»¶
- [`/debug/pprof/block`](https://nsq.io/components/nsqd.html#get-debugpprofblock) -ç”Ÿæˆpprof blocké…ç½®æ–‡ä»¶
- [`/debug/pprof/threadcreate`](https://nsq.io/components/nsqd.html#get-debugpprofthreadcreate) -ç”Ÿæˆpprof OSçº¿ç¨‹é…ç½®æ–‡ä»¶

`v1`å‘½åç©ºé—´ï¼ˆè‡ª`nsqd` `v0.2.29+`ï¼‰ï¼š

- [`/topic/create`](https://nsq.io/components/nsqd.html#post-topiccreate) -åˆ›å»ºä¸€ä¸ªæ–°ä¸»é¢˜
- [`/topic/delete`](https://nsq.io/components/nsqd.html#post-topicdelete) -åˆ é™¤ä¸»é¢˜
- [`/topic/empty`](https://nsq.io/components/nsqd.html#post-topicempty) -æ¸…ç©ºä¸»é¢˜
- [`/topic/pause`](https://nsq.io/components/nsqd.html#post-topicpause) -æš‚åœä¸»é¢˜çš„æ¶ˆæ¯æµ
- [`/topic/unpause`](https://nsq.io/components/nsqd.html#post-topicunpause) -å–æ¶ˆæš‚åœçš„ä¸»é¢˜æ¶ˆæ¯æµ
- [`/channel/create`](https://nsq.io/components/nsqd.html#post-channelcreate) -å»ºç«‹æ–°é€šé“
- [`/channel/delete`](https://nsq.io/components/nsqd.html#post-channeldelete) -åˆ é™¤é€šé“
- [`/channel/empty`](https://nsq.io/components/nsqd.html#post-channelempty) -æ¸…ç©ºé€šé“
- [`/channel/pause`](https://nsq.io/components/nsqd.html#post-channelpause) -æš‚åœé€šé“çš„æ¶ˆæ¯æµ
- [`/channel/unpause`](https://nsq.io/components/nsqd.html#post-channelunpause) -å–æ¶ˆæš‚åœçš„é€šé“æ¶ˆæ¯æµ



- #### `POST` `/pub`

  å‘å¸ƒä¸€ä¸ªæ¶ˆæ¯ï¼š

  Query Params:

  ```shell
  topic - è¦å‘å¸ƒçš„ä¸»é¢˜
  defer - æ¶ˆæ¯å»¶è¿Ÿå‘é€çš„æ¯«ç§’æ•°(å¯é€‰å‚æ•°)
  ```

  Body:

  ```shell
  åŸå§‹æ¶ˆæ¯å­—èŠ‚
  ```

  Example:

  ```shell
  $ curl -d "<message>" http://127.0.0.1:4151/pub?topic=name
  ```

- #### `POST` `/mpub`

  ä¸€æ¬¡å¾€è¿”å‘å¸ƒå¤šæ¡æ¶ˆæ¯

  Query Params:

  ```shell
  topic - è¦å‘å¸ƒçš„ä¸»é¢˜
  binary - å¸ƒå°”å€¼ ('true' or 'false')ï¼Œæ˜¯å¦å¼€å¯äºŒè¿›åˆ¶æ¨¡å¼
  ```

  Body

  ```shell
  \n åˆ†å‰²çš„åŸå§‹æ¶ˆæ¯å­—èŠ‚
  ```

  **æ³¨æ„**ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œ`/mpub`æœŸæœ›ç”¨`\n`æ¥åˆ†éš”æ¶ˆæ¯ï¼Œä½¿ç”¨`?binary=true`queryå‚æ•°æ¥å¯ç”¨äºŒè¿›åˆ¶æ¨¡å¼ï¼Œå…¶ä¸­POST bodyåº”é‡‡ç”¨ä»¥ä¸‹æ ¼å¼ï¼ˆå‘é€çš„HTTP headerä¸­`Content-Length`åº”ä¸º`POST` bodyçš„æ€»å¤§å°ï¼‰ï¼š

  ```shell
  [ 4-byte num messages ]
  [ 4-byte message #1 size ][ N-byte binary data ]
        ... (repeated <num_messages> times)
  ```

  Example:

  ```shell
  $ curl -d "<message>\n<message>\n<message>" http://127.0.0.1:4151/mpub?topic=name
  ```

- #### `POST` `/topic/create`

  åˆ›å»ºä¸€ä¸ªä¸»é¢˜

  Query Params:

  ```shell
  topic - è¦åˆ›å»ºçš„ä¸»é¢˜
  ```

  Example:

  ```sh
  $ curl -X POST http://127.0.0.1:4151/topic/create?topic=name
  ```

- #### `POST` `/topic/delete`

  åˆ é™¤ä¸€ä¸ªç°å­˜çš„ä¸»é¢˜ï¼ˆä»¥åŠæ‰€æœ‰çš„é€šé“ï¼‰

  Query Params:

  ```shell
  topic - è¦åˆ é™¤çš„ä¸»é¢˜
  ```

  Example:

  ```sh
  $ curl -X POST http://127.0.0.1:4151/topic/delete?topic=name
  ```

- #### `POST` `/channel/create`

  ç»™ç°å­˜çš„ä¸»é¢˜åˆ›å»ºä¸€ä¸ªé€šé“

  Query Params:

  ```shell
  topic - ç°å­˜çš„ä¸»é¢˜
  channel - è¦åˆ›å»ºçš„é€šé“
  ```

  Example:

  ```shell
  $ curl -X POST http://127.0.0.1:4151/channel/create?topic=name&channel=name
  ```

- #### `POST` `/channel/delete`

  åˆ é™¤ä¸€ä¸ªç°æœ‰ä¸»é¢˜çš„ä¸€ä¸ªé€šé“

  Query Params:

  ```shell
  topic - ç°å­˜çš„ä¸»é¢˜
  channel - è¦åˆ é™¤çš„é€šé“
  ```

  Example:

  ```shell
  $ curl -X POST http://127.0.0.1:4151/channel/delete?topic=name&channel=name
  ```

- #### `POST` `/topic/empty`

  æ¸…ç©ºä¸€ä¸ªç°æœ‰ä¸»é¢˜çš„æ‰€æœ‰é˜Ÿåˆ—æ¶ˆæ¯ï¼ˆå†…å­˜å’Œç£ç›˜ä¸­çš„ï¼‰

  Query Params:

  ```
  topic - è¦æ¸…ç©ºçš„ç°æœ‰ä¸»é¢˜
  ```

  Example:

  ```sh
  $ curl -X POST http://127.0.0.1:4151/topic/empty?topic=name
  ```

- #### `POST` `/channel/empty`

  æ¸…ç©ºä¸€ä¸ªç°æœ‰é€šé“çš„æ‰€æœ‰é˜Ÿåˆ—æ¶ˆæ¯ï¼ˆå†…å­˜å’Œç£ç›˜ä¸­çš„ï¼‰

  Query Params:

  ```
  topic - ç°æœ‰ä¸»é¢˜
  channel - è¦æ¸…ç©ºçš„é€šé“
  ```

  Example:

  ```
  $ curl -X POST http://127.0.0.1:4151/channel/empty?topic=name&channel=name
  ```

- #### `POST` `/topic/pause`

  æš‚åœä¸€ä¸ªä¸»é¢˜æ‰€æœ‰é€šé“çš„æ¶ˆæ¯æµï¼ˆæ¶ˆæ¯å°†ä»¥ä¸»é¢˜è¿›è¡Œæ’é˜Ÿï¼‰

  Query Params:

  ```sh
  topic - ç°æœ‰ä¸»é¢˜
  ```

  Example:

  ```shell
  $ curl -X POST http://127.0.0.1:4151/topic/pause?topic=name
  ```

- #### `POST` `/topic/unpause`

  æ¢å¤ç°æœ‰å·²æš‚åœä¸»é¢˜çš„é€šé“æ¶ˆæ¯æµ

  Query Params:

  ```shell
  topic -ç°æœ‰ä¸»é¢˜
  ```

  Example:

  ```shell
  $ curl -X POST http://127.0.0.1:4151/topic/unpause?topic=name
  ```

- #### `POST` `/channel/pause`

  æš‚åœå‘å¾€æ¶ˆè´¹è€…çš„é€šé“æ¶ˆæ¯æµï¼ˆæ¶ˆæ¯å°†ä»¥é€šé“è¿›è¡Œæ’é˜Ÿï¼‰

  Query Params:

  ```shell
  topic - ç°æœ‰ä¸»é¢˜
  channel - è¦æš‚åœçš„é€šé“
  ```

  Example:

  ```shell
  $ curl -X POST http://127.0.0.1:4151/channel/pause?topic=name&channel=name
  ```

- #### `POST` `/channel/unpause`

  æ¢å¤å‘å¾€æ¶ˆè´¹è€…çš„å·²æš‚åœçš„é€šé“æ¶ˆæ¯æµ

  Query Params:

  ```shell
  topic - ç°æœ‰ä¸»é¢˜
  channel - è¦æ¢å¤çš„é€šé“
  ```

  Example:

  ```shell
  $ curl -X POST http://127.0.0.1:4151/channel/unpause?topic=name&channel=name
  ```

- #### `GET` `/stats`

  è¿”å›å†…éƒ¨ç»Ÿè®¡

  Query Params

  ```shell
  format - (å¯é€‰) `text` or `json` (default = `text`)
  topic - (å¯é€‰) ç­›é€‰ä¸»é¢˜
  channel - (å¯é€‰) ç­›é€‰é€šé“
  ```

  Example:

  ```shell
  $ curl http://127.0.0.1:4151/stats
  ```

- #### `GET` `/ping`

  ç›‘æ§ç«¯ç‚¹ï¼Œåº”è¯¥è¿”å›`200 OK`ã€‚å¦‚æœè¿è¡Œä¸å¥åº·ï¼Œè¿”å›HTTP 500ã€‚

  **æ³¨æ„ï¼š**å”¯ä¸€çš„"unhealthy"çŠ¶æ€æ˜¯åœ¨å‘ç”Ÿæº¢å‡ºæ—¶æœªèƒ½å°†æ¶ˆæ¯å†™å…¥ç£ç›˜ã€‚

- #### `GET` `/info`

  ç‰ˆæœ¬ä¿¡æ¯

- #### `GET` `/debug/pprof`

  å¯ç”¨çš„è°ƒè¯•ç«¯ç‚¹ç´¢å¼•é¡µã€‚

- #### `GET` `/debug/pprof/profile`

  å¯åŠ¨`pprof`CPUé…ç½®æ–‡ä»¶30ç§’é’Ÿï¼Œå¹¶é€šè¿‡è¯·æ±‚è¿”å›è¾“å‡º

  **æ³¨æ„**ï¼šæ­¤ç«¯ç‚¹æœªåœ¨`/debug/pprof`ç´¢å¼•é¡µé¢ä¸­åˆ—å‡ºï¼Œå› ä¸ºå®ƒä¼šå½±å“è¿è¡Œæ—¶æ€§èƒ½ã€‚

- #### `GET` `/debug/pprof/goroutine`

  è¿”å›æ‰€æœ‰è¿è¡Œä¸­çš„`goroutines`çš„æ ˆè¿½è¸ªã€‚

- #### `GET` `/debug/pprof/heap`

  è¿”å›å †å’Œå†…å­˜ç»Ÿè®¡é…ç½®ä¿¡æ¯ï¼ˆé¡¶éƒ¨å¯ä»¥ç”¨ä½œ`pprof`å†…å­˜é…ç½®ä¿¡æ¯ï¼‰

- #### `GET` `/debug/pprof/block`

  è¿”å›ä¸€ä¸ª`goroutine blocking` é…ç½®ä¿¡æ¯

- #### `GET` `/debug/pprof/threadcreate`

  è¿”å›åˆ›å»ºOSçº¿ç¨‹çš„`goroutine`æ ˆè·Ÿè¸ª

- #### `GET` `/config/nsqlookupd_tcp_addresses`

  nsqlookupd TCPåœ°å€åˆ—è¡¨

  Example:

  ```shell
  $ curl http://127.0.0.1:4151/config/nsqlookupd_tcp_addresses
  ```

- #### `PUT` `/config/nsqlookupd_tcp_addresses`

  æ›´æ–°nsqlookupd TCPåœ°å€ã€‚

  Body:

  ```shell
  JSON array of TCP addresses.
  ```

  Example:

  ```shell
  $ curl -X PUT http://127.0.0.1:4151/config/nsqlookupd_tcp_addresses \
      -d '["127.0.0.1:4160", "127.0.0.2:4160"]'
  ```

### è°ƒè¯•å’Œåˆ†æ

`nsqd`æä¾›äº†ä¸€å¥—å¯ä¸Goçš„[pprof](https://golang.org/pkg/net/http/pprof/#pkg-overview) å·¥å…·ç›´æ¥é›†æˆçš„æ€§èƒ½åˆ†æç«¯ç‚¹ã€‚å¦‚æœæ‚¨å®‰è£…äº†goå·¥å…·å¥—ä»¶ï¼Œåªéœ€è¿è¡Œï¼š

```shell
# memory profiling
$ go tool pprof http://localhost:4151/debug/pprof/heap

# cpu profiling
$ go tool pprof http://localhost:4151/debug/pprof/profile
```

### TLS

å½“`nsqd`é…ç½®äº†`--tls-cert`ä¸`--tls-key`ï¼Œå®¢æˆ·ç«¯å¯ä»¥åå•†å‡çº§ä»–ä»¬çš„TLSè¿æ¥ä»¥å¢å¼ºå®‰å…¨æ€§ã€‚

æ­¤å¤–ï¼Œæ‚¨å¯ä»¥ ä½¿ç”¨`--tls-required`è¦æ±‚å®¢æˆ·ç«¯åå•†TLSï¼ˆè‡ª`nsqd` `v0.2.28+`ï¼‰ã€‚

æ‚¨å¯ä»¥é€šè¿‡`--tls-client-auth-policy`ï¼ˆ`require`æˆ– `require-verify`ï¼‰é…ç½®`nsqd`å®¢æˆ·ç«¯è¯ä¹¦ç­–ç•¥ï¼š

- `require` -å®¢æˆ·å¿…é¡»æä¾›è¯ä¹¦ï¼Œå¦åˆ™è¢«æ‹’ç»
- `require-verify`-å®¢æˆ·å¿…é¡»æ ¹æ®é»˜è®¤çš„CAæˆ–æŒ‡å®šçš„é“¾`--tls-root-ca-file`æä¾›æœ‰æ•ˆçš„è¯ä¹¦ï¼Œå¦åˆ™å°†è¢«æ‹’ç»

è¿™å¯ä»¥ç”¨ä½œå®¢æˆ·ç«¯èº«ä»½éªŒè¯çš„ä¸€ç§å½¢å¼ï¼ˆè‡ª`nsqd` `v0.2.28+`ï¼‰ã€‚

å¦‚æœè¦ä½¿ç”¨opensslç”Ÿæˆæ— å¯†ç çš„è‡ªç­¾åè¯ä¹¦ï¼š

```shell
$ openssl req -x509 -newkey rsa:2048 -keyout key.pem -out cert.pem -days 365 -nodes
```

### AUTH

æ³¨æ„ï¼š `nsqd v0.2.29+`å¯ç”¨

è¦é…ç½®`nsqd`ä¸ºéœ€è¦æˆæƒï¼Œæ‚¨éœ€è¦ä½¿ç”¨`-auth-http-address=host:port` æ¥æŒ‡å®šä¸€ä¸ªç¬¦åˆAuth HTTPåè®®çš„Auth Serverã€‚

æ³¨æ„ï¼šå½“ä½¿ç”¨æˆæƒæ—¶ï¼ŒæœŸæœ›åªæœ‰`nsqd`TCPåè®®å…¬å¼€ç»™å¤–éƒ¨å®¢æˆ·ç«¯ï¼Œè€Œä¸æ˜¯HTTP(S)ç«¯ç‚¹ã€‚è¯·å‚é˜…ä»¥ä¸‹æœ‰å…³ä½¿ç”¨authå‘å®¢æˆ·ç«¯å…¬å¼€ç»Ÿè®¡ä¿¡æ¯å’ŒæŸ¥æ‰¾çš„æ³¨é‡Šã€‚

èº«ä»½éªŒè¯æœåŠ¡å™¨å¿…é¡»æ¥å—ä»¥ä¸‹HTTPè¯·æ±‚ï¼š

```shell
/auth?remote_ip=...&tls=...&auth_secret=...
```

ç„¶åè¿”å›ä»¥ä¸‹æ ¼å¼çš„å“åº”ï¼š

```shell
{
  "ttl": 3600,
  "identity": "username",
  "identity_url": "https://....",
  "authorizations": [
    {
      "permissions": [
        "subscribe",
        "publish"
      ],
      "topic": ".*",
      "channels": [
        ".*"
      ]
    }
  ]
}
```

è¯·æ³¨æ„ï¼Œä¸»é¢˜å’Œé¢‘é“å­—ç¬¦ä¸²å¿…é¡»æ˜¯æ­£åˆ™è¡¨è¾¾å¼`nsqd`æ‰èƒ½åº”ç”¨æƒé™ã€‚`nsqd`å°†åœ¨TTLæŒç»­æ—¶é—´å†…ç¼“å­˜å“åº”ï¼Œå¹¶åœ¨è¯¥æ—¶é—´é—´éš”å†…é‡æ–°è¯·æ±‚æˆæƒã€‚

é¢„æœŸåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒTLSå°†ä½¿ç”¨æˆæƒæ¥ä¿éšœä»å®¢æˆ·ç«¯ä¼ é€’åˆ°`nsqd`çš„æ•æ„Ÿä¿¡æ¯åŠ å¯†ä¼ é€’ã€‚`nsqd`å’ŒAuth Serverä¹‹é—´çš„é€šä¿¡åº”è¯¥é€šè¿‡å—ä¿¡ä»»çš„ç½‘ç»œè¿›è¡Œï¼ˆå¹¶ä¸”ä¸ä¼šè¿›è¡ŒåŠ å¯†ï¼‰ã€‚å¦‚æœAuth Serverä»…åŸºäºè¿œç¨‹IPä¿¡æ¯è¿›è¡Œèº«ä»½éªŒè¯é€‰æ‹©ï¼Œåˆ™å®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨å ä½ç¬¦å­—ç¬¦ä¸²ï¼ˆå¦‚`.`ï¼‰æ¥ä½œä¸º`AUTH`å‘½ä»¤ä¸»ä½“(`body`)ã€‚

ä¸€ä¸ªAuth Serverç¤ºä¾‹æ˜¯[pynsqauthd](https://github.com/jehiah/nsqauth-contrib#pynsqauthd)ã€‚

å¯ä»¥åœ¨[nsqauthfilterä¸­](https://github.com/jehiah/nsqauth-contrib#nsqauthfilter)æ‰¾åˆ°ä¸€ä¸ªå¸®åŠ©æœåŠ¡å™¨ï¼Œè¯¥æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å…¬å¼€äº†é€šè¿‡Auth Serveræƒé™è¿‡æ»¤çš„`nsqlookupd`å’Œ`nsqd` `/stats`æ•°æ®ã€‚

ä½¿ç”¨å‘½ä»¤è¡Œå®ç”¨ç¨‹åºæ—¶ï¼Œå¯ä»¥é€šè¿‡`--reader-opt`æ ‡å¿—ä½¿ç”¨æˆæƒã€‚

```shell
$ nsq_tail ... -reader-opt="tls_v1,true" -reader-opt="auth_secret,$SECRET"
```

### ç«¯åˆ°ç«¯å¤„ç†å»¶è¿Ÿ

æ‚¨å¯ä»¥é€‰æ‹©ä½¿ç”¨`--e2e-processing-latency-percentile`æ ‡å¿—é…ç½®`nsqd`æ¥æ”¶é›†å’Œå‘èµ·å¯é…ç½®ç™¾åˆ†æ¯”çš„ç«¯åˆ°ç«¯æ¶ˆæ¯å¤„ç†å»¶è¿Ÿã€‚

ä½¿ç”¨*[ã€Šæ•°æ®æµä¸Šæœ‰ååˆ†ä½æ•°çš„æœ‰æ•ˆè®¡ç®—ã€‹](https://www.cs.rutgers.edu/~muthu/bquant.pdf)*æ‰€è¿°çš„æ¦‚ç‡ç™¾åˆ†ä½æŠ€æœ¯æ¥è®¡ç®—å€¼ã€‚æˆ‘ä»¬ä½¿ç”¨ [bmizerany](https://github.com/bmizerany)çš„[perks](https://github.com/bmizerany/perks)åŒ…ï¼Œè¿™ä¸ªåŒ…å®ç°äº†è¯¥ç®—æ³•ã€‚

ä¸ºäº†ä½¿è§†å›¾åå‘äºæœ€è¿‘çš„å¤„ç†è¡Œä¸ºï¼Œæˆ‘ä»¬ä»…ä¿ç•™äº†è¿‡å»`N`åˆ†é’Ÿçš„åˆ†ä½æ•°ä¿¡æ¯ï¼ˆå¯é€šè¿‡`--e2e-processing-latency-window-time`è¿›è¡Œé…ç½®ï¼‰ã€‚åœ¨å†…éƒ¨ï¼Œæˆ‘ä»¬æ¯ä¸ªé€šé“ç»´æŠ¤ä¸¤ä¸ªåˆ†ä½æ•°ï¼Œæ¯ä¸ªåˆ†ä½æ•°å­˜å‚¨`N/2`åˆ†é’Ÿçš„å»¶è¿Ÿæ•°æ®ã€‚æ¯éš”ä¸€ `N/2`åˆ†é’Ÿæˆ‘ä»¬å°±ä¼šé‡ç½®ä¸€ä¸ªåˆ†ä½æ•°ï¼ˆå¹¶å¼€å§‹å‘å…¶ä¸­æ’å…¥æ–°æ•°æ®ï¼‰ã€‚ç”±äºåˆ†ä½æ•°å¯ä»¥åˆå¹¶ï¼Œå› æ­¤ä¼šå¯¼è‡´æ»šåŠ¨çª—å£å˜å¤§ã€‚

ç”±äºæˆ‘ä»¬ä»…åœ¨é€šé“å±‚çº§æ”¶é›†æ•°æ®ï¼Œå› æ­¤å¯¹äºä¸€ä¸ªä¸»é¢˜ï¼Œæˆ‘ä»¬æ±‡æ€»å¹¶åˆå¹¶äº†æ‰€æœ‰é€šé“åˆ†ä½æ•°ã€‚ä»…å½“æ•°æ®åœ¨åŒä¸€`nsqd`å®ä¾‹ä¸Šæ—¶æ‰èƒ½ä½¿ç”¨æ­¤æŠ€æœ¯ã€‚ä½†æ˜¯ï¼Œå½“è·¨`nsqd`ï¼ˆä¾‹å¦‚é€šè¿‡`nsqlookupd`ï¼‰ç´¯ç§¯æ•°æ®æ—¶ï¼Œæˆ‘ä»¬å–æ¯ä¸ª`nsqd`åˆ†ä½æ•°çš„å¹³å‡å€¼ã€‚è€ƒè™‘åˆ°è·¨`nsqd`çš„å»¶è¿Ÿåˆ†å¸ƒï¼Œä¸ºäº†ä¿æŒæŸäº›ç»Ÿè®¡çš„å‡†ç¡®æ€§ï¼Œé™¤äº†å¹³å‡å€¼ä»¥å¤–ï¼Œæˆ‘ä»¬è¿˜æä¾›äº†æœ€å°/æœ€å¤§å€¼ã€‚

æ³¨æ„ï¼šå¦‚æœæ²¡æœ‰æ¶ˆè´¹è€…è¿æ¥ï¼Œåˆ™å°½ç®¡ï¼ˆå¾ˆæ˜æ˜¾ï¼‰æ’é˜Ÿæ¶ˆæ¯çš„ç«¯åˆ°ç«¯å¤„ç†æ—¶é—´åœ¨é€æ¸å¢åŠ ï¼Œä½†å€¼ä»ç„¶æ— æ³•æ›´æ–°ã€‚è¿™æ˜¯å› ä¸ºå¯¹äºæ¥è‡ªå®¢æˆ·ç«¯ç»™å®šçš„æ¶ˆæ¯ï¼Œåªæœ‰å½“`nsqd`æ¥æ”¶äº†`FIN`ä¿¡å·æ—¶ï¼Œæ‰ä¼šè®¡ç®—ç«¯åˆ°ç«¯çš„æŒ‡æ ‡ã€‚å½“æ¶ˆè´¹è€…é‡æ–°è¿æ¥æ—¶ï¼Œè¿™äº›å€¼å°†é€‚å½“è°ƒæ•´ã€‚

### Statsd / Graphiteé›†æˆ

å½“ä½¿ç”¨`--statsd-address`ä¸º [statsd](https://github.com/etsy/statsd)ï¼ˆæˆ–å¦‚statsdemonä¹‹ç±»çš„ä¸€ä¸ªstatsdç«¯å£ï¼‰æŒ‡å®šUDP `<addr>:<port>`æ—¶ï¼Œ`nsqd`å°†æ ¹æ®`--statsd-interval`æŒ‡å®šçš„é—´éš”(é‡è¦ï¼šæ­¤é—´éš”åº” **å§‹ç»ˆ**å°äºæˆ–ç­‰äºstatsdåˆ·æ–°åˆ°graphiteçš„é—´éš”)å®šæœŸå‘statsdæ¨é€æŒ‡æ ‡ã€‚å¯ç”¨æ­¤åŠŸèƒ½åï¼Œå¯ä»¥é…ç½®`nsqadmin`ç›´æ¥æ˜¾ç¤º`graphite`å›¾è¡¨ã€‚

æˆ‘ä»¬å»ºè®®ä½¿ç”¨ä»¥ä¸‹graphiteé…ç½®ï¼ˆä½†åº”æ ¹æ®æ‚¨çš„å¯ç”¨èµ„æºå’Œè¦æ±‚è¯„ä¼°è¿™äº›é€‰æ‹©ï¼‰ã€‚åŒæ ·ï¼Œè¦è®°ä½çš„é‡è¦ä¸€ç‚¹æ˜¯statsdçš„åˆ·æ–°é—´éš”åº”å°äºæˆ–ç­‰äº`storage-schemas.conf`ä¸­çš„æœ€å°æ—¶é—´æ®µï¼Œ å¹¶ä¸”`nsqd`åº”é…ç½®åˆ·æ–°æ—¶é—´ç­‰äºæˆ–å°äº`--statsd-interval`æŒ‡å®šçš„é—´éš”ã€‚

```shell
# storage-schemas.conf
[nsq]
pattern = ^nsq\..*
retentions = 1m:1d,5m:30d,15m:1y

# storage-aggregation.conf
[default_nsq]
pattern = ^nsq\..*
xFilesFactor = 0.2
aggregationMethod = average
```

`nsqd`å®ä¾‹å°†æ¨é€åˆ°å¦‚ä¸‹`statsd`è·¯å¾„ï¼š

```shell
nsq.<nsqd_host>_<nsqd_port>.topic.<topic_name>.backend_depth [gauge]
nsq.<nsqd_host>_<nsqd_port>.topic.<topic_name>.depth [gauge]
nsq.<nsqd_host>_<nsqd_port>.topic.<topic_name>.message_count
nsq.<nsqd_host>_<nsqd_port>.topic.<topic_name>.message_bytes
nsq.<nsqd_host>_<nsqd_port>.topic.<topic_name>.channel.<channel_name>.backend_depth [gauge]
nsq.<nsqd_host>_<nsqd_port>.topic.<topic_name>.channel.<channel_name>.clients [gauge]
nsq.<nsqd_host>_<nsqd_port>.topic.<topic_name>.channel.<channel_name>.deferred_count [gauge]
nsq.<nsqd_host>_<nsqd_port>.topic.<topic_name>.channel.<channel_name>.depth [gauge]
nsq.<nsqd_host>_<nsqd_port>.topic.<topic_name>.channel.<channel_name>.in_flight_count [gauge]
nsq.<nsqd_host>_<nsqd_port>.topic.<topic_name>.channel.<channel_name>.message_count
nsq.<nsqd_host>_<nsqd_port>.topic.<topic_name>.channel.<channel_name>.requeue_count
nsq.<nsqd_host>_<nsqd_port>.topic.<topic_name>.channel.<channel_name>.timeout_count

# if --statsd-mem-stats is enabled
nsq.<nsqd_host>_<nsqd_port>.mem.heap_objects [gauge]
nsq.<nsqd_host>_<nsqd_port>.mem.heap_idle_bytes [gauge]
nsq.<nsqd_host>_<nsqd_port>.mem.heap_in_use_bytes [gauge]
nsq.<nsqd_host>_<nsqd_port>.mem.heap_released_bytes [gauge]
nsq.<nsqd_host>_<nsqd_port>.mem.gc_pause_usec_100 [gauge]
nsq.<nsqd_host>_<nsqd_port>.mem.gc_pause_usec_99 [gauge]
nsq.<nsqd_host>_<nsqd_port>.mem.gc_pause_usec_95 [gauge]
nsq.<nsqd_host>_<nsqd_port>.mem.mem.next_gc_bytes [gauge]
nsq.<nsqd_host>_<nsqd_port>.mem.gc_runs

# if --e2e-processing-latency-percentile is specified, for each percentile
nsq.<nsqd_host>_<nsqd_port>.topic.<topic_name>.e2e_processing_latency_<percent> [gauge]
nsq.<nsqd_host>_<nsqd_port>.topic.<topic_name>.channel.<channel_name>.e2e_processing_latency_<percent> [gauge]
```

## nsqlookupd

`nsqlookupd`æ˜¯ç®¡ç†æ‹“æ‰‘ä¿¡æ¯çš„å®ˆæŠ¤ç¨‹åºã€‚å®¢æˆ·ç«¯é€šè¿‡`nsqlookupd`è¿›è¡ŒæŸ¥è¯¢ä»¥å‘ç°ç‰¹å®šä¸»é¢˜çš„`nsqd`ç”Ÿäº§è€…ï¼ŒåŒæ—¶`nsqd`èŠ‚ç‚¹å¹¿æ’­ä¸»é¢˜å’Œé€šé“ä¿¡æ¯ã€‚

æœ‰ä¸¤ä¸ªæ¥å£ï¼šä¸€ä¸ª`nsqd`ç”¨äºå¹¿æ’­çš„TCPæ¥å£å’Œä¸€ä¸ªå®¢æˆ·ç«¯ç”¨äºæ‰§è¡ŒæœåŠ¡å‘ç°å’Œç®¡ç†æ“ä½œçš„HTTPæ¥å£ã€‚

### å‘½ä»¤è¡Œå‚æ•°é€‰é¡¹

```shell
-broadcast-address string
    address of this lookupd node, (default to the OS hostname) (default "yourhost.local")
-config string
    path to config file
-http-address string
    <addr>:<port> to listen on for HTTP clients (default "0.0.0.0:4161")
-inactive-producer-timeout duration
    duration of time a producer will remain in the active list since its last ping (default 5m0s)
-log-level value
    set log verbosity: debug, info, warn, error, or fatal (default INFO)
-log-prefix string
    log message prefix (default "[nsqlookupd] ")
-tcp-address string
    <addr>:<port> to listen on for TCP clients (default "0.0.0.0:4160")
-tombstone-lifetime duration
    duration of time a producer will remain tombstoned if registration remains (default 45s)
-verbose
    [deprecated] has no effect, use --log-level
-version
    print version string
```

###  HTTP æ¥å£

#### `GET` `/lookup`

è¿”å›ä¸€ä¸ªä¸»é¢˜ç”Ÿäº§è€…åˆ—è¡¨

Params:

```shell
topic - è¦åˆ—å‡ºç”Ÿäº§è€…åˆ—è¡¨çš„ä¸»é¢˜
```

#### `GET` `/topics`

è¿”å›ä¸€ä¸ªæ‰€æœ‰å·²çŸ¥ä¸»é¢˜çš„åˆ—è¡¨

#### `GET` `/channels`

è¿”å›ä¸€ä¸ªä¸»é¢˜çš„æ‰€æœ‰å·²çŸ¥é€šé“åˆ—è¡¨

Params:

```shell
topic - è¦åˆ—å‡ºé€šé“åˆ—è¡¨çš„ä¸»é¢˜
```

#### `GET` `/nodes`

è¿”å›ä¸€ä¸ªæ‰€æœ‰å·²çŸ¥çš„`nsqd`åˆ—è¡¨

#### `POST` `/topic/create`

æ³¨å†Œä¸€ä¸ªä¸»é¢˜åˆ°`nsqlookupd`

Params:

```shell
topic - ä¸»é¢˜åç§°
```

#### `POST` `/topic/delete`

åˆ é™¤ä¸€ä¸ªå­˜åœ¨çš„ä¸»é¢˜

Params:

```shell
topic - è¦åˆ é™¤çš„ä¸»é¢˜
```

#### `POST` `/channel/create`

æ³¨å†Œä¸€ä¸ªé€šé“åˆ°`nsqlookupd`

Params:

```shell
topic - ä¸»é¢˜å
channel - é€šé“å
```

#### `POST` `/channel/delete`

åˆ é™¤ä¸€ä¸ªä¸»é¢˜çš„ä¸€ä¸ªé€šé“

Params:

```shell
topic - ç°å­˜çš„ä¸€ä¸ªä¸»é¢˜
channel - è¦åˆ é™¤çš„ä¸€ä¸ªå·²å­˜åœ¨çš„é€šé“
```

#### `POST` `/topic/tombstone`

> tombstone ä¸çŸ¥å¦‚ä½•ç¿»è¯‘ï¼Œä¿æŒåŸè¯

tombstones ä¸€ä¸ªä¸»é¢˜çš„ç‰¹å®šç”Ÿäº§è€…ã€‚  è¯¦è§[åˆ é™¤å’Œtombstones](https://nsq.io/components/nsqlookupd.html#deletion_tombstones)ã€‚

Params:

```shell
topic - ç°å­˜çš„ä¸»é¢˜
node - è¦tombstone(é€šè¿‡<broadcast_address>:<http_port>è¿›è¡Œé‰´åˆ«)çš„ç”Ÿäº§è€…(nsqd)
```

#### `GET` `/ping`

ç›‘æ§ç«¯ç‚¹ï¼Œåº”å½“è¿”å›`OK`

#### `GET` `/info`

è¿”å›ç‰ˆæœ¬ä¿¡æ¯

### åˆ é™¤å’Œtombstones

å½“ä¸€ä¸ªä¸»é¢˜ä¸å†å…¨å±€ç”Ÿæˆæ—¶ï¼Œä»é›†ç¾¤ä¸­æ¸…é™¤è¯¥ä¿¡æ¯æ˜¯ç›¸å¯¹ç®€å•çš„æ“ä½œã€‚å‡è®¾æ‰€æœ‰æ­£åœ¨ç”Ÿæˆæ¶ˆæ¯çš„åº”ç”¨ç¨‹åºéƒ½å·²å…³é—­ï¼Œåˆ™ä½¿ç”¨`nsqlookupd`å®ä¾‹çš„`/delete_topic`ç«¯ç‚¹æ˜¯å®Œæˆæ“ä½œæ‰€å¿…éœ€çš„ï¼ˆå†…éƒ¨ï¼Œå®ƒå°†æ ‡è¯†ç›¸å…³çš„`nsqd`ç”Ÿäº§è€…å¹¶åœ¨é‚£äº›èŠ‚ç‚¹ä¸Šæ‰§è¡Œé€‚å½“çš„æ“ä½œï¼‰ã€‚

åˆ é™¤å…¨å±€é€šé“çš„è¿‡ç¨‹æ˜¯ç›¸ä¼¼çš„ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯åœ¨`nsqlookupd`å®ä¾‹ä¸Šä½¿ç”¨`/delete_channel`ç«¯ç‚¹ï¼Œå¹¶ä¸”éœ€è¦ç¡®ä¿æ‰€æœ‰è®¢é˜…äº†è¯¥é€šé“çš„æ¶ˆè´¹è€…å‡å·²å…³é—­ã€‚

ç„¶è€Œï¼Œå½“åœ¨èŠ‚ç‚¹çš„å­é›†ä¸Šä¸å†ç”Ÿæˆä¸»é¢˜æ—¶ï¼Œæƒ…å†µå°†å˜å¾—æ›´åŠ å¤æ‚ã€‚ç”±äºæ¶ˆè´¹è€…æŸ¥è¯¢`nsqlookupd`ä»¥åŠè¿æ¥åˆ°æ‰€æœ‰ç”Ÿäº§è€…çš„æ–¹å¼ï¼Œæ‚¨ä¼šè¿›å…¥ç«äº‰çŠ¶æ€å¹¶å°è¯•ä»é›†ç¾¤ä¸­ç§»é™¤ä¿¡æ¯ï¼Œè€Œæ¶ˆè´¹è€…å‘ç°è¯¥èŠ‚ç‚¹å¹¶è¿›è¡Œé‡è¿æ¥ï¼ˆä»è€Œæ¨åŠ¨æ›´æ–°ï¼Œè¯¥èŠ‚ç‚¹ä¸Šä»ä¼šç”Ÿæˆä¸»é¢˜ï¼‰ã€‚åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œè§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨"`tombstones`"ã€‚åœ¨`nsqlookupd`ä¸Šä¸‹æ–‡ä¸­`tombstone`æ˜¯ç‰¹å®šäºç”Ÿäº§è€…çš„ï¼Œå¹¶ä¸”æŒç»­æ—¶é—´å¯é€šè¿‡`--tombstone-lifetime`é…ç½®ã€‚åœ¨è¯¥çª—å£æœŸé—´ï¼Œç”Ÿäº§è€…å°†ä¸ä¼šåœ¨`/lookup`æŸ¥è¯¢ä¸­åˆ—å‡ºï¼Œå…è®¸èŠ‚ç‚¹åˆ é™¤ä¸»é¢˜ï¼Œå¹¶å°†è¯¥ä¿¡æ¯ä¼ æ’­åˆ°`nsqlookupd`ï¼ˆç„¶ååˆ é™¤`tombstoned`ç”Ÿäº§è€…ï¼‰ï¼Œå¹¶é˜²æ­¢ä»»ä½•æ¶ˆè´¹è€…é‡æ–°å‘ç°è¯¥èŠ‚ç‚¹ã€‚

## nsqadmin

`nsqadmin` æ˜¯ä¸€ä¸ªWeb UIï¼Œç”¨äºå®æ—¶æŸ¥çœ‹é›†ç¾¤çš„èšåˆç»Ÿè®¡ä¿¡æ¯å¹¶æ‰§è¡Œå„ç§ç®¡ç†ä»»åŠ¡ã€‚

![img](./images/nsqadmin_screenshot.png)

### å‘½ä»¤è¡Œå‚æ•°é€‰é¡¹

```shell
-acl-http-header string
    HTTP header to check for authenticated admin users (default "X-Forwarded-User")
-admin-user value
    admin user (may be given multiple times; if specified, only these users will be able to perform privileged actions; acl-http-header is used to determine the authenticated user)
-allow-config-from-cidr string
    A CIDR from which to allow HTTP requests to the /config endpoint (default "127.0.0.1/8")
-base-path string
    URL base path (default "/")
-config string
    path to config file
-graphite-url string
    graphite HTTP address
-http-address string
    <addr>:<port> to listen on for HTTP clients (default "0.0.0.0:4171")
-http-client-connect-timeout duration
    timeout for HTTP connect (default 2s)
-http-client-request-timeout duration
    timeout for HTTP request (default 5s)
-http-client-tls-cert string
    path to certificate file for the HTTP client
-http-client-tls-insecure-skip-verify
    configure the HTTP client to skip verification of TLS certificates
-http-client-tls-key string
    path to key file for the HTTP client
-http-client-tls-root-ca-file string
    path to CA file for the HTTP client
-log-level value
    set log verbosity: debug, info, warn, error, or fatal (default INFO)
-log-prefix string
    log message prefix (default "[nsqadmin] ")
-lookupd-http-address value
    lookupd HTTP address (may be given multiple times)
-notification-http-endpoint string
    HTTP endpoint (fully qualified) to which POST notifications of admin actions will be sent
-nsqd-http-address value
    nsqd HTTP address (may be given multiple times)
-proxy-graphite
    proxy HTTP requests to graphite
-statsd-counter-format string
    The counter stats key formatting applied by the implementation of statsd. If no formatting is desired, set this to an empty string. (default "stats.counters.%s.count")
-statsd-gauge-format string
    The gauge stats key formatting applied by the implementation of statsd. If no formatting is desired, set this to an empty string. (default "stats.gauges.%s")
-statsd-interval duration
    time interval nsqd is configured to push to statsd (must match nsqd) (default 1m0s)
-statsd-prefix string
    prefix used for keys sent to statsd (%s for host replacement, must match nsqd) (default "nsq.%s")
-verbose
    [deprecated] has no effect, use --log-level
-version
    print version string
```

### statsd / Graphite é›†æˆ

å½“ä½¿ç”¨`nsqd --statsd-address=...` æ—¶ï¼Œä½ å¯ä»¥æŒ‡å®š`nsqadmin --graphite-url=https://graphite.yourdomain.com`åœ¨`nsqadmin`ä¸­å¯ç”¨graphiteå›¾è¡¨ã€‚å¦‚æœä½¿ç”¨ä¸å¸¦å‰ç¼€é”®çš„`statsd`å…‹éš†ï¼ˆå¦‚[statsdaemon](https://github.com/bitly/statsdaemon)ï¼‰ï¼Œåˆ™è¿˜è¦æŒ‡å®š `--use-statsd-prefix=false`ã€‚

### ç®¡ç†é€šçŸ¥ï¼ˆAdmin Notificationsï¼‰

å¦‚æœè®¾ç½®äº†`--notification-http-endpoint`æ ‡å¿—ï¼Œ`nsqadmin`åœ¨æ¯æ¬¡æ‰§è¡Œç®¡ç†æ“ä½œï¼ˆä¾‹å¦‚æš‚åœé€šé“ï¼‰æ—¶ï¼Œéƒ½ä¼šå‘æŒ‡å®šï¼ˆå®Œå…¨é™å®šï¼‰çš„ç«¯ç‚¹å‘é€POSTè¯·æ±‚ã€‚

è¯·æ±‚çš„æ­£æ–‡åŒ…å«æœ‰å…³æ“ä½œçš„ä¿¡æ¯ï¼ˆé€‚å½“æ—¶å°†çœç•¥æŸäº›å­—æ®µï¼‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```json
{
  "action": "unpause_channel",
  "channel": "mouth",
  "topic": "beer",
  "timestamp": 1357683731,
  "user": "df",
  "user_agent": "Mozilla/5.0 (Macintosh; Iphone 8)",
  "remote_ip": "1.2.3.4:5678",
  "url": "http://nsqadmin.local/api/topics/api_requests/nsq_to_file",
  "via": "localhost"
}
```

å¦‚æœå¯¹`nsqdadmin`çš„è¯·æ±‚ä¸­åŒ…å«HTTPåŸºæœ¬èº«ä»½è®¤è¯çš„ç”¨æˆ·åï¼Œé‚£ä¹ˆ`user`å­—æ®µå°†è¢«å¡«å……ã€‚ä¾‹å¦‚åœ¨httpå¯†ç è®¤è¯æˆ–è€…åœ¨[`oauth2_proxy`](https://github.com/bitly/oauth2_proxy#oauth2_proxy)ä¹‹ä¸‹è¿è¡Œæ—¶ã€‚

æç¤ºï¼šæ‚¨å¯ä»¥é€šè¿‡è®¾ç½®`--notification-http-endpoint`æ¥åˆ›å»ºä¸»é¢˜åç§°ä¸º`admin_actions`çš„NSQç®¡ç†å‘˜æ“ä½œé€šçŸ¥æ•°æ®æµæ¥æŒ‡å‘`nsqd` [HTTP Publish API](https://nsq.io/components/nsqd.html#post-pub)ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ`nsqd`è¿è¡Œåœ¨åŒä¸€èŠ‚ç‚¹ä¸Šï¼Œä½ å¯ä»¥ä½¿ç”¨`--notification-http-endpoint="http://127.0.0.1:4151/put?topic=admin_actions"`

æœ‰ç¤¾åŒºè´¡çŒ®çš„å®ç”¨ç¨‹åº[`nsqadmin2slack`](https://github.com/bensenberner/nsqadmin2slack)å’Œ[`nsqadmin2hipchat`](https://github.com/danielhfrank/nsqadmin2hipchat)å¯ä»¥åˆ†åˆ«å°†æ¶ˆæ¯ä¸­ç»§åˆ°HipChatå’ŒSlackã€‚

æ•è·çš„åŠ¨ä½œæœ‰:

- `create_channel`
- `create_topic`
- `delete_channel`
- `delete_topic`
- `empty_channel`
- `empty_topic`
- `pause_channel`
- `pause_topic`
- `tombstone_topic_producer`
- `unpause_channel`
- `unpause_topic`

### æŒ‡æ ‡

ä¸‹è¿°æŒ‡æ ‡é€šè¿‡`nsqadmin`åœ¨ä¸»é¢˜ã€é€šé“å’Œå®¢æˆ·ç«¯è¿æ¥ä¸Šè¿›è¡Œå…¬å¼€ã€‚

#### æ¶ˆæ¯é˜Ÿåˆ—

- `Depth`: å½“å‰å†…å­˜å’Œç£ç›˜ä¸­çš„æ¶ˆæ¯æ€»æ•° (å³å¾…å‘é€çš„æ¶ˆæ¯"ç§¯å‹")
- `In-Flight`:å½“å‰å·²å‘é€ä½†å°šæœªå®Œæˆï¼ˆ`FIN`ï¼‰ã€é‡æ–°æ’é˜Ÿï¼ˆ`REQ`ï¼‰æˆ–è¶…æ—¶çš„æ¶ˆæ¯æ•°ã€‚
- `Deferred`: å½“å‰å·²é‡æ–°æ’é˜Ÿå’Œæ˜¾å¼æ¨è¿Ÿä½†å°šæ— æ³•ä¼ é€’çš„æ¶ˆæ¯æ•°ã€‚

#### ç»Ÿè®¡

- `Requeued`: ç”±äºè¶…æ—¶æˆ–æ˜¾å¼é‡æ–°æ’é˜Ÿè€Œå¯¼è‡´æ¶ˆæ¯è¢«æ·»åŠ å›é˜Ÿåˆ—çš„æ€»æ¬¡æ•°ã€‚
- `Timed Out`: åœ¨é…ç½®çš„è¶…æ—¶ä¹‹å‰ä»¥åŠæœªæ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯çš„å“åº”ä¹‹åï¼Œæ¶ˆæ¯é‡æ–°æ’é˜Ÿçš„æ€»æ—¶é—´ã€‚
- `Messages`:è‡ªèŠ‚ç‚¹å¯åŠ¨ä»¥æ¥æ”¶åˆ°çš„æ–°æ¶ˆæ¯æ€»æ•°ã€‚
- `Rate`: è¿‡å»ä¸¤ä¸ªç»Ÿè®¡é—´éš”å†…æ–°æ¶ˆæ¯çš„æ¯ç§’é€Ÿç‡ï¼ˆä»…åœ¨å¯ç”¨äº†`graphite`é›†æˆæ—¶å¯ç”¨ï¼‰ã€‚
- `Connections`: å½“å‰è¿æ¥çš„å®¢æˆ·ç«¯æ•°ã€‚

#### å®¢æˆ·ç«¯è¿æ¥

- `Client Host`:å®¢æˆ·ç«¯IDï¼ˆä¸»æœºåï¼‰ä»¥åŠæ‚¬åœ(`on-hover`)è¿æ¥çš„è¿œç¨‹åœ°å€ã€‚
- `Protocol`: NSQåè®®ç‰ˆæœ¬ä»¥åŠå®¢æˆ·ç«¯ç”¨æˆ·ä»£ç†ã€‚
- `Attributes`: TLSå’ŒAUTHè¿æ¥çŠ¶æ€ã€‚
- `NSQd Host`: å®¢æˆ·ç«¯è¿æ¥çš„nsqdèŠ‚ç‚¹åœ°å€ã€‚
- `In-flight`: å½“å‰å·²å‘é€åˆ°æ­¤å®¢æˆ·ç«¯çš„ç­‰å¾…å“åº”çš„æ¶ˆæ¯æ•°ã€‚
- `Ready Count`: æ­¤è¿æ¥ä¸Šå¯å‘é€çš„æœ€å¤§æ¶ˆæ¯æ•°ã€‚ç”±å®¢æˆ·ç«¯çš„`max_in_flight`è®¾ç½®æ§åˆ¶ã€‚
- `Finished`: å®¢æˆ·ç«¯å·²å®Œæˆçš„æ¶ˆæ¯æ€»æ•°ï¼ˆ`FIN`ï¼‰ã€‚
- `Requeued`: å®¢æˆ·ç«¯å·²é‡æ–°æ’é˜Ÿçš„æ¶ˆæ¯æ€»æ•°ï¼ˆ`REQ`ï¼‰ã€‚
- `Messages`: å‘é€åˆ°å®¢æˆ·ç«¯çš„æ¶ˆæ¯æ€»æ•°ã€‚

## utilities

è¿™äº›æ˜¯æœ‰åŠ©äºé€šç”¨åŠŸèƒ½å’Œå¯¹æ•°æ®æµè¿›è¡Œçœå¯Ÿçš„å®ç”¨ç¨‹åºã€‚

- [nsq_stat](https://nsq.io/components/utilities.html#nsq_stat)
- [nsq_tail](https://nsq.io/components/utilities.html#nsq_tail)
- [nsq_to_file](https://nsq.io/components/utilities.html#nsq_to_file)
- [nsq_to_http](https://nsq.io/components/utilities.html#nsq_to_http)
- [nsq_to_nsq](https://nsq.io/components/utilities.html#nsq_to_nsq)
- [to_nsq](https://nsq.io/components/utilities.html#to_nsq)

### nsq_stat

å¯¹æŒ‡å®šä¸»é¢˜/é€šé“çš„æ‰€æœ‰ç”Ÿäº§è€…è¿›è¡Œè½®è¯¢`/stats`ï¼Œå¹¶æ˜¾ç¤ºæ±‡æ€»ç»Ÿè®¡ä¿¡æ¯

```shell
---------------depth---------------+--------------metadata---------------
  total    mem    disk inflt   def |     req     t-o         msgs clients
  24660  24660       0     0    20 |  102688       0    132492418       1
  25001  25001       0     0    20 |  102688       0    132493086       1
  21132  21132       0     0    21 |  102688       0    132493729       1
```

#### å‘½ä»¤è¡Œé€‰é¡¹

```shell
-channel string
    NSQ channel
-count value
    number of reports
-http-client-connect-timeout duration
    timeout for HTTP connect (default 2s)
-http-client-request-timeout duration
    timeout for HTTP request (default 5s)
-interval duration
    duration of time between polling/printing output (default 2s)
-lookupd-http-address value
    lookupd HTTP address (may be given multiple times)
-nsqd-http-address value
    nsqd HTTP address (may be given multiple times)
-topic string
    NSQ topic
-version
    print version
```

### nsq_tail

æ¶ˆè´¹ç‰¹å®šçš„ä¸»é¢˜/é€šé“å¹¶å†™å…¥åˆ°æ ‡å‡†è¾“å‡º(æœ¬ç€`tail(1)`çš„ç²¾ç¥)

#### å‘½ä»¤è¡Œé€‰é¡¹

```shell
-channel string
    NSQ channel
-consumer-opt value
    option to passthrough to nsq.Consumer (may be given multiple times, http://godoc.org/github.com/nsqio/go-nsq#Config)
-lookupd-http-address value
    lookupd HTTP address (may be given multiple times)
-max-in-flight int
    max number of messages to allow in flight (default 200)
-n int
    total messages to show (will wait if starved)
-nsqd-tcp-address value
    nsqd TCP address (may be given multiple times)
-print-topic
    print topic name where message was received
-topic value
    NSQ topic (may be given multiple times)
-version
    print version string
```

### nsq_to_file

æ¶ˆè´¹æŒ‡å®šçš„ä¸»é¢˜/é€šé“å¹¶å†™å…¥åˆ°æ¢è¡Œç¬¦åˆ†éš”çš„æ–‡ä»¶ä¸­ï¼Œå¯ä»¥é€‰æ‹©æ»šåŠ¨ å’Œ/æˆ– å‹ç¼©æ–‡ä»¶ã€‚

#### å‘½ä»¤è¡Œé€‰é¡¹

```shell
-channel string
    nsq channel (default "nsq_to_file")
-consumer-opt value
    option to passthrough to nsq.Consumer (may be given multiple times, http://godoc.org/github.com/nsqio/go-nsq#Config)
-datetime-format string
    strftime compatible format for <DATETIME> in filename format (default "%Y-%m-%d_%H")
-filename-format string
    output filename format (<TOPIC>, <HOST>, <PID>, <DATETIME>, <REV> are replaced. <REV> is increased when file already exists) (default "<TOPIC>.<HOST><REV>.<DATETIME>.log")
-gzip
    gzip output files.
-gzip-level int
    gzip compression level (1-9, 1=BestSpeed, 9=BestCompression) (default 6)
-host-identifier string
    value to output in log filename in place of hostname. <SHORT_HOST> and <HOSTNAME> are valid replacement tokens
-http-client-connect-timeout duration
    timeout for HTTP connect (default 2s)
-http-client-request-timeout duration
    timeout for HTTP request (default 5s)
-log-level string
    set log verbosity: debug, info, warn, error, or fatal (default "info")
-log-prefix string
    log message prefix (default "[nsq_to_file] ")
-lookupd-http-address value
    lookupd HTTP address (may be given multiple times)
-max-in-flight int
    max number of messages to allow in flight (default 200)
-nsqd-tcp-address value
    nsqd TCP address (may be given multiple times)
-output-dir string
    directory to write output files to (default "/tmp")
-rotate-interval duration
    rotate the file every duration
-rotate-size rotate-size
    rotate the file when it grows bigger than rotate-size bytes
-skip-empty-files
    skip writing empty files
-sync-interval duration
    sync file to disk every duration (default 30s)
-topic value
    nsq topic (may be given multiple times)
-topic-pattern string
    only log topics matching the following pattern
-topic-refresh duration
    how frequently the topic list should be refreshed (default 1m0s)
-version
    print version string
-work-dir string
    directory for in-progress files before moving to output-dir
```

### nsq_to_http

æ¶ˆè´¹æŒ‡å®šçš„ä¸»é¢˜/é€šé“ï¼Œå¹¶å‘æŒ‡å®šçš„ç«¯ç‚¹æ‰§è¡ŒHTTPè¯·æ±‚ï¼ˆGET / POSTï¼‰ã€‚

#### å‘½ä»¤è¡Œé€‰é¡¹

```shell
-channel string
    nsq channel (default "nsq_to_http")
-consumer-opt value
    option to passthrough to nsq.Consumer (may be given multiple times, http://godoc.org/github.com/nsqio/go-nsq#Config)
-content-type string
    the Content-Type used for POST requests (default "application/octet-stream")
-get value
    HTTP address to make a GET request to. '%s' will be printf replaced with data (may be given multiple times)
-header value
    Custom header for HTTP requests (may be given multiple times)
-http-client-connect-timeout duration
    timeout for HTTP connect (default 2s)
-http-client-request-timeout duration
    timeout for HTTP request (default 20s)
-lookupd-http-address value
    lookupd HTTP address (may be given multiple times)
-max-in-flight int
    max number of messages to allow in flight (default 200)
-mode string
    the upstream request mode options: round-robin, hostpool (default), epsilon-greedy (default "hostpool")
-n int
    number of concurrent publishers (default 100)
-nsqd-tcp-address value
    nsqd TCP address (may be given multiple times)
-post value
    HTTP address to make a POST request to.  data will be in the body (may be given multiple times)
-sample float
    % of messages to publish (float b/w 0 -> 1) (default 1)
-status-every int
    the # of requests between logging status (per handler), 0 disables (default 250)
-topic string
    nsq topic
-version
    print version string
```

### nsq_to_nsq

æ¶ˆè´¹ç‰¹å®šçš„ä¸»é¢˜/é€šé“ï¼Œå¹¶é€šè¿‡TCPå°†æ¶ˆæ¯é‡æ–°å‘å¸ƒåˆ°ç›®æ ‡`nsqd`ã€‚

#### å‘½ä»¤è¡Œé€‰é¡¹

```shell
-channel string
    nsq channel (default "nsq_to_nsq")
-consumer-opt value
    option to passthrough to nsq.Consumer (may be given multiple times, see http://godoc.org/github.com/nsqio/go-nsq#Config)
-destination-nsqd-tcp-address value
    destination nsqd TCP address (may be given multiple times)
-destination-topic string
    use this destination topic for all consumed topics (default is consumed topic name)
-lookupd-http-address value
    lookupd HTTP address (may be given multiple times)
-max-in-flight int
    max number of messages to allow in flight (default 200)
-mode string
    the upstream request mode options: round-robin, hostpool (default), epsilon-greedy (default "hostpool")
-nsqd-tcp-address value
    nsqd TCP address (may be given multiple times)
-producer-opt value
    option to passthrough to nsq.Producer (may be given multiple times, see http://godoc.org/github.com/nsqio/go-nsq#Config)
-require-json-field string
    for JSON messages: only pass messages that contain this field
-require-json-value string
    for JSON messages: only pass messages in which the required field has this value
-status-every int
    the # of requests between logging status (per destination), 0 disables (default 250)
-topic value
    nsq topic (may be given multiple times)
-version
    print version string
-whitelist-json-field value
    for JSON messages: pass this field (may be given multiple times)
```

### to_nsq

æ¥æ”¶æ ‡å‡†è¾“å…¥æµå¹¶é€šè¿‡æ¢è¡Œç¬¦è¿›è¡Œåˆ†å‰²ï¼ˆé»˜è®¤ï¼‰ï¼Œé€šè¿‡TCPé‡æ–°å‘å¸ƒåˆ°ç›®æ ‡`nsqd`ã€‚

#### å‘½ä»¤è¡Œé€‰é¡¹

```shell
-delimiter string
    character to split input from stdin (default "\n")
-nsqd-tcp-address value
    destination nsqd TCP address (may be given multiple times)
-producer-opt value
    option to passthrough to nsq.Producer (may be given multiple times, http://godoc.org/github.com/nsqio/go-nsq#Config)
-rate int
    Throttle messages to n/second. 0 to disable
-topic string
    NSQ topic to publish to
```

# å®¢æˆ·ç«¯

## å®¢æˆ·ç«¯åº“

è¯¥è¡¨ä¸­çš„ä¿¡æ¯æ˜¯å¦è¿‡æ—¶ï¼Ÿæ‚¨æ˜¯å¦åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨è¿™äº›å®¢æˆ·ç«¯åº“ä¹‹ä¸€ï¼Ÿåœ¨[é‚®ä»¶åˆ—è¡¨](https://groups.google.com/forum/#!forum/nsq-users)æˆ–Twitter [@ imsnakes](https://twitter.com/imsnakes) / [@ jehiah](https://twitter.com/jehiah)ä¸Šå‘Šè¯‰æˆ‘ä»¬ã€‚

| Name                                                         | Language                              | SUB  | PUB  | Discovery | Backoff | TLS  | Snappy | Sampling | AUTH | Notes        |
| :----------------------------------------------------------- | :------------------------------------ | :--- | :--- | :-------- | :------ | :--- | :----- | :------- | :--- | :----------- |
| [nsqd](https://nsq.io/components/nsqd.html#post-pub)         | HTTP                                  |     | âœ“    |          |        |     |       |         |     | **built-in** |
| [go-nsq](https://github.com/nsqio/go-nsq)                    | Go                                    | âœ“    | âœ“    | âœ“         | âœ“       | âœ“    | âœ“      | âœ“        | âœ“    | **official** |
| [pynsq](https://github.com/nsqio/pynsq)                      | Python                                | âœ“    | âœ“    | âœ“         | âœ“       | âœ“    | âœ“      | âœ“        | âœ“    | **official** |
| [nsqjs](https://github.com/dudleycarr/nsqjs)                 | JavaScript                            | âœ“    | âœ“    | âœ“         | âœ“       | âœ“    | âœ“      | âœ“        | âœ“    | **official** |
| [elixir_nsq](https://github.com/wistia/elixir_nsq)           | Elixir                                | âœ“    | âœ“    | âœ“         | âœ“       | âœ“    |      | âœ“        | âœ“    |             |
| [ensq](https://github.com/project-fifo/ensq)                 | Erlang                                | âœ“    | âœ“    | âœ“         | âœ“       |     |       |         |     |             |
| [nsq-j](https://github.com/sproutsocial/nsq-j)               | Java                                  | âœ“    | âœ“    | âœ“         | âœ“       | âœ“    | âœ“      | âœ“        | âœ“    |             |
| [JavaNSQClient](https://github.com/brainlag/JavaNSQClient)   | Java                                  | âœ“    | âœ“    | âœ“         | âœ“       | âœ“    | âœ“      | âœ“        |     |             |
| [TrendrrNSQClient](https://github.com/nsqio/TrendrrNSQClient) | Java                                  | âœ“    | âœ“    | âœ“         |        |     |       |         |     |             |
| [nsqjava](https://github.com/domwong/nsqjava)                | Java                                  | âœ“    | âœ“    |          |        |     |       |         |     |             |
| [nsq.js](https://github.com/segmentio/nsq.js)                | JavaScript                            |   âœ“   |  âœ“    |    âœ“       |         |      |        |          |      |              |
| [node-nsqueue](https://github.com/brianc/node-nsqueue)       | JavaScript                            |   âœ“   |  âœ“    |           |         |      |        |          |      |              |
| [knsq](https://github.com/abusix/knsq)                       | Kotlin                                |   âœ“   |  âœ“    |    âœ“       |    âœ“     |  âœ“    |   âœ“     |    âœ“      |   âœ“   |              |
| [NsqSharp](https://github.com/judwhite/NsqSharp)             | .NET                                  |   âœ“   |  âœ“    |    âœ“       |    âœ“     |  âœ“    |   âœ“     |    âœ“      |   âœ“   |              |
| [php-nsq](https://github.com/yunnian/php-nsq)                | PHP                                   |   âœ“   |  âœ“    |    âœ“       |         |      |        |          |      |              |
| [phpnsq](https://github.com/wk30/phpnsq)                     | PHP                                   |   âœ“   |  âœ“    |    âœ“       |         |      |        |          |   âœ“   |              |
| [nsq-py](https://github.com/dlecocq/nsq-py)                  | Python                                |   âœ“   |  âœ“    |    âœ“       |    âœ“     |  âœ“    |   âœ“     |    âœ“      |   âœ“   |              |
| [gnsq](https://github.com/wtolson/gnsq)                      | Python                                |   âœ“   |  âœ“    |    âœ“       |    âœ“     |  âœ“    |   âœ“     |    âœ“      |   âœ“   |              |
| [krakow](https://github.com/chrisroberts/krakow)             | Ruby                                  |   âœ“   |  âœ“    |    âœ“       |    âœ“     |  âœ“    |   âœ“     |    âœ“      |      |              |
| [ruby_nsq](https://github.com/DaDDyE/ruby_nsq)               | Ruby                                  |   âœ“   |  âœ“    |           |    âœ“     |      |        |          |      |              |
| [evnsq](https://github.com/Qihoo360/evpp/tree/master/apps/evnsq) | C++                                   |   âœ“   |  âœ“    |    âœ“       |         |      |        |          |   âœ“   |              |
| [libnsq](https://github.com/nsqio/libnsq)                    | C                                     |   âœ“   |      |           |         |      |        |          |      | **official** |
| [hsnsq](https://github.com/gamelost/hsnsq)                   | Haskell                               |   âœ“   |  âœ“    |           |         |      |        |          |      |              |
| [nsq-java](https://github.com/nsqio/nsq-java)                | Java                                  |   âœ“   |  âœ“    |    âœ“       |         |      |        |          |      |              |
| [nsq-client](https://github.com/jmanero/nsq-client)          | JavaScript                            |   âœ“   |  âœ“    |           |         |      |        |          |      |              |
| [NSQnet](https://github.com/ClothesHorse/NSQnet)             | .NET                                  |   âœ“   |  âœ“    |    âœ“       |         |      |        |          |      |              |
| [perl-anyevent-nsq](https://github.com/melo/perl-anyevent-nsq) | Perl                                  |   âœ“   |  âœ“    |    âœ“       |         |      |        |          |      |              |
| [NsqSpinner](https://github.com/dsoprea/NsqSpinner)          | Python                                |   âœ“   |  âœ“    |    âœ“       |    âœ“     |  âœ“    |   âœ“     |    âœ“      |      |              |
| [nsq-ruby](https://github.com/wistia/nsq-ruby)               | Ruby                                  |   âœ“   |  âœ“    |    âœ“       |         |      |        |          |      |              |
| [uvnsq](https://github.com/wlgq2/uvnsq)                      | C++11                                 |   âœ“   |  âœ“    |    âœ“       |         |      |        |          |      |              |
| [nsq-clojure](https://github.com/thieman/nsq-clojure)        | Clojure                               |      |      |           |         |      |        |          |      |              |
| [nsqie](https://github.com/anvie/nsqie)                      | Scala                                 |   âœ“   |      |    âœ“       |         |      |        |          |      |              |
| [nodensq](https://github.com/phillro/nodensq)                | JavaScript                            |   âœ“   |  âœ“    |           |         |      |        |          |      |              |
| [nsqueue](https://github.com/wisespace-io/nsqueue)           | Rust                                  |   âœ“   |  âœ“    |           |         |      |        |          |      |              |
| [asyncnsq](https://github.com/aohan237/asyncnsq)             | Python                                |   âœ“   |  âœ“    |           |         |      |        |          |      |              |
| [nsq-ocaml](https://github.com/ryanslade/nsq-ocaml)          | OCaml                                 |   âœ“   |  âœ“    |    âœ“       |    âœ“     |      |        |          |      |              |
| [node-red-contrib-nsq](https://github.com/adamgoose/node-red-contrib-nsq) | [NodeRED](https://nodered.org/) Nodes |   âœ“   |  âœ“    |           |         |      |        |          |      |              |
| [asyncnsq](https://github.com/aohan237/asyncnsq-rs)          | Rust                                  |   âœ“   |  âœ“    |    âœ“       |         |      |        |          |      |              |
| [tokio-nsq](https://github.com/harporoeder/tokio-nsq)        | Rust                                  |   âœ“   |  âœ“    |    âœ“       |    âœ“     |  âœ“    |   âœ“     |    âœ“      |   âœ“   |              |
| [ansq](https://github.com/list-family/ansq)                  | Python                                |   âœ“   |  âœ“    |           |         |      |        |    âœ“      |   âœ“   |              |

## æ„å»ºå®¢æˆ·ç«¯åº“

NSQçš„è®¾è®¡å°†å¾ˆå¤šè´£ä»»æ¨ç»™äº†å®¢æˆ·ç«¯åº“ï¼Œä»¥ç»´æŒæ•´ä¸ªé›†ç¾¤çš„å¥å£®æ€§å’Œæ€§èƒ½ã€‚

æœ¬æŒ‡å—è¯•å›¾æ¦‚è¿°è¡Œä¸ºè‰¯å¥½çš„å®¢æˆ·ç«¯åº“éœ€è¦å±¥è¡Œçš„å„ç§èŒè´£ã€‚å› ä¸ºå‘å¸ƒåˆ°`nsqd`æ˜¯å¾®ä¸è¶³é“çš„ï¼ˆåªæ˜¯å‘é€HTTP POSTè¯·æ±‚åˆ°`/put`ç«¯ç‚¹ ï¼‰ï¼Œæ‰€ä»¥æœ¬æ–‡æ¡£ä¸»è¦é’ˆå¯¹æ¶ˆè´¹è€…ã€‚

é€šè¿‡è®¾å®šè¿™äº›æœŸæœ›ï¼Œæˆ‘ä»¬å¸Œæœ›ä¸ºNSQç”¨æˆ·å®ç°è·¨è¯­è¨€ä¸€è‡´æ€§æä¾›åŸºç¡€ã€‚

### æ¦‚è¿°

1. [é…ç½®](https://nsq.io/clients/building_client_libraries.html#configuration)
2. [å‘ç°](https://nsq.io/clients/building_client_libraries.html#discovery)ï¼ˆå¯é€‰ï¼‰
3. [è¿æ¥å¤„ç†](https://nsq.io/clients/building_client_libraries.html#connection_handling)
4. [åŠŸèƒ½åå•†](https://nsq.io/clients/building_client_libraries.html#feature_negotiation)
5. [æ•°æ®æµ/å¿ƒè·³](https://nsq.io/clients/building_client_libraries.html#data_flow)
6. [æ¶ˆæ¯å¤„ç†](https://nsq.io/clients/building_client_libraries.html#message_handling)
7. [RDYçŠ¶æ€](https://nsq.io/clients/building_client_libraries.html#rdy_state)
8. [backoff](https://nsq.io/clients/building_client_libraries.html#backoff)
9. [åŠ å¯†/å‹ç¼©](https://nsq.io/clients/building_client_libraries.html#encryptioncompression)

### é…ç½®

åœ¨è¾ƒé«˜çš„å±‚æ¬¡ä¸Šï¼Œæˆ‘ä»¬å…³äºé…ç½®çš„ç†å¿µæ˜¯å°†ç³»ç»Ÿè®¾è®¡ä¸ºå…·æœ‰æ”¯æŒä¸åŒå·¥ä½œè´Ÿè½½çš„çµæ´»æ€§ï¼Œä½¿ç”¨åˆç†çš„é»˜è®¤å€¼ï¼ˆå¼€ç®±å³ç”¨ï¼‰è¿è¡Œï¼Œå¹¶æœ€å¤§ç¨‹åº¦åœ°å‡å°‘æ‹¨å·æ¬¡æ•°ã€‚

æ¶ˆè´¹è€…é€šè¿‡TCPè¿æ¥åˆ°`nsqd`å®ä¾‹ï¼Œå¹¶åœ¨ä¸€ä¸ªé€šé“(`channel`)ä¸Šè®¢é˜…ä¸»é¢˜(`topic`)ã€‚æ¯ä¸ªè¿æ¥åªèƒ½è®¢é˜…ä¸€ä¸ªä¸»é¢˜ï¼Œå› æ­¤éœ€è¦ç›¸åº”åœ°ç»„ç»‡å¤šä¸ªä¸»é¢˜çš„æ¶ˆè´¹ã€‚

ä½¿ç”¨`nsqlookupd`çš„æœåŠ¡å‘ç°æ˜¯å¯é€‰çš„ï¼Œæ‰€ä»¥å®¢æˆ·ç«¯åº“åº”è¯¥æ”¯æŒé…ç½®ä¸€ä¸ªæ¶ˆè´¹è€…å¯ä»¥ç›´æ¥è¿æ¥åˆ°ä¸€ä¸ªæˆ–å¤šä¸ª`nsqd`å®ä¾‹æˆ–è€…é…ç½®ä¸ºè½®è¯¢ä¸€ä¸ªæˆ–å¤šä¸ª`nsqlookupd`å®ä¾‹ã€‚å½“æ¶ˆè´¹è€…é…ç½®ä¸ºè½®è¯¢`nsqlookupd`æ—¶ï¼Œè½®è¯¢é—´éš”åº”è¯¥æ˜¯å¯é…ç½®çš„ã€‚æ­¤å¤–ï¼Œå…¸å‹çš„NSQéƒ¨ç½²æ˜¯åœ¨å…·æœ‰è®¸å¤šç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œå› æ­¤å®¢æˆ·ç«¯åº“åº”è‡ªåŠ¨æ·»åŠ åŸºäºé…ç½®å€¼çš„éšæœºç™¾åˆ†æ¯”æŠ–åŠ¨(`jitter`)ã€‚è¿™å°†æœ‰åŠ©äºé¿å…äººæ½®æ±¹æ¶Œçš„è”ç³»ã€‚æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§[Discovery](https://nsq.io/clients/building_client_libraries.html#discovery)ã€‚

å¯¹æ¶ˆè´¹è€…è€Œè¨€ï¼Œä¸€ä¸ªé‡è¦çš„æ€§èƒ½ç“¶é¢ˆæ˜¯`nsqd` æœŸæœ›å¾—åˆ°å“åº”ä¹‹å‰å®ƒå¯ä»¥æ¥æ”¶çš„æ¶ˆæ¯æ•°ã€‚è¿™ç§æµæ°´çº¿(`pipelining`)ä¾¿äºç¼“å†²ã€æ‰¹å¤„ç†å’Œå¼‚æ­¥æ¶ˆæ¯å¤„ç†ã€‚æŒ‰ç…§æƒ¯ä¾‹ï¼Œè¯¥å€¼è¢«ç§°ä¸º`max_in_flight`ï¼Œå¹¶ä¸”å½±å“`RDY`çŠ¶æ€å¦‚ä½•ç®¡ç†ã€‚æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§[RDYçŠ¶æ€](https://nsq.io/clients/building_client_libraries.html#rdy_state)ã€‚

ä½œä¸ºä¸€ä¸ªæ—¨åœ¨å¦¥å–„å¤„ç†æ•…éšœçš„ç³»ç»Ÿï¼ŒæœŸæœ›å®¢æˆ·ç«¯åº“å¯¹å¤±è´¥çš„æ¶ˆæ¯å®ç°é‡è¯•å¤„ç†ï¼Œå¹¶æä¾›æ ¹æ®æ¯æ¡æ¶ˆæ¯çš„å°è¯•æ¬¡æ•°è¿™ä¸€é€‰é¡¹æ¥é™åˆ¶è¯¥è¡Œä¸ºã€‚æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§[æ¶ˆæ¯å¤„ç†](https://nsq.io/clients/building_client_libraries.html#message_handling)ã€‚

ç›¸å…³åœ°ï¼Œå½“æ¶ˆæ¯å¤„ç†å¤±è´¥æ—¶ï¼ŒæœŸæœ›å®¢æˆ·ç«¯åº“è‡ªåŠ¨å¤„ç†æ¶ˆæ¯çš„é‡æ–°æ’é˜Ÿã€‚NSQæ”¯æŒéšç€`REQ`å‘½ä»¤ä¸€èµ·å‘é€ä¸€ä¸ªå»¶è¿Ÿã€‚æœŸæœ›å®¢æˆ·ç«¯åº“æä¾›æœ‰å…³æ­¤å»¶è¿Ÿçš„é€‰é¡¹ï¼šåˆå§‹è®¾ç½®ï¼ˆå¯¹äºç¬¬ä¸€æ¬¡å¤±è´¥ï¼‰ä»¥åŠå¯¹äºéšåçš„å¤±è´¥åº”å¦‚ä½•æ›´æ”¹ã€‚æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§ [Backoff](https://nsq.io/clients/building_client_libraries.html#backoff)ã€‚

æœ€é‡è¦çš„æ˜¯ï¼Œå®¢æˆ·ç«¯åº“åº”æ”¯æŒæŸç§æ–¹æ³•ï¼Œç”¨äºé…ç½®æ¶ˆæ¯å¤„ç†çš„å›è°ƒã€‚è¿™äº›å›è°ƒçš„ç­¾ååº”è¯¥ç®€å•ï¼Œé€šå¸¸æ¥æ”¶å•ä¸ªå‚æ•°ï¼ˆä¸€ä¸ª"æ¶ˆæ¯å¯¹è±¡"çš„å®ä¾‹ï¼‰ã€‚

### å‘ç°

NSQçš„é‡è¦ç»„æˆéƒ¨åˆ†æ˜¯`nsqlookupd`ï¼Œå®ƒä¸ºæ¶ˆè´¹è€…æä¾›å‘ç°æœåŠ¡ï¼Œä»¥å®šä½åœ¨è¿è¡Œæ—¶æä¾›ç»™å®šä¸»é¢˜çš„`nsqd`ã€‚

å°½ç®¡æ˜¯å¯é€‰çš„ï¼Œä½†ä½¿ç”¨`nsqlookupd`ä¼šå¤§å¤§å‡å°‘ç»´æŠ¤å’Œæ‰©å±•å¤§å‹åˆ†å¸ƒå¼NSQé›†ç¾¤æ‰€éœ€çš„é…ç½®é‡ã€‚

å½“æ¶ˆè´¹è€…ä½¿ç”¨`nsqlookupd`å‘ç°æœåŠ¡æ—¶ï¼Œå®¢æˆ·ç«¯åº“åº”ç®¡ç†æ‰€æœ‰`nsqlookupd`å®ä¾‹çš„è½®è¯¢è¿‡ç¨‹ï¼Œä»¥è·å–æœ€æ–°æ‰€å…³æ³¨ä¸»é¢˜çš„`nsqd`é›†åˆï¼Œå¹¶åº”å½“ç®¡ç†è¿™äº›`nsqd`å®ä¾‹çš„è¿æ¥ã€‚

æŸ¥è¯¢`nsqlookupd`å®ä¾‹å¾ˆç®€å•ã€‚å°†æ¶ˆè´¹è€…å°è¯•å‘ç°çš„ä¸»é¢˜ä½œä¸ºæŸ¥è¯¢å‚æ•°æ‰§è¡Œä¸€ä¸ªHTTPè¯·æ±‚åˆ°æŸ¥è¯¢ç«¯ç‚¹(ä¾‹å¦‚`/lookup?topic=clicks`)ã€‚å“åº”æ ¼å¼ä¸º`JSON`ï¼š

```shell
{
    "channels": ["archive", "science", "metrics"],
    "producers": [
        {
            "broadcast_address": "clicksapi01.routable.domain.net",
            "hostname": "clicksapi01.domain.net",
            "remote_address": "172.31.27.114:51996",
            "tcp_port": 4150,
            "http_port": 4151,
            "version": "1.0.0-compat"
        },
        {
            "broadcast_address": "clicksapi02.routable.domain.net",
            "hostname": "clicksapi02.domain.net",
            "remote_address": "172.31.34.29:14340",
            "tcp_port": 4150,
            "http_port": 4151,
            "version": "1.0.0-compat"
        }
    ]
}
```

`broadcast_address`å’Œ`tcp_port`ç”¨æ¥è¿æ¥åˆ°`nsqd`ã€‚å› ä¸ºæ ¹æ®è®¾è®¡ï¼Œ `nsqlookupd`å®ä¾‹ä¸å…±äº«æˆ–åè°ƒå®ƒä»¬çš„æ•°æ®ï¼Œæ‰€ä»¥å®¢æˆ·ç«¯åº“åº”åˆå¹¶ä»æ‰€æœ‰`nsqlookupd`æŸ¥è¯¢ä¸­æ¥æ”¶åˆ°çš„åˆ—è¡¨ï¼Œä»¥æ„å»ºæœ€ç»ˆè¦è¿æ¥çš„`nsqd`åˆ—è¡¨ã€‚`broadcast_address:tcp_port`çš„ç»„åˆåº”ä½œä¸ºåˆå¹¶çš„å”¯ä¸€é”®ã€‚

åº”è¯¥ä½¿ç”¨å®šæœŸè®¡æ—¶å™¨é‡å¤è½®è¯¢å·²é…ç½®çš„`nsqlookupd`ï¼Œä»¥ä¾¿æ¶ˆè´¹è€…è‡ªåŠ¨å‘ç°æ–°çš„`nsqd`ã€‚å®¢æˆ·ç«¯åº“åº”è‡ªåŠ¨åˆå§‹åŒ–æ‰€æœ‰æ–°å‘ç°å®ä¾‹çš„è¿æ¥ã€‚

å½“å®¢æˆ·ç«¯åº“æ‰§è¡Œå¼€å§‹æ—¶ï¼Œåº”é€šè¿‡å¯åŠ¨å·²é…ç½®çš„`nsqlookupd`å®ä¾‹çš„ä¸€ç»„åˆå§‹è¯·æ±‚æ¥å¼•å¯¼æ­¤è½®è¯¢è¿‡ç¨‹ã€‚

### è¿æ¥å¤„ç†

ä¸€æ—¦æ¶ˆè´¹è€…è¿æ¥åˆ°`nsqd`ï¼ˆé€šè¿‡å‘ç°æœåŠ¡æˆ–è€…æ‰‹åŠ¨é…ç½®ï¼‰ï¼Œå®ƒåº”å½“æ‰“å¼€ä¸€ä¸ªTCPè¿æ¥åˆ°`broadcast_address:port`.å¯¹äºæ¶ˆè´¹è€…æƒ³è¦è®¢é˜…çš„æ¯ä¸ªä¸»é¢˜ï¼Œåº”è¯¥ä¸ºæ¯ä¸ªä¸»é¢˜å»ºç«‹å•ç‹¬çš„TCPè¿æ¥åˆ°`nsqd` ã€‚

å½“è¿æ¥åˆ°`nsqd`å®ä¾‹æ—¶ï¼Œå®¢æˆ·ç«¯åº“åº”æŒ‰é¡ºåºå‘é€ä»¥ä¸‹æ•°æ®ï¼š

1. é­”æœ¯æ ‡è¯†ç¬¦(`the magic identifier`)
2. ä¸€ä¸ª`IDENTIFY`å‘½ä»¤(ä»¥åŠè½½è·)å’Œè¯»/éªŒè¯å“åº”ï¼ˆå‚è§[åŠŸèƒ½åå•†](https://nsq.io/clients/building_client_libraries.html#feature_negotiation)ï¼‰
3. ä¸€ä¸ª`SUB`å‘½ä»¤(æŒ‡å®šæœŸæœ›çš„ä¸»é¢˜)ä»¥åŠè¯»/éªŒè¯å“åº”
4. ä¸€ä¸ªåˆå§‹ä¸º1çš„`RDY`çŠ¶æ€è®¡æ•°ï¼ˆå‚è§[RDY çŠ¶æ€](https://nsq.io/clients/building_client_libraries.html#rdy_state)ï¼‰

ï¼ˆæœ‰å…³è¯¥åè®®çš„åº•å±‚ç»†èŠ‚ï¼Œè¯·å‚é˜…[è§„èŒƒ](https://nsq.io/clients/tcp_protocol_spec.html)ï¼‰

#### é‡æ–°è¿æ¥

å®¢æˆ·ç«¯åº“åº”è‡ªåŠ¨å¤„ç†é‡æ–°è¿æ¥ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

- å¦‚æœä¸ºæ¶ˆè´¹è€…é…ç½®äº†ç‰¹å®šçš„`nsqd`å®ä¾‹åˆ—è¡¨ï¼Œåˆ™åº”é€šè¿‡æŒ‡æ•°é€€é¿(`exponential backoff`)çš„æ–¹å¼å»¶è¿Ÿé‡æ–°å°è¯•æ¥å¤„ç†é‡æ–°è¿æ¥ï¼ˆå³å°è¯•ä»¥8sï¼Œ16sï¼Œ32sç­‰è¿›è¡Œé‡æ–°è¿æ¥ï¼Œç›´åˆ°æœ€å¤§æ¬¡æ•°ï¼‰ã€‚
- å¦‚æœå°†æ¶ˆè´¹è€…é…ç½®ä¸ºé€šè¿‡`nsqlookupd`æ¥å‘ç°å®ä¾‹ï¼Œåˆ™åº”æ ¹æ®è½®è¯¢é—´éš”è‡ªåŠ¨å¤„ç†é‡æ–°è¿æ¥ï¼ˆå³å¦‚æœæ¶ˆè´¹è€…ä¸`nsqd`æ–­å¼€è¿æ¥ï¼Œåˆ™å®¢æˆ·ç«¯åº“åº”ä»…åœ¨éšåçš„`nsqlookupd`è½®è¯¢å›åˆä¸­å°è¯•é‡æ–°è¿æ¥å·²å‘ç°çš„å®ä¾‹ï¼‰ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿æ¶ˆè´¹è€…å¯ä»¥äº†è§£åˆ° æ‹“æ‰‘ä¸­å¼•å…¥çš„`nsqd`ä»¥åŠå·²åˆ é™¤ï¼ˆæˆ–å¤±è´¥ï¼‰çš„`nsqd`ã€‚

### åŠŸèƒ½åå•†

`IDENTIFY`å‘½ä»¤å¯ç”¨äºè®¾ç½®`nsqd`ç«¯å…ƒæ•°æ®ï¼Œä¿®æ”¹å®¢æˆ·ç«¯è®¾ç½®ä»¥åŠåå•†åŠŸèƒ½ã€‚å®ƒæ»¡è¶³ä¸¤ä¸ªéœ€æ±‚ï¼š

1. åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯å¸Œæœ›ä¿®æ”¹`nsqd`ä¸å…¶äº¤äº’çš„æ–¹å¼ï¼ˆä¾‹å¦‚ï¼Œä¿®æ”¹å®¢æˆ·ç«¯çš„å¿ƒè·³é—´éš”å¹¶å¯ç”¨å‹ç¼©ï¼ŒTLSï¼Œè¾“å‡ºç¼“å†²ç­‰ã€‚æœ‰å…³å®Œæ•´åˆ—è¡¨ï¼Œè¯·å‚è§[è§„èŒƒ](https://nsq.io/clients/tcp_protocol_spec.html)ï¼‰
2. `nsqd`ä½¿ç”¨`JSON`è´Ÿè½½æ¥å“åº”`IDENTIFY`å‘½ä»¤ï¼Œè¯¥è´Ÿè½½åŒ…å«é‡è¦çš„æœåŠ¡å™¨ç«¯é…ç½®å€¼ï¼Œå®¢æˆ·ç«¯åœ¨ä¸`nsqd`å®ä¾‹è¿›è¡Œäº¤äº’æ—¶åº”éµå¾ªè¿™äº›é…ç½®å€¼ã€‚

è¿æ¥åï¼ŒåŸºäºç”¨æˆ·çš„é…ç½®ï¼Œå®¢æˆ·ç«¯åº“åº”å‘é€`IDENTIFY` å‘½ä»¤ï¼Œå…¶bodyä¸ºä¸€ä¸ª`JSON`è´Ÿè½½ï¼š

```shell
{
    "client_id": "metrics_increment",
    "hostname": "app01.bitly.net",
    "heartbeat_interval": 30000,
    "feature_negotiation": true
}
```

`feature_negotiation`å­—æ®µè¡¨ç¤ºå®¢æˆ·ç«¯å¯ä»¥æ¥å—`JSON`è´Ÿè½½ä½œä¸ºè¿”å›ã€‚`client_id`å’Œ`hostname`æ˜¯ä»»æ„çš„æ–‡æœ¬å­—æ®µï¼Œ`nsqd`ï¼ˆå’Œ`nsqadmin`ï¼‰ä½¿ç”¨å®ƒä»¬æ¥è¯†åˆ«å®¢æˆ·ç«¯ã€‚`heartbeat_interval`é…ç½®æ¯ä¸ªå®¢æˆ·ç«¯çš„å¿ƒè·³é—´éš”ã€‚

å¦‚æœä¸æ”¯æŒåŠŸèƒ½åå•†ï¼ˆ`nsqd` `v0.2.20+`å¼•å…¥ï¼‰nsqdä¼šä½œå‡º`OK`å›åº”ï¼Œå¦åˆ™ï¼š

```shell
{
    "max_rdy_count": 2500,
    "version": "0.2.20-alpha"
}
```

æœ‰å…³`max_rdy_count`å­—æ®µä½¿ç”¨çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§["RDYçŠ¶æ€"](https://nsq.io/clients/building_client_libraries.html#rdy_state)éƒ¨åˆ†ã€‚

### æ•°æ®æµå’Œå¿ƒè·³

ä¸€æ—¦æ¶ˆè´¹è€…å¤„äºè®¢é˜…çŠ¶æ€åï¼ŒNSQåè®®ä¸­çš„æ•°æ®æµå°†æ˜¯å¼‚æ­¥çš„ã€‚å¯¹äºæ¶ˆè´¹è€…è€Œè¨€ï¼Œè¿™æ„å‘³ç€ä¸ºäº†æ„å»ºçœŸæ­£å¼ºå¤§ä¸”é«˜æ€§èƒ½çš„å®¢æˆ·ç«¯åº“ï¼Œåº”è¯¥ä½¿ç”¨å¼‚æ­¥ç½‘ç»œIOå¾ªç¯å’Œ/æˆ–"çº¿ç¨‹"å¯¹å®ƒä»¬è¿›è¡Œç»“æ„åŒ–ï¼ˆåŒå¼•å·ç”¨äºè¡¨ç¤ºOSçº§çº¿ç¨‹å’Œç”¨æˆ·çº§çº¿ç¨‹ï¼Œä¾‹å¦‚åç¨‹ï¼‰ã€‚

æ­¤å¤–ï¼Œè¿˜å¸Œæœ›å®¢æˆ·ç«¯å“åº”æ¥è‡ªæ‰€è¿æ¥çš„`nsqd`å®ä¾‹çš„å®šæœŸå¿ƒè·³ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ­¤é—´éš”ä¸º30ç§’ã€‚å®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨*ä»»ä½•*å‘½ä»¤è¿›è¡Œå“åº”ï¼Œ ä½†æ˜¯æŒ‰ç…§æƒ¯ä¾‹ï¼Œæ¯å½“æ”¶åˆ°å¿ƒè·³ä¿¡å·æ—¶ï¼Œç®€åŒ–å“åº”æœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯ä½¿ç”¨`NOP`ã€‚æœ‰å…³å¦‚ä½•è¯†åˆ«å¿ƒè·³çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§[åè®®è§„èŒƒ](https://nsq.io/clients/tcp_protocol_spec.html)ã€‚

"çº¿ç¨‹"åº”ä¸“ç”¨äºä»TCPå¥—æ¥å­—è¯»å–æ•°æ®ï¼Œä»å¸§ä¸­è§£åŒ…æ•°æ®ä»¥åŠæ‰§è¡Œå¤šè·¯å¤ç”¨é€»è¾‘ä»¥é€‚å½“åœ°è·¯ç”±æ•°æ®ã€‚è¿™ä¹Ÿæ˜¯æ–¹ä¾¿åœ°å¤„ç†å¿ƒè·³çš„æœ€ä½³åœ°ç‚¹(`the best spot`)ã€‚åœ¨æœ€åº•å±‚ï¼Œè¯»å–åè®®æ¶‰åŠä»¥ä¸‹é¡ºåºæ­¥éª¤ï¼š

1. read 4 byte big endian uint32 size
2. read size bytes data
3. unpack data
4. â€¦
5. profit
6. goto 1

#### å…³äºErrorsçš„å°æ’æ›²

ç”±äºå¼‚æ­¥ç‰¹æ€§ï¼Œä¸ºäº†ä½¿åè®®é”™è¯¯(`protocol errors `)ä¸ç”Ÿæˆå®ƒä»¬çš„å‘½ä»¤ç›¸å…³è”ï¼Œéœ€è¦èŠ±è´¹ä¸€äº›é¢å¤–çš„çŠ¶æ€è·Ÿè¸ªã€‚ç›¸åï¼Œæˆ‘ä»¬é‡‡ç”¨äº†"å¿«é€Ÿå¤±è´¥"çš„æ–¹æ³•ï¼Œå› æ­¤ç»å¤§å¤šæ•°åè®®å±‚çº§çš„é”™è¯¯å¤„ç†éƒ½æ˜¯è‡´å‘½çš„ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœå®¢æˆ·ç«¯å‘é€äº†ä¸€ä¸ªæ— æ•ˆå‘½ä»¤ï¼ˆæˆ–ä½¿å…¶è‡ªèº«è¿›å…¥æ— æ•ˆçŠ¶æ€ï¼‰ï¼Œåˆ™æ‰€è¿æ¥çš„`nsqd`å®ä¾‹å°†é€šè¿‡å¼ºåˆ¶å…³é—­è¿æ¥ï¼ˆå¹¶åœ¨å¯èƒ½çš„æƒ…å†µä¸‹å‘å®¢æˆ·ç«¯å‘é€é”™è¯¯ï¼‰æ¥ä¿æŠ¤è‡ªèº«ï¼ˆå’Œç³»ç»Ÿï¼‰ã€‚è¿™åŠ ä¸Šä¸Šé¢æåˆ°çš„è¿æ¥å¤„ç†ï¼Œä½¿å¾—ç³»ç»Ÿæ›´åŠ å¥å£®å’Œç¨³å®šã€‚

åªæœ‰è¿™äº›é”™è¯¯æ˜¯éè‡´å‘½çš„ï¼š

- `E_FIN_FAILED`-ç”¨äºæ— æ•ˆæ¶ˆæ¯IDçš„`FIN`å‘½ä»¤
- `E_REQ_FAILED`-ç”¨äºæ— æ•ˆæ¶ˆæ¯IDçš„`REQ`å‘½ä»¤
- `E_TOUCH_FAILED`-ç”¨äºæ— æ•ˆæ¶ˆæ¯IDçš„`TOUCH`å‘½ä»¤

å› ä¸ºè¿™äº›é”™è¯¯é€šå¸¸æ˜¯è®¡æ—¶é—®é¢˜ï¼Œæ‰€ä»¥å¹¶ä¸è®¤ä¸ºå®ƒä»¬æ˜¯è‡´å‘½çš„ã€‚å½“æ¶ˆæ¯åœ¨`nsqd`ç«¯è¶…æ—¶å¹¶é‡æ–°æ’é˜Ÿç„¶åä¼ é€’ç»™å¦ä¸€ä¸ªæ¶ˆè´¹è€…æ—¶ï¼Œé€šå¸¸ä¼šå‘ç”Ÿè¿™äº›æƒ…å†µã€‚ä¸å†å…è®¸åŸå§‹æ¥æ”¶äººä»£è¡¨è¯¥æ¶ˆæ¯è¿›è¡Œå“åº”ã€‚

### æ¶ˆæ¯å¤„ç†

å½“IOå¾ªç¯è§£åŒ…åŒ…å«æ¶ˆæ¯çš„æ•°æ®å¸§æ—¶ï¼Œå®ƒåº”å°†è¯¥æ¶ˆæ¯è·¯ç”±åˆ°å·²é…ç½®çš„å¤„ç†ç¨‹åºè¿›è¡Œå¤„ç†ã€‚

å‘é€æ–¹`nsqd`å¸Œæœ›åœ¨å…¶é…ç½®çš„æ¶ˆæ¯è¶…æ—¶ï¼ˆé»˜è®¤å€¼ï¼š60ç§’ï¼‰å†…æ”¶åˆ°ç­”å¤ã€‚æœ‰å‡ ç§å¯èƒ½çš„æƒ…å†µï¼š

1. å¤„ç†ç¨‹åºæŒ‡ç¤ºæ¶ˆæ¯å·²æˆåŠŸå¤„ç†ã€‚
2. å¤„ç†ç¨‹åºæŒ‡ç¤ºæ¶ˆæ¯å¤„ç†ä¸æˆåŠŸã€‚
3. å¤„ç†ç¨‹åºå†³å®šéœ€è¦æ›´å¤šæ—¶é—´æ¥å¤„ç†æ¶ˆæ¯ã€‚
4. ä¼ è¾“è¶…æ—¶çš„æ—¶é—´åˆ°æœŸå¹¶ä¸”`nsqd`è‡ªåŠ¨é‡æ–°æ’é˜Ÿè¯¥æ¶ˆæ¯ã€‚

åœ¨å‰ä¸‰ç§æƒ…å†µä¸­ï¼Œå®¢æˆ·ç«¯åº“åº”ä»£è¡¨æ¶ˆè´¹è€…å‘é€ç›¸åº”çš„æŒ‡ä»¤ï¼ˆåˆ†åˆ«ä¸º`FIN`ï¼Œ`REQ`ï¼Œå’Œ`TOUCH`ï¼‰ã€‚

`FIN`å‘½ä»¤æ˜¯æœ€ç®€å•çš„å‘½ä»¤ã€‚å®ƒè¡¨æ˜`nsqd`å¯ä»¥å®‰å…¨åœ°ä¸¢å¼ƒè¯¥æ¶ˆæ¯ã€‚`FIN`ä¹Ÿå¯ä»¥ç”¨äºä¸¢å¼ƒæ‚¨ä¸æƒ³å¤„ç†æˆ–é‡è¯•çš„æ¶ˆæ¯ã€‚

`REQ`å‘½ä»¤è¡¨æ˜`nsqd`åº”è¯¥é‡æ–°æ’é˜Ÿè¯¥æ¶ˆæ¯ï¼ˆä½¿ç”¨å¯é€‰å‚æ•°æŒ‡å®šå»¶è¿Ÿå…¶ä»–å°è¯•çš„æ—¶é—´ï¼‰ã€‚å¦‚æœæ¶ˆè´¹è€…æœªæŒ‡å®šå¯é€‰å‚æ•°ï¼Œåˆ™å®¢æˆ·ç«¯åº“åº”è‡ªåŠ¨è®¡ç®—ä¸æ¶ˆæ¯å¤„ç†çš„å°è¯•æ¬¡æ•°æœ‰å…³çš„æŒç»­æ—¶é—´ï¼ˆé€šå¸¸ä¸ºå€æ•°å³å¯ï¼‰ã€‚å®¢æˆ·ç«¯åº“åº”ä¸¢å¼ƒè¶…å‡ºäº†é…ç½®çš„æœ€å¤§å°è¯•æ¬¡æ•°çš„æ¶ˆæ¯ã€‚å‘ç”Ÿè¿™ç§æƒ…å†µæ—¶ï¼Œåº”æ‰§è¡Œç”¨æˆ·æä¾›çš„å›è°ƒä»¥é€šçŸ¥å¹¶å¯ç”¨ç‰¹æ®Šå¤„ç†ã€‚

å¦‚æœæ¶ˆæ¯å¤„ç†ç¨‹åºéœ€è¦çš„æ—¶é—´è¶…è¿‡äº†é…ç½®çš„æ¶ˆæ¯è¶…æ—¶æ—¶é—´ï¼Œåˆ™`TOUCH`å‘½ä»¤å¯ç”¨äºé‡ç½®`nsqd`ç«¯çš„è®¡æ—¶å™¨ã€‚å¯ä»¥é‡å¤æ‰§è¡Œæ­¤æ“ä½œï¼Œç›´åˆ°æ¶ˆæ¯ä¸º`FIN`æˆ–`REQ`çŠ¶æ€ï¼Œæˆ–è¾¾åˆ°å‘é€æ–¹`nsqd`é…ç½®çš„`max_msg_timeout`ä¸ºæ­¢ã€‚å®¢æˆ·ç«¯åº“æ°¸è¿œä¸èƒ½ä»£è¡¨æ¶ˆè´¹è€…è‡ªåŠ¨ `TOUCH`ã€‚

å¦‚æœå‘é€æ–¹`nsqd`å®ä¾‹æ²¡æœ‰æ¥æ”¶åˆ°å“åº”ï¼Œè¯¥æ¶ˆæ¯å°†è¶…æ—¶å¹¶è‡ªåŠ¨é‡æ–°æ’é˜Ÿï¼Œç„¶åç­‰å¾…ä¼ é€’ç»™å¯ç”¨çš„æ¶ˆè´¹è€…ã€‚

æœ€åï¼Œæ¯ä¸ªæ¶ˆæ¯å…·æœ‰ä¸€ä¸ªå±æ€§æ˜¯å°è¯•æ¬¡æ•°ã€‚å®¢æˆ·ç«¯åº“åº”å°†æ­¤å€¼ä¸é…ç½®çš„æœ€å¤§å€¼è¿›è¡Œæ¯”è¾ƒï¼Œå¹¶ä¸¢å¼ƒè¶…è¿‡è¯¥å€¼çš„æ¶ˆæ¯ã€‚å½“æ¶ˆæ¯è¢«ä¸¢å¼ƒæ—¶ï¼Œåº”è¯¥è§¦å‘ä¸€ä¸ªå›è°ƒã€‚æ­¤å›è°ƒå…¸å‹çš„é»˜è®¤å®ç°å¯èƒ½åŒ…æ‹¬å†™å…¥åˆ°ä¸€ä¸ªç£ç›˜ç›®å½•ï¼Œè¿›è¡Œæ—¥å¿—è®°å½•ç­‰ã€‚ç”¨æˆ·åº”èƒ½å¤Ÿè¦†ç›–æ­¤é»˜è®¤å¤„ç†ã€‚

### RDY çŠ¶æ€

ç”±äºæ¶ˆæ¯æ˜¯ä»`nsqd`å‘æ¶ˆè´¹è€…æ¨é€çš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹æ³•æ¥ç®¡ç†ç”¨æˆ·åŸŸä¸­çš„æ•°æ®æµï¼Œè€Œä¸æ˜¯ä¾èµ–äºåº•å±‚TCPè¯­ä¹‰ã€‚æ¶ˆè´¹è€…çš„`RDY`çŠ¶æ€æ˜¯NSQçš„æµæ§æœºåˆ¶ã€‚

å¦‚[é…ç½®éƒ¨åˆ†ä¸­](https://nsq.io/clients/building_client_libraries.html#configuration)æ¦‚è¿°çš„é‚£æ ·ï¼Œæ¶ˆè´¹è€…ä½¿ç”¨ `max_in_flight`è¿›è¡Œé…ç½®ã€‚è¿™æ˜¯ä¸€ä¸ªå¹¶å‘å’Œæ€§èƒ½ç“¶é¢ˆï¼Œä¾‹å¦‚ï¼ŒæŸäº›ä¸‹æ¸¸ç³»ç»Ÿèƒ½å¤Ÿæ›´ä¸ºè½»æ¾åœ°æ‰¹é‡å¤„ç†æ¶ˆæ¯ï¼Œå¹¶ä»æ›´é«˜çš„`max-in-flight`ä¸­è·ç›Šã€‚

å½“æ¶ˆè´¹è€…è¿æ¥`nsqd`ï¼ˆå¹¶è®¢é˜…ï¼‰æ—¶ï¼Œå…¶å¤„äºåˆå§‹`RDY`çŠ¶æ€`0`ã€‚æ­¤æ—¶å°†ä¸ä¼šä¼ é€’ä»»ä½•æ¶ˆæ¯ã€‚

å®¢æˆ·ç«¯åº“æ‰¿æ‹…ä»¥ä¸‹èŒè´£ï¼š

1. å¼•å¯¼å¹¶å‡åŒ€åœ°å°†`max_in_flight`é…ç½®åˆ†é…ç»™æ‰€æœ‰è¿æ¥ã€‚
2. ç»ä¸å…è®¸æ‰€æœ‰è¿æ¥çš„`RDY`è®¡æ•°æ€»å’Œï¼ˆ`total_rdy_count`ï¼‰è¶…è¿‡æ‰€é…ç½®çš„`max_in_flight`ã€‚
3. æ°¸è¿œä¸è¦è¶…è¿‡`nsqd`é…ç½®çš„æ¯ä¸ªè¿æ¥çš„`max_rdy_count`ã€‚
4. å…¬å¼€APIæ–¹æ³•ä»¥å¯é åœ°æŒ‡ç¤ºæ¶ˆæ¯æµçš„ä¸è¶³(`message flow starvation`)ã€‚

#### 1. å¼•å¯¼å’Œåˆ†é…

å½“ä¸ºä¸€ä¸ªè¿æ¥é€‰æ‹©é€‚å½“çš„`RDY`è®¡æ•°æ—¶ï¼ˆä¸ºäº†å¹³å‡åˆ†é…`max_in_flight`ï¼‰ï¼Œæœ‰ä¸€äº›æ³¨æ„äº‹é¡¹ï¼š

- è¿æ¥æ•°æ˜¯åŠ¨æ€çš„ï¼Œç”šè‡³é€šå¸¸æ˜¯äº‹å…ˆéƒ½ä¸çŸ¥é“çš„ï¼ˆä¾‹å¦‚é€šè¿‡`nsqlookupd`æ—¶å‘ç°`nsqd`æ—¶ ï¼‰ã€‚
- `max_in_flight`å¯èƒ½ä½äºä½ çš„è¿æ¥æ•°

ä¸ºäº†å¯åŠ¨æ¶ˆæ¯æµï¼Œå®¢æˆ·ç«¯åº“éœ€è¦å‘é€åˆå§‹ `RDY`è®¡æ•°ã€‚å› ä¸ºé€šå¸¸ä¸èƒ½æå‰çŸ¥é“æœ€ç»ˆçš„è¿æ¥æ•°ï¼Œå› æ­¤åº”ä»¥å€¼1å¼€å§‹ï¼Œä»¥ä½¿å®¢æˆ·ç«¯åº“ä¸ä¼šä¸å…¬å¹³åœ°åå‘äºç¬¬ä¸€ä¸ªè¿æ¥ã€‚

æ­¤å¤–ï¼Œåœ¨å¤„ç†å®Œæ¯æ¡æ¶ˆæ¯ä¹‹åï¼Œå®¢æˆ·ç«¯åº“åº”è¯¥è¯„ä¼°æ˜¯å¦åº”è¯¥æ›´æ–°`RDY`çŠ¶æ€ã€‚å¦‚æœå½“å‰å€¼ç­‰äº`0`æˆ–å°äºæœ€åå‘é€å€¼çš„25ï¼…ï¼Œåˆ™åº”è§¦å‘æ›´æ–°ã€‚

å®¢æˆ·ç«¯åº“åº”å§‹ç»ˆå°è¯•åœ¨æ‰€æœ‰è¿æ¥ä¹‹é—´å¹³å‡åˆ†é…`RDY`è®¡æ•°ã€‚é€šå¸¸ï¼Œæ­¤å®ç°ä¸º`max_in_flight / num_conns`ã€‚

ä½†æ˜¯ï¼Œå½“`max_in_flight < num_conns`æ—¶ï¼Œè¿™ä¸ªç®€å•å…¬å¼å°±ä¸å¤Ÿç”¨äº†ã€‚åœ¨è¿™ç§çŠ¶æ€ä¸‹ï¼Œå®¢æˆ·ç«¯åº“åº”è¯¥é€šè¿‡æµ‹é‡è‡ªä¸Šæ¬¡ä»ç»™å®šè¿æ¥æ”¶åˆ°æ¶ˆæ¯ä»¥æ¥çš„æŒç»­æ—¶é—´ï¼Œæ¥å¯¹è¿æ¥çš„`nsqd`"æ´»åŠ¨æ€§"(`liveness`)æ‰§è¡ŒåŠ¨æ€è¿è¡Œæ—¶è¯„ä¼°ã€‚å¯é…ç½®çš„æœŸé™åˆ°æœŸåï¼Œåº”å°†æ‰€æœ‰å¯ç”¨çš„è®¡æ•°é‡æ–°åˆ†é…ç»™æ–°çš„ï¼ˆéšæœºï¼‰`nsqd`é›†åˆã€‚è¿™æ ·ï¼Œæ‚¨å¯ä»¥ä¿è¯ï¼ˆæœ€ç»ˆï¼‰ä¼šæ‰¾åˆ°å¸¦æœ‰æ¶ˆæ¯çš„`nsqd`ã€‚æ˜¾ç„¶ï¼Œè¿™ä¼šå¯¹å»¶è¿Ÿäº§ç”Ÿå½±å“ã€‚

#### 2. ç»´æŠ¤ `max_in_flight`

å®¢æˆ·ç«¯åº“åº”ä¸ºç»™å®šçš„æ¶ˆè´¹è€…ä¿æŒæœ€å¤§çš„ä¼ é€’(`in flight`)æ¶ˆæ¯æ•°ä¸Šé™ã€‚å…·ä½“æ¥è¯´ï¼Œæ¯ä¸ªè¿æ¥çš„`RDY`è®¡æ•°æ€»å’Œä¸åº”è¶…è¿‡é…ç½®çš„ `max_in_flight`ã€‚

ä»¥ä¸‹æ˜¯Pythonä¸­çš„ç¤ºä¾‹ä»£ç ï¼Œç”¨äºç¡®å®šå»ºè®®çš„RDYè®¡æ•°å¯¹äºç»™å®šçš„è¿æ¥æ˜¯å¦æœ‰æ•ˆï¼š

```python
def send_ready(reader, conn, count):
    if (reader.total_ready_count + count) > reader.max_in_flight:
        return

    conn.send_ready(count)
    conn.rdy_count = count
    reader.total_ready_count += count
```

#### 3. `nsqd` æœ€å¤§RDYè®¡æ•°

æ¯ä¸€ä¸ª`nsqd`éƒ½å¯ä»¥é…ç½®`--max-rdy-count`ï¼ˆæœ‰å…³æ¶ˆè´¹è€…å¯ä»¥æ‰§è¡Œæ¡æ‰‹ä»¥ç¡®å®šè¯¥å€¼çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§[åŠŸèƒ½åå•†](https://nsq.io/clients/building_client_libraries.html#feature_negotiation)ï¼‰ã€‚å¦‚æœæ¶ˆè´¹è€…å‘é€çš„`RDY`è®¡æ•°è¶…å‡ºå¯æ¥å—èŒƒå›´ï¼Œåˆ™å…¶è¿æ¥å°†è¢«å¼ºåˆ¶å…³é—­ã€‚ä¸ºäº†å‘åå…¼å®¹ï¼Œå¦‚æœ`nsqd`å®ä¾‹ä¸æ”¯æŒ[åŠŸèƒ½åå•†](https://nsq.io/clients/building_client_libraries.html#feature_negotiation)ï¼Œåˆ™åº”å‡å®šæ­¤å€¼ä¸º`2500`ã€‚

#### 4. æ¶ˆæ¯æµä¸è¶³(Message Flow Starvation)

æœ€åï¼Œå®¢æˆ·ç«¯åº“åº”æä¾›ä¸€ç§APIæ–¹æ³•æ¥æŒ‡ç¤ºæ¶ˆæ¯æµä¸è¶³ã€‚å¯¹æ¶ˆè´¹è€…ï¼ˆåœ¨å…¶æ¶ˆæ¯å¤„ç†ç¨‹åºä¸­ï¼‰è€Œè¨€ï¼Œä»…ä»…æ¯”è¾ƒä¼ è¾“ä¸­çš„æ¶ˆæ¯æ•°é‡ä¸é…ç½®çš„`max_in_flight`æ¶ˆæ¯æ•°é‡ä»¥å†³å®š"å¤„ç†æ‰¹æ¬¡"(`process a batch`)æ˜¯ä¸å¤Ÿçš„ã€‚åœ¨å¦‚ä¸‹ä¸¤ç§æƒ…å†µä¸‹æ˜¯æœ‰é—®é¢˜çš„ï¼š

1. å½“æ¶ˆè´¹è€…é…ç½®`max_in_flight > 1`æ—¶ï¼Œç”±äºå­˜åœ¨å˜é‡`num_conns`ï¼Œæœ‰äº›æƒ…å†µä¸‹`max_in_flight`ä¸èƒ½è¢«`num_conns`æ•´é™¤ã€‚ç”±äºåˆåŒ(`contract`)è§„å®šæ‚¨ä¸å¾—è¶…è¿‡ `max_in_flight`ï¼Œå› æ­¤æ‚¨å¿…é¡»å››èˆäº”å…¥ï¼Œæœ€åé‡åˆ°æ‰€æœ‰`RDY`è®¡æ•°ä¹‹å’Œå°äº`max_in_flight`çš„æƒ…å†µã€‚
2. è€ƒè™‘ä»…`nsqd`ä¸­çš„ä¸€éƒ¨åˆ†å…·æœ‰æ¶ˆæ¯çš„æƒ…å†µã€‚ç”±äºé¢„æœŸ`RDY`è®¡æ•°æ˜¯[å‡åŒ€åˆ†å¸ƒ](https://nsq.io/clients/building_client_libraries.html#bootstrap_and_distribution)çš„ï¼Œè¿™äº›æ´»è·ƒçš„`nsqd`ä»…å…·æœ‰å·²é…ç½®çš„`max_in_flight`çš„ä¸€å°éƒ¨åˆ†ã€‚

åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œæ¶ˆè´¹è€…éƒ½ä¸ä¼šçœŸæ­£æ”¶åˆ°`max_in_flight`æ¡æ¶ˆæ¯ã€‚å› æ­¤ï¼Œå®¢æˆ·ç«¯åº“åº”å…¬å¼€ä¸€ä¸ªæ–¹æ³•`is_starved`ï¼Œè¯¥æ–¹æ³•å°†è¯„ä¼°æ˜¯å¦æœ‰ä»»ä½•è¿æ¥å¤„äºé¥¥é¥¿(ä¸è¶³)çŠ¶æ€ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```python
def is_starved(conns):
    for c in conns:
        # the constant 0.85 is designed to *anticipate* starvation rather than wait for it
        if c.in_flight > 0 and c.in_flight >= (c.last_ready * 0.85):
            return True
    return False
```

æ¶ˆæ¯å¤„ç†ç¨‹åºåº”ä½¿ç”¨`is_starved`æ–¹æ³•æ¥å¯é åœ°æ ‡è¯†ä½•æ—¶å¤„ç†ä¸€æ‰¹æ¶ˆæ¯ã€‚

### Backoff

æ¶ˆæ¯å¤„ç†å¤±è´¥æ—¶è¯¥æ€ä¹ˆåŠæ˜¯ä¸€ä¸ªå¾ˆéš¾å›ç­”çš„é—®é¢˜ã€‚åœ¨[æ¶ˆæ¯å¤„ç†](https://nsq.io/clients/building_client_libraries.html#message_handling)éƒ¨åˆ†ä¸­è¯¦ç»†æè¿°äº†å®¢æˆ·ç«¯åº“çš„è¡Œä¸ºï¼Œå®ƒå°†åœ¨æ¨è¿ŸæŸä¸ª(é€’å¢)æŒç»­æ—¶é—´åå†å¤„ç†å¤±è´¥çš„æ¶ˆæ¯ã€‚å¦ä¸€ä¸ªéš¾é¢˜æ˜¯æ˜¯å¦åº”å‡å°‘ååé‡ã€‚è¿™ä¸¤ä¸ªåŠŸèƒ½ä¹‹é—´çš„ç›¸äº’ä½œç”¨å¯¹äºæ•´ä¸ªç³»ç»Ÿçš„ç¨³å®šæ€§è‡³å…³é‡è¦ã€‚

é€šè¿‡å‡æ…¢å¤„ç†é€Ÿåº¦æˆ–"é€€é¿"(`backing off`)ï¼Œæ¶ˆè´¹è€…å¯ä»¥ä½¿ä¸‹æ¸¸ç³»ç»Ÿä»ç¬æ€æ•…éšœä¸­æ¢å¤ã€‚ä½†æ˜¯ï¼Œç”±äºå¹¶éæ€»æ˜¯å¦‚æ­¤æ­¤ï¼Œè¯¥è¡Œä¸ºåº”è¯¥æ˜¯å¯é…ç½®çš„ï¼Œä¾‹å¦‚ä¼˜å…ˆè€ƒè™‘å»¶è¿Ÿçš„æƒ…å†µã€‚

åº”é€šè¿‡å‘é€`RDY 0`åˆ°é€‚å½“çš„`nsqd`ç„¶ååœæ­¢æ¶ˆæ¯æµæ¥å®ç°é€€é¿ã€‚åº”å½“åŸºäºé‡å¤å¤±è´¥çš„æ¬¡æ•°ï¼ˆæŒ‡æ•°ï¼‰æ¥è®¡ç®—ä¿æŒè¿™ç§çŠ¶æ€çš„æŒç»­æ—¶é—´ã€‚åŒæ ·ï¼ŒæˆåŠŸçš„å¤„ç†åº”ç¼©çŸ­æ­¤æŒç»­æ—¶é—´ï¼Œç›´åˆ°è¯»å–å™¨ä¸å†å¤„äºé€€é¿çŠ¶æ€ä¸ºæ­¢ã€‚

å½“è¯»å–å™¨å¤„äºé€€é¿çŠ¶æ€æ—¶ï¼Œè¶…æ—¶åˆ°æœŸåï¼Œæ— è®º`max_in_flight`å¦‚ä½•ï¼Œå®¢æˆ·ç«¯åº“éƒ½åº”ä»…å‘é€`RDY 1`çŠ¶æ€ã€‚åœ¨å®Œå…¨æ¢å¤èŠ‚æµä¹‹å‰ï¼Œè¿™å¯ä»¥æœ‰æ•ˆåœ°"æµ‹è¯•æ°´åŸŸ"( `tests the waters`)ã€‚å¦å¤–ï¼Œåœ¨é€€é¿è¶…æ—¶æœŸé—´ï¼Œå®¢æˆ·ç«¯åº“åœ¨è®¡ç®—é€€é¿æŒç»­æ—¶é—´æ—¶åº”å¿½ç•¥ä»»ä½•æˆåŠŸæˆ–å¤±è´¥çš„ç»“æœï¼ˆå³æ¯æ¬¡é€€é¿è¶…æ—¶ä»…åº”å½“è€ƒè™‘ä¸€ä¸ªç»“æœï¼‰ã€‚

![nsq_client_flow](./images/nsq_client_flow.png)

### åŠ å¯†/å‹ç¼©

NSQé€šè¿‡`IDENTIFY`å‘½ä»¤æ”¯æŒåŠ å¯† å’Œ/æˆ– å‹ç¼©åŠŸèƒ½åå•†ã€‚TLSç”¨äºåŠ å¯†ã€‚[Snappy](https://google.github.io/snappy/)å’Œ`DEFLATE`éƒ½æ”¯æŒç”¨äºå‹ç¼©ã€‚`Snappy`å¯ä»¥ä½œä¸ºç¬¬ä¸‰æ–¹åº“ä½¿ç”¨ï¼Œä½†æ˜¯å¤§å¤šæ•°è¯­è¨€éƒ½å¯¹`DEFLATE`å…·æœ‰ä¸€äº›åŸç”Ÿæ”¯æŒã€‚

å½“æ¥æ”¶åˆ°`IDENTIFY`å“åº”å¹¶ä¸”æ‚¨å·²ç»é€šè¿‡TLS `tls_v1`æ ‡å¿—è¿›è¡Œäº†è¯·æ±‚ï¼Œä½ ä¼šå¾—åˆ°ç±»ä¼¼å¦‚ä¸‹çš„`JSON`å†…å®¹ï¼š

```json
{
    "deflate": false,
    "deflate_level": 0,
    "max_deflate_level": 6,
    "max_msg_timeout": 900000,
    "max_rdy_count": 2500,
    "msg_timeout": 60000,
    "sample_rate": 0,
    "snappy": true,
    "tls_v1": true,
    "version": "0.2.28"
}
```

åœ¨ç¡®è®¤å°†`tls_v1`è®¾ç½®ä¸º`true`ï¼ˆè¡¨æ˜æœåŠ¡å™¨æ”¯æŒTLSï¼‰ä¹‹åï¼Œæ‚¨å¯ä»¥åœ¨ç½‘ç»œå‘é€æˆ–æ¥æ”¶å…¶ä»–ä»»ä½•å†…å®¹ä¹‹å‰å¯åŠ¨TLSæ¡æ‰‹ï¼ˆä¾‹å¦‚ï¼Œåœ¨Pythonä¸­ä½¿ç”¨`ssl.wrap_socket`å›è°ƒï¼‰ã€‚TLSæ¡æ‰‹æˆåŠŸåï¼Œæ‚¨å°†ç«‹å³è¯»å–åˆ°ä¸€ä¸ªåŠ å¯†çš„NSQ`OK`å“åº”ã€‚

ç±»ä¼¼ï¼Œå¦‚æœå¯ç”¨äº†å‹ç¼©ï¼Œåˆ™å°†æŸ¥æ‰¾`snappy`æˆ–`deflate`ä¸ºå€¼`true`ï¼Œç„¶åä½¿ç”¨é€‚å½“çš„è§£å‹å™¨åŒ…è£…å¥—æ¥å­—çš„è¯»å†™è°ƒç”¨ã€‚å†ä¸€æ¬¡ï¼Œä¼šç«‹å³è¯»å–åˆ°ä¸€ä¸ªå‹ç¼©çš„NSQ`OK`å“åº”ã€‚

è¿™äº›å‹ç¼©åŠŸèƒ½æ˜¯äº’æ–¥çš„ã€‚

éå¸¸é‡è¦çš„æ˜¯ï¼Œæ‚¨å¿…é¡»åœ¨åå•†å®ŒæˆåŠ å¯†/å‹ç¼©ä¹‹åæ‰é˜»æ­¢ç¼“å†²ï¼Œæˆ–è€…åœ¨åå•†åŠŸèƒ½æ—¶ä¸€å®šè¦æ³¨æ„å°†å…¶è¯»ä¸ºç©º(`read-to-empty`)ã€‚

### æ€»ç»“

åˆ†å¸ƒå¼ç³»ç»Ÿå¾ˆæœ‰è¶£ã€‚

NSQé›†ç¾¤çš„å„ä¸ªç»„ä»¶ä¹‹é—´çš„ç›¸äº’ååŒå·¥ä½œï¼Œæä¾›äº†ä¸€ä¸ªæ„å»ºå¥å£®ã€é«˜æ€§èƒ½å’Œç¨³å®šçš„åŸºç¡€æ¶æ„çš„å¹³å°ã€‚æˆ‘ä»¬å¸Œæœ›æœ¬æŒ‡å—èƒ½é˜æ˜å®¢æˆ·ç«¯è§’è‰²çš„é‡è¦æ€§ã€‚

åœ¨å®é™…å®ç°çš„æ‰€æœ‰è¿™äº›æ–¹é¢ï¼Œæˆ‘ä»¬å°†[pynsq](https://github.com/nsqio/pynsq)å’Œ[go-nsq](https://github.com/nsqio/go-nsq)è§†ä¸ºæˆ‘ä»¬çš„å‚è€ƒä»£ç åº“ã€‚[pynsq](https://github.com/nsqio/pynsq)çš„ç»“æ„å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š

- `Message`-ä¸€ä¸ªé«˜å±‚æ¬¡çš„æ¶ˆæ¯å¯¹è±¡ï¼Œå®ƒå…¬å¼€äº†ç”¨äºå“åº”`nsqd`çŠ¶æ€(`FIN`ï¼Œ`REQ`ï¼Œ`TOUCH`ç­‰ï¼‰çš„æ–¹æ³•ä»¥åŠå…ƒæ•°æ®ï¼Œä¾‹å¦‚(å¤±è´¥)å°è¯•å’Œæ—¶é—´æˆ³ã€‚
- `Connection`-è¿æ¥åˆ°ç‰¹å®š`nsqd`çš„TCPé«˜çº§å°è£…ï¼Œè¯¥å°è£…çŸ¥é“ä¼ é€’ä¸­çš„æ¶ˆæ¯ã€`RDY`çŠ¶æ€ã€åå•†çš„åŠŸèƒ½ä»¥åŠå„ç§è®¡æ—¶ã€‚
- `Consumer`-ä¸ç”¨æˆ·è¿›è¡Œäº¤äº’çš„å‰ç«¯APIï¼Œç”¨äºå¤„ç†å‘ç°ï¼Œåˆ›å»ºè¿æ¥ï¼ˆå’Œè®¢é˜…ï¼‰ï¼Œå¼•å¯¼å’Œç®¡ç†`RDY`çŠ¶æ€ï¼Œè§£æåŸå§‹ä¼ å…¥çš„æ•°æ®ï¼Œåˆ›å»º`Message`å¯¹è±¡å¹¶åˆ†å‘æ¶ˆæ¯ç»™å¤„ç†ç¨‹åºã€‚
- `Producer` -ä¸ç”¨æˆ·äº¤äº’çš„å‰ç«¯APIï¼Œç”¨äºå¤„ç†æ¶ˆæ¯å‘å¸ƒã€‚

æˆ‘ä»¬å¾ˆé«˜å…´ä¸ºä»»ä½•å¯¹æ„å»ºNSQå®¢æˆ·ç«¯åº“æ„Ÿå…´è¶£çš„äººæä¾›æ”¯æŒã€‚æˆ‘ä»¬æ­£åœ¨å¯»æ‰¾è´¡çŒ®è€…ï¼Œä»¥ç»§ç»­æ‰©å±•æˆ‘ä»¬çš„è¯­è¨€æ”¯æŒä»¥åŠå……å®ç°æœ‰åº“ä¸­çš„åŠŸèƒ½ã€‚ç¤¾åŒºå·²ç»å¼€æºäº†[å¤šä¸ªå®¢æˆ·ç«¯åº“](https://nsq.io/clients/client_libraries.html)ã€‚

## TCPåè®®è§„èŒƒ

NSQåè®®éå¸¸ç®€å•ï¼Œä»¥è‡³äºä½¿ç”¨ä»»ä½•è¯­è¨€æ„å»ºå®¢æˆ·ç«¯éƒ½éå¸¸ç®€å•ã€‚æˆ‘ä»¬æä¾›å®˜æ–¹çš„Goå’ŒPythonå®¢æˆ·ç«¯åº“ã€‚

ä¸€ä¸ª`nsqd`è¿›ç¨‹ç›‘å¬åœ¨ä¸€ä¸ªå¯é…ç½®çš„TCPç«¯å£ä¸Šï¼Œç”¨äºæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ã€‚

è¿æ¥åï¼Œå®¢æˆ·ç«¯å¿…é¡»å‘é€ä¸€ä¸ª4å­—èŠ‚çš„"é­”æœ¯"æ ‡è¯†ç¬¦ï¼Œä»¥æŒ‡ç¤ºå°†è¦ç”¨äºé€šä¿¡çš„åè®®ç‰ˆæœ¬ï¼ˆå‡çº§å¾ˆå®¹æ˜“ï¼‰ã€‚

- `V2` (4-byte ASCII `[space][space][V][2]`)æ˜¯ä¸€ä¸ªåŸºäºæµåè®®ï¼Œç”¨äºæ¶ˆè´¹ï¼ˆä»¥åŠå‘å¸ƒè¯·æ±‚/å“åº”ï¼‰çš„æ¨é€ã€‚

éªŒè¯ä¹‹åï¼Œå®¢æˆ·ç«¯å¯ä»¥é€‰æ‹©å‘é€`IDENTIFY`å‘½ä»¤ä»¥æä¾›è‡ªå®šä¹‰å…ƒæ•°æ®ï¼ˆä¾‹å¦‚ï¼Œæ›´å…·æè¿°æ€§çš„æ ‡è¯†ç¬¦ï¼‰å¹¶åå•†åŠŸèƒ½ã€‚ä¸ºäº†å¼€å§‹æ¶ˆè´¹æ¶ˆæ¯ï¼Œå®¢æˆ·ç«¯å¿…é¡»è®¢é˜…(`SUB`)åˆ°ä¸€ä¸ªé€šé“ã€‚

è®¢é˜…åï¼Œå®¢æˆ·ç«¯å°†å¤„äº`RDY 0`çŠ¶æ€ã€‚è¿™æ„å‘³ç€ä¸ä¼šæœ‰ä»»ä½•æ¶ˆæ¯å‘é€åˆ°å®¢æˆ·ç«¯ã€‚å½“å®¢æˆ·ç«¯å‡†å¤‡å¥½æ¥æ”¶æ¶ˆæ¯æ—¶ï¼Œå®ƒåº”è¯¥å‘é€ä¸€æ¡å‘½ä»¤ï¼Œæ›´æ–°å…¶`RDY`çŠ¶æ€ä¸ºå‡†å¤‡å¤„ç†çš„æ¶ˆæ¯æ¡æ•°ï¼Œä¾‹å¦‚100ã€‚æ²¡æœ‰ä»»ä½•å…¶ä»–å‘½ä»¤ï¼Œåˆ™ä¼šåœ¨æœ‰å¯ç”¨æ¶ˆæ¯æ—¶å°†100æ¡æ¶ˆæ¯æ¨é€åˆ°å®¢æˆ·ç«¯ï¼ˆæ¯æ¬¡é€’å‡è¯¥å®¢æˆ·ç«¯çš„æœåŠ¡ç«¯`RDY`è®¡æ•°ï¼‰ã€‚

**V2**åè®®è¿˜è®¾æœ‰å®¢æˆ·ç«¯å¿ƒè·³ã€‚æ¯éš”30ç§’ï¼ˆé»˜è®¤30sä½†å¯é…ç½®ï¼‰ï¼Œ`nsqd` å°†å‘é€`_heartbeat_`å“åº”å¹¶æœŸæœ›ä¸€ä¸ªè¿”å›å‘½ä»¤ï¼ˆ`expect a command in return`ï¼‰ã€‚å¦‚æœå®¢æˆ·ç«¯ç©ºé—²ï¼Œåˆ™å‘é€ `NOP`ã€‚åœ¨2ä¸ªæœªç­”å¤çš„`_heartbeat_`å“åº”åï¼Œ`nsqd`å°†è¶…æ—¶å¹¶å¼ºè¡Œå…³é—­å…¶æœªå¬åˆ°å¿ƒè·³çš„å®¢æˆ·ç«¯è¿æ¥ã€‚`IDENTIFY`å‘½ä»¤å¯ç”¨äºæ›´æ”¹/ç¦ç”¨æ­¤è¡Œä¸ºã€‚

### æ³¨æ„

- é™¤éå¦æœ‰è¯´æ˜ï¼Œå¦åˆ™ç½‘ç»œä¸Šçš„**æ‰€æœ‰**äºŒè¿›åˆ¶å¤§å°/æ•´æ•°éƒ½æ˜¯**ç½‘ç»œå­—èŠ‚é¡ºåº** ï¼ˆå³ï¼Œ`big endian`ï¼‰
- æœ‰æ•ˆçš„ä¸»é¢˜å’Œé€šé“åç§°æ˜¯å­—ç¬¦`[.a-zA-Z0-9_-]`å¹¶ä¸”`1 < length <= 64` ï¼ˆåœ¨`nsqd` `0.2.28`ä¹‹å‰ï¼Œæœ€å¤§é•¿åº¦ä¸º`32`ï¼‰

### å‘½ä»¤

#### IDENTIFY

æ›´æ–°å®¢æˆ·ç«¯åœ¨æœåŠ¡ç«¯çš„å…ƒæ•°æ®ä»¥åŠåå•†åŠŸèƒ½(`negotiate features`)

```shell
IDENTIFY\n
[ 4-byte size in bytes ][ N-byte JSON data ]
```

æ³¨æ„ï¼šæ­¤å‘½ä»¤é‡‡ç”¨ä¸€å®šå¤§å°çš„`JSON BODY`å‰ç¼€ï¼Œç›¸å…³å­—æ®µä¸ºï¼š

- **`client_id`** ç”¨äºæ¶ˆé™¤å®¢æˆ·ç«¯æ­§ä¹‰çš„æ ‡è¯†ç¬¦ï¼ˆå³ç‰¹å®šäºæ¶ˆè´¹è€…çš„ä¸œè¥¿ï¼‰ã€‚

- **`hostname`** éƒ¨ç½²å®¢æˆ·ç«¯çš„ä¸»æœºåã€‚

- **`feature_negotiation`**ï¼ˆ`nsqd` `v0.2.19+`ï¼‰å¸ƒå°”å€¼ï¼Œç”¨äºæŒ‡ç¤ºå®¢æˆ·ç«¯å…¶æ˜¯å¦æ”¯æŒåŠŸèƒ½åå•†ã€‚å¦‚æœæœåŠ¡å™¨æœ‰èƒ½åŠ›æ”¯æŒï¼Œå®ƒå°†ä»¥`JSON`è´Ÿè·å‘å›æ”¯æŒçš„åŠŸèƒ½å’Œå…ƒæ•°æ®ã€‚

- **`heartbeat_interval`** (`nsqd` `v0.2.19+`): å¿ƒè·³æ¯«ç§’æ•°ã€‚æœ‰æ•ˆèŒƒå›´: `1000 <= heartbeat_interval <= configured_max` (`-1` ç¦ç”¨å¿ƒè·³)`--max-heartbeat-interval` (`nsqd` æ ‡å¿—) æ§åˆ¶æœ€å¤§å€¼ï¼Œé»˜è®¤ä¸º `--client-timeout / 2`ã€‚

- **`output_buffer_size`**ï¼ˆ`nsqd` `v0.2.21+`ï¼‰ï¼šå†™å…¥å®¢æˆ·ç«¯æ—¶`nsqd`å°†ä½¿ç”¨çš„ç¼“å†²åŒºå­—èŠ‚å¤§å°ã€‚æœ‰æ•ˆèŒƒå›´ï¼š`64 <= output_buffer_size <= configured_max`ï¼ˆ`-1`ç¦æ­¢è¾“å‡ºç¼“å†²ï¼‰ã€‚`--max-output-buffer-size` ï¼ˆ`nsqd`æ ‡å¿—ï¼‰æ§åˆ¶æœ€å¤§å€¼ï¼Œé»˜è®¤ä¸º `16kb`ã€‚

- **`output_buffer_timeout`**ï¼ˆ`nsqd` `v0.2.21+`ï¼‰ï¼šç¼“å†²è¶…æ—¶ï¼Œåœ¨è¶…æ—¶ä¹‹å`nsqd`ç¼“å†²çš„æ‰€æœ‰æ•°æ®å°†åˆ·æ–°è‡³å®¢æˆ·ç«¯ã€‚æœ‰æ•ˆèŒƒå›´ï¼š`1ms <= output_buffer_timeout <= configured_max`ï¼ˆ`-1`ç¦ç”¨è¶…æ—¶ï¼‰

  `--max-output-buffer-timeout` ï¼ˆ`nsqd`æ ‡å¿—ï¼‰æ§åˆ¶æœ€å¤§å€¼ï¼Œ é»˜è®¤ä¸º `250ms`ã€‚

  **è­¦å‘Š**ï¼šå°†å®¢æˆ·ç«¯`output_buffer_timeout`é…ç½®ä¸ºæä½çš„å€¼ï¼ˆ`< 25ms`ï¼‰ ä¼šå¯¹`nsqd`CPUä½¿ç”¨ç‡äº§ç”Ÿé‡å¤§å½±å“ï¼ˆå°¤å…¶æ˜¯åœ¨`> 50`ä¸ªå®¢æˆ·ç«¯è¿æ¥çš„æƒ…å†µä¸‹ï¼‰ã€‚

  è¿™æ˜¯ç”±äºå½“å‰çš„å®ç°ä¾èµ–äºGoè®¡æ—¶å™¨ï¼Œè¯¥è®¡æ—¶å™¨ç”±Goè¿è¡Œæ—¶åœ¨ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸­ç»´æŠ¤ã€‚æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯è¯·å‚è§ [pull request #236](https://github.com/nsqio/nsq/pull/236)ä¸­çš„[æäº¤ä¿¡æ¯](https://github.com/mreiferson/nsq/commit/043b79acda5fe57056b3cc21b2ef536d5615a2c2])ã€‚

- **`tls_v1`**ï¼ˆ`nsqd` `v0.2.22+`ï¼‰ï¼š ä¸ºè¿æ¥å¯ç”¨TLSã€‚`--tls-cert`å’Œ`--tls-key`ï¼ˆ`nsqd`æ ‡å¿—ï¼‰ç”¨äºå¯ç”¨TLSå¹¶é…ç½®æœåŠ¡å™¨è¯ä¹¦ã€‚å¦‚æœæœåŠ¡å™¨æ”¯æŒTLSï¼Œå®ƒå°†å›å¤ `"tls_v1": true`ã€‚å®¢æˆ·ç«¯åº”åœ¨è¯»å–`IDENTIFY`å“åº”åç«‹å³å¼€å§‹TLSæ¡æ‰‹ã€‚æœåŠ¡å™¨å°†åœ¨å®ŒæˆTLSæ¡æ‰‹ååšå‡º`OK`å“åº”ã€‚

- **`snappy`**ï¼ˆ`nsqd` `v0.2.23+`ï¼‰ï¼šä¸ºè¿æ¥å¯ç”¨`snappy`å‹ç¼©ã€‚`--snappy` ï¼ˆ`nsqd`æ ‡å¿—ï¼‰ç”¨äºå¯ç”¨æœåŠ¡ç«¯æ”¯æŒã€‚

  å®¢æˆ·ç«¯åº”åœ¨`IDENTIFY`å“åº”ä¹‹åç«‹å³è·å¾—ä¸€ä¸ªé¢å¤–çš„ï¼Œå¿«é€Ÿçš„å‹ç¼©`OK`å“åº”ã€‚å®¢æˆ·ç«¯ä¸èƒ½åŒæ—¶å¯ç”¨`snappy`å’Œ`deflate`ã€‚

- **`deflate`**ï¼ˆ`nsqd` `v0.2.23+`ï¼‰ï¼šä¸ºè¿æ¥å¯ç”¨`deflate`å‹ç¼©ã€‚`--deflate` ï¼ˆ`nsqd`æ ‡å¿—ï¼‰ç”¨äºå¯ç”¨æœåŠ¡ç«¯æ”¯æŒã€‚å®¢æˆ·ç«¯åº”åœ¨`IDENTIFY`å“åº”ä¹‹åç«‹å³è·å¾—ä¸€ä¸ªé¢å¤–çš„`deflate`å‹ç¼©`OK`å“åº”ã€‚å®¢æˆ·ç«¯ä¸èƒ½åŒæ—¶å¯ç”¨`snappy`å’Œ`deflate`ã€‚

- **`deflate_level`**ï¼ˆ`nsqd` `v0.2.23+`ï¼‰: é…ç½®è¿æ¥çš„å‹ç¼©çº§åˆ«ã€‚`--max-deflate-level` ï¼ˆ`nsqd`æ ‡å¿—ï¼‰é…ç½®æœ€å¤§å…è®¸å€¼ã€‚æœ‰æ•ˆèŒƒå›´ï¼š `1 <= deflate_level <= configured_max`ã€‚è¾ƒé«˜çš„å€¼è¡¨ç¤ºæ›´å¥½çš„å‹ç¼©ï¼Œä½†æ˜¯`nsqd`çš„CPUä½¿ç”¨ç‡æ›´é«˜ã€‚

- **`sample_rate`**ï¼ˆ`nsqd` `v0.2.25+`ï¼‰ï¼šä¼ é€’ è¿æ¥æ‰€æ¥æ”¶åˆ°çš„æ‰€æœ‰æ¶ˆæ¯çš„ç™¾åˆ†æ¯”ã€‚æœ‰æ•ˆèŒƒå›´ï¼š`0 <= sample_rate <= 99`ï¼ˆ`0`ç¦ç”¨é‡‡æ ·ï¼‰ï¼Œé»˜è®¤ä¸º `0`

- **`user_agent`**ï¼ˆ`nsqd` `v0.2.25+`ï¼‰ï¼š æŒ‰ç…§HTTPç²¾ç¥ï¼Œå®¢æˆ·ç«¯ä»£ç†çš„å­—ç¬¦ä¸²æ ‡è¯†ç¬¦ã€‚é»˜è®¤ä¸ºï¼š`<client_library_name>/<version>`

- **`msg_timeout`**ï¼ˆ`nsqd` `v0.2.28+`ï¼‰ï¼š ä»¥æ¯«ç§’ä¸ºå•ä½é…ç½®çš„æœåŠ¡å™¨ç«¯æ¶ˆæ¯è¶…æ—¶ï¼Œç”¨äºå°†æ¶ˆæ¯ä¼ é€’ç»™å®¢æˆ·ç«¯ã€‚

æˆåŠŸçš„å“åº”:

```shell
OK
```

æ³¨æ„ï¼š å¦‚æœå®¢æˆ·ç«¯å‘é€äº†`feature_negotiation`ï¼ˆå¹¶ä¸”æœåŠ¡ç«¯æ”¯æŒå®ƒï¼‰ï¼Œå“åº”å°†æ˜¯å¦‚ä¸Šæ‰€è¿°çš„`JSON`è´Ÿè·ã€‚

é”™è¯¯å“åº”ï¼š

```shell
E_INVALID
E_BAD_BODY
```

#### SUB

è®¢é˜…ä¸€ä¸ªä¸»é¢˜/é€šé“:

```shell
SUB <topic_name> <channel_name>\n

<topic_name> - a valid string (optionally having #ephemeral suffix)
<channel_name> - a valid string (optionally having #ephemeral suffix)
```

æˆåŠŸå“åº”:

```shell
OK
```

é”™è¯¯å“åº”:

```shell
E_INVALID
E_BAD_TOPIC
E_BAD_CHANNEL
```

#### PUB

å‘å¸ƒä¸€ä¸ªæ¶ˆæ¯åˆ°ä¸€ä¸ªä¸»é¢˜ï¼š

```shell
PUB <topic_name>\n
[ 4-byte size in bytes ][ N-byte binary data ]

<topic_name> - a valid string (optionally having #ephemeral suffix)
```

æˆåŠŸå“åº”:

```shell
OK
```

é”™è¯¯å“åº”:

```shell
E_INVALID
E_BAD_TOPIC
E_BAD_MESSAGE
E_PUB_FAILED
```

#### MPUB

å‘å¸ƒ å¤šä¸ªæ¶ˆæ¯åˆ°ä¸€ä¸ªä¸»é¢˜ï¼ˆåŸå­çš„ï¼‰ï¼š

æ³¨æ„ï¼š `nsqd` `v0.2.16+`å¯ç”¨

```shell
MPUB <topic_name>\n
[ 4-byte body size ]
[ 4-byte num messages ]
[ 4-byte message #1 size ][ N-byte binary data ]
      ... (repeated <num_messages> times)

<topic_name> - a valid string (optionally having #ephemeral suffix)
```

æˆåŠŸå“åº”:

```shell
OK
```

é”™è¯¯å“åº”:

```shell
E_INVALID
E_BAD_TOPIC
E_BAD_BODY
E_BAD_MESSAGE
E_MPUB_FAILED
```

#### DPUB

å‘å¸ƒä¸€ä¸ªå»¶è¿Ÿæ¶ˆæ¯åˆ°ä¸€ä¸ªä¸»é¢˜ï¼š

æ³¨æ„ï¼š `nsqd` `v0.3.6+`å¯ç”¨

```shell
DPUB <topic_name> <defer_time>\n
[ 4-byte size in bytes ][ N-byte binary data ]

<topic_name> - a valid string (optionally having #ephemeral suffix)
<defer_time> - a string representation of integer D which defines the time for how long to defer where 0 <= D < max-requeue-timeout
```

æˆåŠŸå“åº”:

```shell
OK
```

é”™è¯¯å“åº”:

```shell
E_INVALID
E_BAD_TOPIC
E_BAD_MESSAGE
E_DPUB_FAILED
```

#### RDY

æ›´æ–°`RDY`çŠ¶æ€ï¼ˆæŒ‡ç¤ºä½ å‡†å¤‡è·å–`N`ä¸ªæ¶ˆæ¯ï¼‰

æ³¨æ„ï¼š`nsqd` `v0.2.20+`ä½¿ç”¨ `--max-rdy-count` æ¥ç•Œå®šæ­¤å€¼ã€‚

```shell
RDY <count>\n

<count> - a string representation of integer N where 0 < N <= configured_max
```

æ³¨æ„ï¼šæ²¡æœ‰æˆåŠŸçš„å“åº”

é”™è¯¯å“åº”ï¼š

```shell
E_INVALID
```

#### FIN

å®Œæˆä¸€ä¸ªæ¶ˆæ¯(è¡¨æ˜æˆåŠŸå¤„ç†)

```shell
FIN <message_id>\n

<message_id> - message id as 16-byte hex string
```

æ³¨æ„ï¼šæ²¡æœ‰æˆåŠŸçš„å“åº”

é”™è¯¯å“åº”ï¼š

```shell
E_INVALID
E_FIN_FAILED
```

#### REQ

é‡æ–°æ’é˜Ÿæ¶ˆæ¯(è¡¨æ˜å¤„ç†å¤±è´¥)

é‡æ–°æ’é˜Ÿçš„æ¶ˆæ¯æ”¾ç½®åœ¨é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œç­‰ä»·äºåˆšåˆšå‘å¸ƒè¯¥æ¶ˆæ¯ï¼Œä½†æ˜¯å‡ºäºå„ç§å®ç°çš„ç‰¹å®šåŸå› ï¼Œä¸åº”æ˜ç¡®ä¾èµ–æ­¤è¡Œä¸ºï¼Œå¹¶ä¸”å°†æ¥å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚

åŒæ ·ï¼Œä¼ è¾“ä¸­ä¸”è¶…æ—¶çš„æ¶ˆæ¯åœ¨è¡Œä¸ºä¸Šä¸æ˜ç¡®çš„`REQ`ç›¸åŒã€‚

```shell
REQ <message_id> <timeout>\n

<message_id> - message id as 16-byte hex string
<timeout> - a string representation of integer N where N <= configured max timeout
    0 is a special case that will not defer re-queueing
```

æ³¨æ„ï¼šæ²¡æœ‰æˆåŠŸçš„å“åº”

é”™è¯¯å“åº”ï¼š

```shell
E_INVALID
E_REQ_FAILED
```

#### TOUCH

å¯¹ä¼ é€’ä¸­çš„æ¶ˆæ¯ï¼Œé‡ç½®å…¶è¶…æ—¶ã€‚

æ³¨æ„ï¼š`nsqd` `v0.2.17+`å¯ç”¨

```shell
TOUCH <message_id>\n

<message_id> - the hex id of the message
```

æ³¨æ„ï¼šæ²¡æœ‰æˆåŠŸçš„å“åº”

é”™è¯¯å“åº”ï¼š

```shell
E_INVALID
E_TOUCH_FAILED
```

#### CLS

å¹²å‡€åœ°å…³é—­è¿æ¥(ä¸å†å‘é€ä»»ä½•æ¶ˆæ¯)

```shell
CLS\n
```

æˆåŠŸå“åº”ï¼š

```shell
CLOSE_WAIT
```

é”™è¯¯å“åº”:

```shell
E_INVALID
```

#### NOP

No-op

```shell
NOP\n
```

æ³¨æ„ï¼š æ²¡æœ‰ä»»ä½•å“åº”.

#### AUTH

æ³¨æ„ï¼š `nsqd` `v0.2.29+`å¯ç”¨ã€‚

å¦‚æœ`IDENTIFY`å“åº”è¡¨æ˜ `auth_required=true` ï¼Œå®¢æˆ·ç«¯å¿…é¡»åœ¨ä»»ä½• `SUB`, `PUB` æˆ–`MPUB`ä¹‹å‰å‘é€`AUTH`ã€‚å¦‚æœ`auth_required`ä¸å­˜åœ¨ï¼ˆæˆ–ä¸º`false`ï¼‰ï¼Œåˆ™å®¢æˆ·ç«¯ä¸å¾—æˆæƒã€‚

å½“`nsqd`æ¥æ”¶åˆ°ä¸€ä¸ª`AUTH`å‘½ä»¤ï¼Œå®ƒå°†é€šè¿‡æŸ¥è¯¢å‚æ•°çš„å½¢å¼ï¼šè¿æ¥çš„è¿œç¨‹åœ°å€ã€TLSçŠ¶æ€ã€ä»¥åŠæ‰€æä¾›çš„AUTHå¯†ç ï¼Œæ‰§è¡Œä¸€ä¸ªå¸¦æœ‰å®¢æˆ·ç«¯å…ƒæ•°æ®çš„HTTPè¯·æ±‚ï¼Œå°†è´£ä»»å§”æ‰˜ç»™å·²é…ç½®çš„`--auth-http-address`  ã€‚æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§ [AUTH](https://nsq.io/components/nsqd.html)ã€‚

```shell
AUTH\n
[ 4-byte size in bytes ][ N-byte Auth Secret ]
```

æˆåŠŸå“åº”:

`JSON`è´Ÿè·æè¿°äº†æˆæƒå®¢æˆ·ç«¯èº«ä»½ï¼Œå¯é€‰URLå’Œæˆæƒè®¡æ•°

```shell
{"identity":"...", "identity_url":"...", "permission_count":1}
```

é”™è¯¯å“åº”:

```shell
E_AUTH_FAILED - An error occurred contacting an auth server
E_UNAUTHORIZED - No permissions found
```

### æ•°æ®æ ¼å¼

æ•°æ®å¼‚æ­¥ä¼ è¾“åˆ°å®¢æˆ·ç«¯å¹¶è¿›è¡Œåˆ†å¸§ä»¥æ”¯æŒå„ç§å“åº”ä¸»ä½“ï¼Œå³ï¼š

```shell
[x][x][x][x][x][x][x][x][x][x][x][x]...
|  (int32) ||  (int32) || (binary)
|  4-byte  ||  4-byte  || N-byte
------------------------------------...
    size     frame type     data
```

å®¢æˆ·ç«¯åº”æœŸæœ›ä»¥ä¸‹å¸§ç±»å‹ä¹‹ä¸€ï¼š

```shell
FrameTypeResponse int32 = 0
FrameTypeError    int32 = 1
FrameTypeMessage  int32 = 2
```

æœ€åï¼Œæ¶ˆæ¯æ ¼å¼ä¸ºï¼š

```shell
[x][x][x][x][x][x][x][x][x][x][x][x][x][x][x][x][x][x][x][x][x][x][x][x][x][x][x][x][x][x]...
|       (int64)        ||    ||      (hex string encoded in ASCII)           || (binary)
|       8-byte         ||    ||                 16-byte                      || N-byte
------------------------------------------------------------------------------------------...
  nanosecond timestamp    ^^                   message ID                       message body
                       (uint16)
                        2-byte
                       attempts
```

# éƒ¨ç½²

## å®‰è£…

### äºŒè¿›åˆ¶å‘å¸ƒåŒ…

å¯ä»¥ä¸‹è½½é€‚ç”¨äºlinuxï¼Œdarwinï¼Œfreebsdå’ŒWindowsçš„é¢„ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶ï¼š

#### å½“å‰ç¨³å®šç‰ˆæœ¬ï¼š **`v1.2.0`**

- [nsq-1.2.0.darwin-amd64.go1.12.9.tar.gz](https://s3.amazonaws.com/bitly-downloads/nsq/nsq-1.2.0.darwin-amd64.go1.12.9.tar.gz)
- [nsq-1.2.0.linux-amd64.go1.12.9.tar.gz](https://s3.amazonaws.com/bitly-downloads/nsq/nsq-1.2.0.linux-amd64.go1.12.9.tar.gz)
- [nsq-1.2.0.freebsd-amd64.go1.12.9.tar.gz](https://s3.amazonaws.com/bitly-downloads/nsq/nsq-1.2.0.freebsd-amd64.go1.12.9.tar.gz)
- [nsq-1.2.0.windows-amd64.go1.12.9.tar.gz](https://s3.amazonaws.com/bitly-downloads/nsq/nsq-1.2.0.windows-amd64.go1.12.9.tar.gz)

#### è¾ƒæ—§çš„ç¨³å®šç‰ˆæœ¬

- [nsq-1.1.0.darwin-amd64.go1.10.3.tar.gz](https://s3.amazonaws.com/bitly-downloads/nsq/nsq-1.1.0.darwin-amd64.go1.10.3.tar.gz)
- [nsq-1.1.0.linux-amd64.go1.10.3.tar.gz](https://s3.amazonaws.com/bitly-downloads/nsq/nsq-1.1.0.linux-amd64.go1.10.3.tar.gz)
- [nsq-1.1.0.freebsd-amd64.go1.10.3.tar.gz](https://s3.amazonaws.com/bitly-downloads/nsq/nsq-1.1.0.freebsd-amd64.go1.10.3.tar.gz)
- [nsq-1.1.0.windows-amd64.go1.10.3.tar.gz](https://s3.amazonaws.com/bitly-downloads/nsq/nsq-1.1.0.windows-amd64.go1.10.3.tar.gz)

### Docker

è¯·å‚é˜…æœ‰å…³ä½¿ç”¨[Docker](https://docker.io/)éƒ¨ç½²NSQ[çš„æ–‡æ¡£](https://nsq.io/deployment/docker.html)ã€‚

### OSX

```shell
 $ brew install nsq
```

### æºç æ„å»º

#### å…ˆå†³æ¡ä»¶

- **[golang](https://golang.org/doc/install)**ï¼ˆ**`1.9+`**éœ€è¦ç‰ˆæœ¬ï¼‰

#### ç¼–è¯‘

NSQä½¿ç”¨goæ¨¡å—ç”Ÿæˆå¯é çš„ç‰ˆæœ¬ã€‚

```shell
$ git clone https://github.com/nsqio/nsq
$ cd nsq
$ make
```

#### æµ‹è¯•

```shell
$ ./test.sh
```

## ç”Ÿäº§é…ç½®

å°½ç®¡`nsqd`å¯ä»¥ä½œä¸ºç‹¬ç«‹èŠ‚ç‚¹è¿è¡Œï¼Œä½†è¿™äº›è¯´æ˜å‡å®šæ‚¨æƒ³åˆ©ç”¨å…¶è®¾è®¡çš„åˆ†å¸ƒå¼ç‰¹æ€§ã€‚

éœ€è¦å®‰è£…å’Œè¿è¡Œä¸‰ä¸ªç‹¬ç«‹çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼š

### nsqd

`nsqd` æ˜¯æ¥æ”¶ï¼Œç¼“å†²å’Œä¼ é€’æ¶ˆæ¯åˆ°å®¢æˆ·ç«¯çš„å®ˆæŠ¤ç¨‹åºã€‚

æ‰€æœ‰é…ç½®å‡é€šè¿‡å‘½ä»¤è¡Œå‚æ•°è¿›è¡Œç®¡ç†ã€‚æˆ‘ä»¬åŠ›æ±‚ä½¿å¾—é»˜è®¤é…ç½®é€‚åˆå¤§å¤šæ•°ä½¿ç”¨æƒ…å†µï¼Œä½†æ˜¯ä¸€äº›ç‰¹å®šé€‰é¡¹å€¼å¾—æ³¨æ„ï¼š

`--mem-queue-size`è°ƒæ•´æ¯ä¸ªä¸»é¢˜/é€šé“åœ¨å†…å­˜ä¸­é˜Ÿåˆ—çš„æ¶ˆæ¯æ•°ã€‚æ¶ˆæ¯ç”±å®šä¹‰çš„`--data-path`è¢«é€æ˜åœ°å†™å…¥ç£ç›˜ã€‚

å¦å¤–ï¼Œ`nsqd`éœ€è¦é…ç½®`nsqlookupd`åœ°å€ï¼ˆæœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§ä¸‹æ–‡ï¼‰ã€‚ä¸ºæ¯ä¸ªå®ä¾‹æŒ‡å®š `--lookupd-tcp-address`é€‰é¡¹ã€‚

å°±æ‹“æ‰‘è€Œè¨€ï¼Œæˆ‘ä»¬å»ºè®®`nsqd`ä¸ç”Ÿäº§æ¶ˆæ¯çš„æœåŠ¡å¹¶ç½®è¿è¡Œã€‚

`nsqd`é…ç½®å¯ä»¥é€šè¿‡æŒ‡å®š`--statsd-address`å°†æ•°æ®æ¨é€åˆ°[statsd](https://github.com/bitly/statsdaemon)ã€‚`nsqd` åœ¨`nsq.*`å‘½åç©ºé—´ä¸‹å‘é€ç»Ÿè®¡ä¿¡æ¯ã€‚è¯·å‚è§[nsqd statsd](https://nsq.io/components/nsqd.html#statsd)ã€‚

### nsqlookupd

`nsqlookupd`æ˜¯ä¸€ä¸ªå®ˆæŠ¤ç¨‹åºï¼Œå®ƒä¸ºæ¶ˆè´¹è€…æä¾›è¿è¡Œæ—¶å‘ç°æœåŠ¡ï¼Œä¸ºå…¶æŸ¥æ‰¾ç‰¹å®šä¸»é¢˜çš„`nsqd` ç”Ÿäº§è€…ã€‚

å®ƒä¸ç»´æŠ¤ä»»ä½•æŒä¹…çŠ¶æ€ï¼Œä¸éœ€è¦ä¸ä»»ä½•å…¶ä»–`nsqlookupd` å®ä¾‹åä½œå³å¯æ»¡è¶³æŸ¥è¯¢ã€‚

æ‚¨å¯ä»¥ä»»æ„åœ°æ ¹æ®éœ€æ±‚æ¥è¿è¡Œã€‚å®ƒä»¬ä½¿ç”¨çš„èµ„æºå¾ˆå°‘ï¼Œå¹¶ä¸”å¯ä»¥ä¸å…¶ä»–æœåŠ¡å¹¶ç½®è¿è¡Œã€‚æˆ‘ä»¬çš„å»ºè®®æ˜¯æ¯ä¸ªæ•°æ®ä¸­å¿ƒçš„é›†ç¾¤è‡³å°‘è¿è¡Œ3ä¸ªã€‚

### nsqadmin

To display charts from `graphite`, specify `--graphite-url`. If youâ€™re using a version of `statsd` that adds those silly prefixes to all keys, also specify `--use-statsd-prefixes`. Finally, if graphite isnâ€™t accessible publicly you can have `nsqadmin` proxy those requests by specifying `--proxy-graphite`.

`nsqadmin`æ˜¯ç”¨äºå®æ—¶æ£€æµ‹å’Œç®¡ç†NSQé›†ç¾¤çš„WebæœåŠ¡ã€‚å®ƒä¸`nsqlookupd`å®ä¾‹è¿›è¡Œå¯¹è¯ä»¥å®šä½ç”Ÿäº§è€…ï¼Œå¹¶åˆ©ç”¨[graphite](https://graphiteapp.org/)ç»˜åˆ¶å›¾è¡¨ï¼ˆéœ€è¦åœ¨`nsqd`ç«¯å¯ç”¨`statsd`ï¼‰ã€‚

æ‚¨åªéœ€è¦è¿è¡Œå…¶ä¸­çš„1ä¸ªï¼Œå³å¯å…¬å¼€ï¼ˆå®‰å…¨åœ°ï¼‰è®¿é—®å®ƒã€‚

ä¸ºäº†ä»`graphite`æ˜¾ç¤ºå›¾è¡¨ï¼Œè¯·æŒ‡å®š`--graphite-url`ã€‚å¦‚æœæ‚¨ä½¿ç”¨çš„`statsd`ç‰ˆæœ¬ï¼Œå°†æ„šè ¢çš„å‰ç¼€æ·»åŠ åˆ°äº†æ‰€æœ‰é”®ä¸­ï¼Œé‚£ä¹ˆä¹Ÿè¦æŒ‡å®š`--use-statsd-prefixes`ã€‚æœ€åï¼Œå¦‚æœ`graphite`ä¸èƒ½å…¬å¼€è®¿é—®ï¼Œæ‚¨å¯ä»¥æŒ‡å®š `--proxy-graphite`æ¥è®©`nsqadmin`ä»£ç†é‚£äº›è¯·æ±‚ã€‚

### Monitoring

æ¯ä¸ªå®ˆæŠ¤ç¨‹åºéƒ½æœ‰ä¸€ä¸ª`/ping`HTTPç«¯ç‚¹ï¼Œç”¨äºåˆ›å»º`Nagios`æ£€æŸ¥ã€‚

å¯¹äºå®æ—¶è°ƒè¯•ï¼Œè¿™ä¹Ÿå‡ºå¥‡åœ°å¥½ç”¨ï¼š

```shell
$ watch -n 0.5 "curl -s http://127.0.0.1:4151/stats"
```

é€šå¸¸ï¼Œå¤§å¤šæ•°è°ƒè¯•ã€åˆ†æå’Œç®¡ç†éƒ½æ˜¯é€šè¿‡`nsqadmin`æ¥è¿›è¡Œã€‚

## æ‹“æ‰‘æ¨¡å¼

æœ¬æ–‡æ¡£æè¿°äº†è§£å†³å„ç§å¸¸è§é—®é¢˜çš„ä¸€äº›NSQæ¨¡å¼ã€‚

å…è´£å£°æ˜ï¼šæœ‰ä¸€äº›æ˜æ˜¾çš„æŠ€æœ¯å»ºè®®ï¼Œä½†è¿™ç¯‡æ–‡æ¡£é€šå¸¸ä¼šå¿½ç•¥æ·±å±‚çš„ä¸ªäººç»†èŠ‚ï¼šé€‰æ‹©åˆé€‚çš„å·¥å…·ã€åœ¨ç”Ÿäº§æœºå™¨ä¸Šå®‰è£…è½¯ä»¶ã€ç®¡ç†åœ¨å“ªé‡Œè¿è¡ŒæœåŠ¡ã€æœåŠ¡é…ç½®ã€ä»¥åŠç®¡ç†æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ï¼ˆ`daemontools`ï¼Œ `supervisord`ï¼Œ`init.d`ç­‰ï¼‰ã€‚

### æŒ‡æ ‡é›†åˆ(Metrics Collection)

æ— è®ºæ‚¨è¦æ„å»ºå“ªç§ç±»å‹çš„WebæœåŠ¡ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ‚¨éƒ½å¸Œæœ›æ”¶é›†æŸç§å½¢å¼çš„æŒ‡æ ‡ä»¥äº†è§£æ‚¨çš„åŸºç¡€æ¶æ„ï¼Œç”¨æˆ·æˆ–ä¸šåŠ¡ã€‚

å¯¹äºWebæœåŠ¡ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¿™äº›æŒ‡æ ‡æ˜¯ç”±HTTPè¯·æ±‚ï¼ˆä¾‹å¦‚APIï¼‰å‘ç”Ÿçš„äº‹ä»¶äº§ç”Ÿçš„ã€‚å¤©çœŸçš„æ–¹æ³•æ˜¯åŒæ­¥åœ°æ„å»ºæ­¤ç»“æ„ï¼Œç›´æ¥åœ¨APIè¯·æ±‚å¤„ç†ç¨‹åºä¸­å†™å…¥åˆ°æŒ‡æ ‡ç³»ç»Ÿã€‚

![naive approach](./images/naive_approach.png)

- å½“æŒ‡æ ‡ç³»ç»Ÿå‡ºç°æ•…éšœæ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ
- æ‚¨çš„APIè¯·æ±‚æ˜¯å¦æŒ‚èµ·å’Œ/æˆ–å¤±è´¥ï¼Ÿ
- æ‚¨å°†å¦‚ä½•åº”å¯¹ä¸æ–­å¢åŠ çš„APIè¯·æ±‚æ•°é‡æˆ–æŒ‡æ ‡æ”¶é›†èŒƒå›´æ‰©å±•çš„æŒ‘æˆ˜ï¼Ÿ

è§£å†³æ‰€æœ‰è¿™äº›é—®é¢˜çš„ä¸€ç§æ–¹æ³•æ˜¯ï¼Œä»¥æŸç§æ–¹å¼å¼‚æ­¥æ‰§è¡Œå†™å…¥æŒ‡æ ‡ç³»ç»Ÿçš„å·¥ä½œâ€”ä¹Ÿå°±æ˜¯è¯´ï¼Œå°†æ•°æ®ä»¥æŸä¸ªé¡ºåºæ”¾åœ¨æœ¬åœ°é˜Ÿåˆ—ä¸­ï¼Œç„¶åé€šè¿‡å…¶ä»–è¿›ç¨‹ï¼ˆæ¶ˆè´¹è¯¥é˜Ÿåˆ—ï¼‰å†™å…¥åˆ°ä¸‹æ¸¸ç³»ç»Ÿã€‚å…³æ³¨ç‚¹åˆ†ç¦»ä½¿ç³»ç»Ÿæ›´åŠ å¥å£®å’Œå…·æœ‰å®¹é”™æ€§ã€‚æˆ‘ä»¬ä½¿ç”¨NSQæ¥å®ç°è¿™ä¸€ç›®æ ‡ã€‚

ç®€è¦åˆ‡çº¿ï¼šNSQå…·æœ‰**ä¸»é¢˜**å’Œ**é€šé“**çš„æ¦‚å¿µã€‚åŸºæœ¬ä¸Šï¼Œå¯ä»¥å°†**ä¸»é¢˜**è§†ä¸ºå”¯ä¸€çš„æ¶ˆæ¯æµï¼ˆä¾‹å¦‚ä¸Šé¢çš„APIäº‹ä»¶æµï¼‰ã€‚å°†**é€šé“**è§†ä¸ºç»™å®šçš„ä¸€ç»„æ¶ˆè´¹è€…çš„æ¶ˆæ¯æµå‰¯æœ¬ã€‚ä¸»é¢˜å’Œé€šé“ä¹Ÿéƒ½æ˜¯ç‹¬ç«‹çš„é˜Ÿåˆ—ã€‚è¿™äº›å±æ€§ä½¿NSQæ—¢å¯ä»¥æ”¯æŒå¤šæ’­(`multicast`ï¼Œå°†æ¯ä¸ªä¸»é¢˜æ¶ˆæ¯å¤åˆ¶åˆ°Nä¸ªé€šé“ï¼‰åˆå¯ä»¥æ”¯æŒåˆ†å¸ƒå¼ï¼ˆä¸€ä¸ªé€šé“å°†å…¶æ¶ˆæ¯å¹³å‡åˆ†é…ç»™Nä¸ªæ¶ˆè´¹è€…ï¼‰çš„æ¶ˆæ¯ä¼ é€’ã€‚

è¦æ›´å½»åº•åœ°å¤„ç†è¿™äº›æ¦‚å¿µï¼Œè¯·é˜…è¯»[è®¾è®¡æ–‡æ¡£](https://nsq.io/overview/design.html)å’Œ[Golang NYCæ¼”è®²ä¸­çš„](https://speakerdeck.com/snakes/nsq-nyc-golang-meetup)[å¹»ç¯ç‰‡](https://speakerdeck.com/snakes/nsq-nyc-golang-meetup?slide=19)ï¼Œå°¤å…¶æ˜¯[å¹»ç¯ç‰‡19è‡³33](https://speakerdeck.com/snakes/nsq-nyc-golang-meetup?slide=19)ï¼Œè¯¦ç»†æè¿°äº†ä¸»é¢˜å’Œé€šé“ã€‚

![architecture with NSQ](./images/architecture_with_NSQ.png)

é›†æˆNSQå¾ˆç®€å•ï¼Œè®©æˆ‘ä»¬ä»¥ç®€å•çš„æƒ…å†µä¸ºä¾‹ï¼š

1. åœ¨è¿è¡ŒAPIåº”ç”¨ç¨‹åºçš„åŒä¸€ä¸»æœºä¸Šè¿è¡Œ`nsqd`å®ä¾‹ã€‚
2. æ›´æ–°æ‚¨çš„APIåº”ç”¨ç¨‹åºä»¥å†™å…¥æœ¬åœ°`nsqd`å®ä¾‹ä»¥å°†äº‹ä»¶æ’é˜Ÿï¼Œè€Œä¸æ˜¯ç›´æ¥å†™å…¥æŒ‡æ ‡ç³»ç»Ÿã€‚ä¸ºäº†èƒ½å¤Ÿè½»æ¾åœ°è¿›è¡Œå†…éƒ¨æ£€æŸ¥å’Œæ“ä½œæ•°æ®æµï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨é¢å‘è¡Œçš„`JSON`æ ¼å¼åŒ–æ­¤ç±»æ•°æ®ã€‚å†™å…¥`nsqd`å°±åƒå¯¹`/put`ç«¯ç‚¹æ‰§è¡ŒHTTP POSTè¯·æ±‚ä¸€æ ·ç®€å•ã€‚
3. ä½¿ç”¨æˆ‘ä»¬çš„[å®¢æˆ·ç«¯åº“](https://nsq.io/clients/client_libraries.html)ä¹‹ä¸€ä»¥æ‚¨å–œæ¬¢çš„è¯­è¨€åˆ›å»ºä¸€ä¸ªæ¶ˆè´¹è€… ã€‚"`worker`"å°†è®¢é˜…æ•°æ®æµå¹¶å¤„ç†äº‹ä»¶ï¼Œç„¶åå†™å…¥æŒ‡æ ‡ç³»ç»Ÿã€‚è¿˜å¯ä»¥åœ¨åŒæ—¶è¿è¡ŒAPIåº”ç”¨ç¨‹åºå’Œ`nsqd`çš„ä¸»æœºä¸Šè¿›è¡Œæœ¬åœ°è¿è¡Œã€‚

è¿™æ˜¯ä½¿ç”¨æˆ‘ä»¬çš„å®˜æ–¹[Pythonå®¢æˆ·ç«¯åº“](https://github.com/nsqio/pynsq)ç¼–å†™çš„ç¤ºä¾‹å·¥ä½œ[ç¨‹åº](https://github.com/nsqio/pynsq)ï¼š

```python
import nsq
import json

def metrics_write(message):
    json_data = json.loads(message)
    
    # iterate over the metrics you want to record and write 
    # into your downstream metrics system
    
    if any_metrics_failed:
        # this will indicate to pynsq that it should re-queue 
        # the message for you
        return False
    
    return True

tasks = {"metrics_write": metrics_write}
r = nsq.Reader(tasks, nsqd_tcp_addresses=['127.0.0.1:4150'], 
        topic="api_requests", channel="metrics")
nsq.run()
```

é™¤äº†è§£è€¦ä¹‹å¤–ï¼Œé€šè¿‡ä½¿ç”¨æˆ‘ä»¬å®˜æ–¹å®¢æˆ·ç«¯åº“ä¹‹ä¸€ï¼Œæ¶ˆè´¹è€…å¯ä»¥åœ¨æ¶ˆæ¯å¤„ç†å¤±è´¥æ—¶æ­£å¸¸é™çº§ã€‚æˆ‘ä»¬çš„åº“å…·æœ‰ä¸¤ä¸ªå…³é”®ç‰¹å¾å¯å¸®åŠ©æ‚¨è§£å†³æ­¤é—®é¢˜ï¼š

1. **é‡è¯•**â€”å½“æ‚¨çš„æ¶ˆæ¯å¤„ç†ç¨‹åºæŒ‡ç¤ºå¤±è´¥æ—¶ï¼Œè¯¥æ¶ˆæ¯å°†ä»¥`REQ`ï¼ˆé‡æ–°æ’é˜Ÿï¼‰å‘½ä»¤çš„å½¢å¼å‘é€åˆ°`nsqd`ã€‚æ­¤å¤–ï¼Œå¦‚æœæœªåœ¨å¯é…ç½®çš„æ—¶é—´çª—å£ä¸­å¾—åˆ°å“åº”ï¼Œåˆ™`nsqd`æ¶ˆæ¯å°†è‡ªåŠ¨è¶…æ—¶ï¼ˆå¹¶é‡æ–°æ’é˜Ÿï¼‰ã€‚è¿™ä¸¤ä¸ªå±æ€§å¯¹äºæä¾›(æ¶ˆæ¯)ä¼ é€’ä¿è¯è‡³å…³é‡è¦ã€‚
2. **æŒ‡æ•°é€€é¿(Exponential Backoff )**â€”å½“æ¶ˆæ¯å¤„ç†å¤±è´¥æ—¶ï¼Œè¯»å–å™¨åº“å°†æ ¹æ®è¿ç»­å¤±è´¥çš„æ¬¡æ•°ä½¿æ¥æ”¶å…¶ä»–æ¶ˆæ¯çš„å»¶è¿Ÿæ—¶é—´æˆæŒ‡æ•°å¢é•¿ã€‚å½“è¯»å–å™¨å¤„äºé€€é¿çŠ¶æ€å¹¶å¼€å§‹æˆåŠŸå¤„ç†ç›´åˆ°0æ—¶ï¼Œåˆ™åä¹‹ã€‚

åŒæ—¶ï¼Œè¿™ä¸¤ä¸ªåŠŸèƒ½ä½¿ç³»ç»Ÿèƒ½å¤Ÿè‡ªåŠ¨å“åº”ä¸‹æ¸¸æ•…éšœã€‚

### æŒä¹…åŒ–

å¥½çš„ï¼Œå¾ˆå¥½ï¼Œç°åœ¨æ‚¨å¯ä»¥æ‰¿å—ä»¥ä¸‹æƒ…å†µï¼šæŒ‡æ ‡ç³»ç»Ÿä¸å¯ç”¨ï¼Œæ²¡æœ‰æ•°æ®ä¸¢å¤±ï¼Œä¹Ÿæ²¡æœ‰é™çº§åˆ°å…¶ä»–ç«¯ç‚¹çš„APIæœåŠ¡ã€‚æ‚¨è¿˜å¯ä»¥é€šè¿‡æ·»åŠ æ›´å¤šå·¥ä½œå®ä¾‹ä»åŒä¸€é€šé“è¿›è¡Œæ¶ˆè´¹æ¥æ°´å¹³æ‰©å±•æµçš„å¤„ç†ã€‚

ä½†æ˜¯ï¼Œæƒ³è¦é’ˆå¯¹ç»™å®šçš„APIäº‹ä»¶æå‰ä¸€ç‚¹æ—¶é—´æ”¶é›†æ‰€æœ‰ç±»å‹çš„æŒ‡æ ‡å¾ˆéš¾ã€‚

æ‹¥æœ‰æ•°æ®æµçš„å­˜æ¡£æ—¥å¿—ä»¥ä¾›å°†æ¥è¿›è¡Œä»»ä½•æ“ä½œéš¾é“ä¸å¥½å—ï¼Ÿæ—¥å¿—è¿›è¡Œå†—ä½™å¤‡ä»½æ˜¯ç›¸å¯¹å®¹æ˜“çš„ï¼Œå› æ­¤å¯ä»¥åœ¨ç¾éš¾æ€§çš„ä¸‹æ¸¸æ•°æ®ä¸¢å¤±æƒ…å†µä¸‹ä½¿å…¶æˆä¸ºæŸç§"è®¡åˆ’z"ã€‚ä½†æ˜¯ï¼Œæ‚¨æ˜¯å¦å¸Œæœ›åŒä¸€æ¶ˆè´¹è€…ä¹Ÿè´Ÿè´£å½’æ¡£æ¶ˆæ¯æ•°æ®ï¼Ÿå¯èƒ½ä¸ä¼šï¼Œå› ä¸ºæ•´ä¸ª"å…³æ³¨ç‚¹åˆ†ç¦»"çš„äº‹æƒ…ã€‚

å½’æ¡£NSQä¸»é¢˜æ˜¯ä¸€ç§å¸¸è§çš„æ¨¡å¼ï¼Œæˆ‘ä»¬æ„å»ºäº†ä¸€ä¸ªå®ç”¨ç¨‹åº[nsq_to_file](https://github.com/nsqio/nsq/blob/master/apps/nsq_to_file/nsq_to_file.go)ï¼Œè¯¥å®ç”¨ç¨‹åºä¸NSQæ‰“åŒ…åœ¨ä¸€èµ·ï¼Œå¯ä»¥å®Œå…¨æ»¡è¶³æ‚¨çš„éœ€æ±‚ã€‚

è¯·è®°ä½ï¼Œåœ¨NSQä¸­ï¼Œæ¯ä¸ªä¸»é¢˜çš„æ¯ä¸ªé€šé“éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œå¹¶ä¸”ä¼šæ”¶åˆ°æ‰€æœ‰æ¶ˆæ¯çš„å‰¯æœ¬ã€‚é€šè¿‡åœ¨æ–°é€šé“(`archive`)ä¸Šè¿›è¡Œå½’æ¡£ï¼Œæ‚¨å¯ä»¥åˆ©ç”¨å®ƒæ¥å‘æŒ¥ä¼˜åŠ¿ã€‚å®é™…ä¸Šï¼Œè¿™æ„å‘³ç€å¦‚æœæ‚¨çš„æŒ‡æ ‡ç³»ç»Ÿå‡ºç°é—®é¢˜å¹¶ä¸”`metrics`é€šé“è¿›è¡Œäº†å¤‡ä»½ï¼Œåˆ™ä¸ä¼šå½±å“å•ç‹¬çš„`archive`é€šé“å°†æ¶ˆæ¯æŒä¹…ä¿å­˜åˆ°ç£ç›˜ã€‚

å› æ­¤ï¼Œå°†`nsq_to_file`å®ä¾‹æ·»åŠ åˆ°åŒä¸€ä¸»æœºï¼Œå¹¶ä½¿ç”¨å¦‚ä¸‹æ‰€ç¤ºçš„å‘½ä»¤è¡Œï¼š

```shell
/usr/local/bin/nsq_to_file --nsqd-tcp-address=127.0.0.1:4150 --topic=api_requests --channel=archive
```

![archiving the stream](./images/archiving_the_stream.png)

### åˆ†å¸ƒå¼ç³»ç»Ÿ

æ‚¨ä¼šæ³¨æ„åˆ°ï¼Œè¯¥ç³»ç»Ÿå°šæœªæ‰©å±•è¶…è¿‡ä¸€ä¸ªç”Ÿäº§ä¸»æœºï¼Œè¿™æ˜¯ä¸€ä¸ªæ˜¾è€Œæ˜“è§çš„å•ç‚¹æ•…éšœã€‚

ä¸å¹¸çš„æ˜¯ï¼Œå»ºç«‹ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿ[å¾ˆéš¾](https://twitter.com/b6n/status/276909760010387456)ã€‚å¹¸è¿çš„æ˜¯ï¼ŒNSQå¯ä»¥æä¾›å¸®åŠ©ã€‚ä»¥ä¸‹æ›´æ”¹è¯´æ˜äº†NSQå¦‚ä½•å‡è½»æ„å»ºåˆ†å¸ƒå¼ç³»ç»Ÿçš„æŸäº›ç—›ç‚¹ï¼Œä»¥åŠå…¶è®¾è®¡å¦‚ä½•å¸®åŠ©å®ç°é«˜å¯ç”¨æ€§å’Œå®¹é”™ã€‚

è®©æˆ‘ä»¬å…ˆå‡è®¾è¿™ä¸ªäº‹ä»¶æµç¡®å®å¾ˆé‡è¦ã€‚æ‚¨å¸Œæœ›èƒ½å¤Ÿå®¹å¿ä¸»æœºæ•…éšœï¼Œå¹¶ç»§ç»­ç¡®ä¿æ¶ˆæ¯è‡³å°‘å·²å­˜æ¡£ï¼Œå› æ­¤æ‚¨æ·»åŠ äº†å¦ä¸€å°ä¸»æœºã€‚

![adding a second host](./images/adding_a_second_host.png)

å‡è®¾æ‚¨åœ¨è¿™ä¸¤ä¸ªä¸»æœºä¹‹å‰éƒ½è£…æœ‰æŸç§è´Ÿè½½å‡è¡¡å™¨ï¼Œåˆ™ç°åœ¨å¯ä»¥å®¹å¿ä»»ä½•å•ä¸ªä¸»æœºæ•…éšœã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬å‡è®¾æŒä¹…åŒ–çš„å¤„ç†ï¼Œå‹ç¼©å’Œä¼ è¾“è¿™äº›æ—¥å¿—çš„è¿‡ç¨‹æ­£åœ¨å½±å“æ€§èƒ½ã€‚å¦‚ä½•å°†è´£ä»»åˆ’åˆ†ç»™å…·æœ‰æ›´é«˜IOå®¹é‡çš„ä¸»æœºå±‚ï¼Ÿ

![separate archive hosts](./images/separate_archive_hosts.png)

è¿™ç§æ‹“æ‰‘ç»“æ„å’Œé…ç½®å¯ä»¥è½»æ¾æ‰©å±•åˆ°ä¸¤ä½æ•°çš„ä¸»æœºï¼Œä½†æ˜¯æ‚¨ä»åœ¨æ‰‹åŠ¨ç®¡ç†è¿™äº›æœåŠ¡çš„é…ç½®ï¼Œè¿™æ— æ³•æ‰©å±•ã€‚å…·ä½“æ¥è¯´ï¼Œåœ¨æ¯ä¸ªæ¶ˆè´¹è€…ä¸­ï¼Œæ­¤è®¾ç½®éƒ½ä¼šå¯¹`nsqd`å®ä¾‹æ‰€åœ¨çš„åœ°å€è¿›è¡Œç¡¬ç¼–ç ï¼Œè¿™å¾ˆéº»çƒ¦ã€‚æ‚¨çœŸæ­£æƒ³è¦çš„æ˜¯ä½¿é…ç½®èƒ½å¤Ÿæ ¹æ®NSQé›†ç¾¤çš„çŠ¶æ€è¿›è¡Œæ¼”åŒ–å¹¶åœ¨è¿è¡Œæ—¶è¿›è¡Œè®¿é—®ã€‚è¿™æ­£æ˜¯æˆ‘ä»¬æ„å»º`nsqlookupd`è¦è§£å†³çš„é—®é¢˜ã€‚

`nsqlookupd`æ˜¯ä¸€ä¸ªå®ˆæŠ¤ç¨‹åºï¼Œå®ƒè®°å½•å’Œä¼ æ’­NSQé›†ç¾¤çš„è¿è¡Œæ—¶çŠ¶æ€ã€‚`nsqd`å®ä¾‹ä¿æŒä¸`nsqlookupd`æŒä¹…çš„TCPè¿æ¥ï¼Œ å¹¶é€šè¿‡ç½‘ç»œæ¨é€çŠ¶æ€å˜æ›´ã€‚å…·ä½“æ¥è¯´ï¼Œå¯¹äºç»™å®šçš„ä¸»é¢˜åŠå…¶æ‰€çŸ¥é“çš„æ‰€æœ‰é€šé“ï¼Œ`nsqd` å°†è‡ªå·±æ³¨å†Œä¸ºä¸€ä¸ªç”Ÿäº§è€…ã€‚è¿™æ ·ä¸€æ¥ï¼Œæ¶ˆè´¹è€…å¯ä»¥æŸ¥è¯¢`nsqlookupd`æ¥ç¡®å®šè°æ˜¯å…¶æ„Ÿå…´è¶£çš„ä¸»é¢˜ç”Ÿäº§è€…ï¼Œè€Œä¸ç”¨ç¡¬ç¼–ç è¯¥é…ç½®ã€‚éšç€æ—¶é—´çš„æµé€ï¼Œä»–ä»¬å°†äº†è§£æ–°ç”Ÿäº§è€…çš„å­˜åœ¨ï¼Œå¹¶èƒ½å¤Ÿè§£å†³æ•…éšœã€‚

æ‚¨å”¯ä¸€éœ€è¦åšçš„æ›´æ”¹æ˜¯å°†ç°æœ‰`nsqd`å®ä¾‹å’Œæ¶ˆè´¹è€…å®ä¾‹æŒ‡å‘`nsqlookupd`ï¼ˆæ¯ä¸ªäººéƒ½æ¸…æ¥šåœ°çŸ¥é“`nsqlookupd`å®ä¾‹åœ¨å“ªé‡Œï¼Œä½†æ¶ˆè´¹è€…å´ä¸æ¸…æ¥šç”Ÿäº§è€…åœ¨å“ªé‡Œï¼Œåä¹‹äº¦ç„¶ï¼‰ã€‚ç°åœ¨ï¼Œæ‹“æ‰‘ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š

![adding nsqlookupd](./images/adding_nsqlookupd.png)

ä¹ä¸€çœ‹ï¼Œè¿™å¯èƒ½çœ‹èµ·æ¥æ›´å¤æ‚ã€‚ä½†æ˜¯ï¼Œè¿™å…·æœ‰æ¬ºéª—æ€§ï¼Œå› ä¸ºä¸æ–­å¢é•¿çš„åŸºç¡€æ¶æ„æ‰€äº§ç”Ÿçš„å½±å“å¾ˆéš¾é€šè¿‡è§†è§‰æ–¹å¼è¿›è¡Œäº¤æµã€‚æ‚¨å·²ç»æœ‰æ•ˆåœ°å°†ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…åˆ†ç¦»äº†ï¼Œå› ä¸º `nsqlookupd`ç°åœ¨åœ¨å®ƒä»¬ä¹‹é—´å……å½“ç›®å½•æœåŠ¡ã€‚æ·»åŠ ä¾èµ–äºç»™å®šæ•°æ®æµçš„å…¶ä»–ä¸‹æ¸¸æœåŠ¡å¾ˆç®€å•ï¼Œåªéœ€æŒ‡å®šæ‚¨æ„Ÿå…´è¶£çš„ä¸»é¢˜å³å¯ï¼ˆé€šè¿‡æŸ¥è¯¢`nsqlookupd`å¯ä»¥å‘ç°ç”Ÿäº§è€…ï¼‰ã€‚

ä½†æ˜¯ï¼ŒæŸ¥è¯¢æ•°æ®çš„å¯ç”¨æ€§å’Œä¸€è‡´æ€§åˆå¦‚ä½•å‘¢ï¼Ÿé€šå¸¸ï¼Œæˆ‘ä»¬å»ºè®®æ‚¨æ ¹æ®éœ€è¦çš„å¯ç”¨æ€§è¦æ±‚æ¥å†³å®šè¦è¿è¡Œå¤šå°‘ã€‚`nsqlookupd`ä¸ä¼šå ç”¨å¤§é‡èµ„æºï¼Œå¹¶ä¸”å¯ä»¥è½»æ¾åœ°ä¸å…¶ä»–æœåŠ¡ä¸€èµ·ä½¿ç”¨ã€‚åŒæ ·ï¼Œ`nsqlookupd`å®ä¾‹ä¸éœ€è¦ç›¸äº’åè°ƒæˆ–ä¿æŒä¸€è‡´ã€‚æ¶ˆè´¹è€…é€šå¸¸åªéœ€è¦ä¸€ä¸ª`nsqlookupd`å°±å¯ä»¥è·å¾—ä»–ä»¬éœ€è¦çš„ä¿¡æ¯ï¼ˆä»–ä»¬å°†åˆå¹¶æ‰€çŸ¥é“çš„æ‰€æœ‰`nsqlookupd`å®ä¾‹çš„å“åº”ï¼‰ã€‚ä»æ“ä½œä¸Šè®²ï¼Œè¿™å¾ˆå®¹æ˜“è¿ç§»åˆ°ä¸€ç»„æ–°çš„`nsqlookupd`ã€‚

## docker

è¿™ç¯‡æ–‡ç« è¯¦ç»†ä»‹ç»äº†å¦‚ä½•åœ¨[Docker](https://www.docker.com/)å®¹å™¨ä¸­éƒ¨ç½²å’Œè¿è¡Œ`nsq`äºŒè¿›åˆ¶æ–‡ä»¶ã€‚

æœ‰ä¸€ä¸ªåŒ…å«æ‰€æœ‰NSQäºŒè¿›åˆ¶æ–‡ä»¶çš„æœ€å°`nsq`é•œåƒã€‚åœ¨è¿è¡ŒDockeræ—¶å°†äºŒè¿›åˆ¶æ–‡ä»¶æŒ‡å®šä¸ºå‘½ä»¤å³å¯è¿è¡Œæ¯ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ã€‚åŸºæœ¬æ ¼å¼ä¸ºï¼š

```shell
docker run nsqio/nsq /<command>
```

æ³¨æ„å‘½ä»¤ä¹‹å‰`/`ã€‚ä¾‹å¦‚ï¼š

```shell
docker run nsqio/nsq /nsq_to_file
```

### é“¾æ¥

- [docker](https://www.docker.com/)
- [`nsq` é•œåƒ](https://registry.hub.docker.com/r/nsqio/nsq/)

### è¿è¡Œnsqlookupd

```shell
docker pull nsqio/nsq
docker run --name lookupd -p 4160:4160 -p 4161:4161 nsqio/nsq /nsqlookupd
```

### è¿è¡Œnsqd

é¦–å…ˆï¼Œè·å–Dockerä¸»æœºçš„IPï¼š

```shell
ifconfig | grep addr
```

å…¶æ¬¡ï¼Œè¿è¡Œ`nsqd`å®¹å™¨ï¼š

```shell
docker pull nsqio/nsq
docker run --name nsqd -p 4150:4150 -p 4151:4151 \
    nsqio/nsq /nsqd \
    --broadcast-address=<host> \
    --lookupd-tcp-address=<host>:<port>
```

å°†`--lookupd-tcp-address`æ ‡å¿—è®¾ç½®ä¸ºå…ˆå‰è¿è¡Œ`nsqlookupd`çš„ä¸»æœºçš„IPå’ŒTCPç«¯å£ï¼Œå³`dockerIP:4160`ï¼š

ä¾‹å¦‚ï¼Œå‡è®¾ä¸»æœºIPä¸º`172.17.42.1`ï¼š

```shell
docker run --name nsqd -p 4150:4150 -p 4151:4151 \
    nsqio/nsq /nsqd \
    --broadcast-address=172.17.42.1 \
    --lookupd-tcp-address=172.17.42.1:4160
```

è¯·æ³¨æ„ï¼Œä½¿ç”¨äº†ç«¯å£ `4160`ï¼Œè¿™æ˜¯æˆ‘ä»¬å¯åŠ¨`nsqlookupd`å®¹å™¨æ—¶å…¬å¼€çš„ç«¯å£ï¼ˆå®ƒä¹Ÿæ˜¯`nsqlookupd`çš„é»˜è®¤ç«¯å£ï¼‰ã€‚

å¦‚æœè¦ä½¿ç”¨éé»˜è®¤ç«¯å£ï¼Œè¯·æ›´æ”¹`-p`å‚æ•°ï¼š

```shell
docker run --name nsqlookupd -p 5160:4160 -p 5161:4161 nsqio/nsq /nsqlookupd
```

è¿™å°†ä½¿`nsqlookupd`åœ¨ç«¯å£`5160`å’Œ`5161`çš„`Docker`ä¸»æœºIPä¸Šå¯ç”¨ã€‚

### ä½¿ç”¨TLS

è¦å°†TLSä¸å®¹å™¨åŒ–çš„NSQäºŒè¿›åˆ¶æ–‡ä»¶ä¸€èµ·ä½¿ç”¨ï¼Œæ‚¨éœ€è¦åŒ…æ‹¬è¯ä¹¦æ–‡ä»¶ï¼Œç§é’¥å’Œæ ¹CAæ–‡ä»¶ã€‚Dockeré•œåƒåœ¨ç›®å½•`/etc/ssl/certs/`ä¸‹å…·æœ‰å¯ç”¨çš„å·æŒ‚è½½ï¼Œå¯ç”¨äºæ­¤ç›®çš„ã€‚å°†åŒ…å«æ–‡ä»¶çš„ä¸»æœºç›®å½•æŒ‚è½½åˆ°è¯¥å·ï¼Œç„¶åç…§å¸¸åœ¨å‘½ä»¤è¡Œä¸­æŒ‡å®šæ–‡ä»¶ï¼š

```shell
docker run -p 4150:4150 -p 4151:4151 -p 4152:4152 -v /home/docker/certs:/etc/ssl/certs \
    nsqio/nsq /nsqd \
    --tls-root-ca-file=/etc/ssl/certs/certs.crt \
    --tls-cert=/etc/ssl/certs/cert.pem \
    --tls-key=/etc/ssl/certs/key.pem \
    --tls-required=true \
    --tls-client-auth-policy=require-verify
```

è¿™ä¼šå°†è¯ä¹¦ä»`/home/docker/certs`åŠ è½½åˆ°è¿è¡ŒDockerå®¹å™¨æ—¶ä½¿ç”¨ã€‚

### æŒä¹…åŒ–NSQæ•°æ®

è¦å°†`nsqd`æ•°æ®å­˜å‚¨åœ¨ä¸»æœºç£ç›˜ä¸Šï¼Œè¯·å°†`/data`å·ç”¨ä½œæ‚¨çš„æ•°æ®ç›®å½•ï¼Œè¯¥ç›®å½•å¯è®©æ‚¨æŒ‚è½½åˆ°[ä»…æ•°æ®çš„Dockerå®¹å™¨](https://docs.docker.com/userguide/dockervolumes/#creating-and-mounting-a-data-volume-container) æˆ–æŒ‚è½½åˆ°ä¸»æœºç›®å½•ï¼š

```shell
docker run nsqio/nsq /nsqd \
    --data-path=/data
```

### ä½¿ç”¨docker-compose

è¦å¯åŠ¨`nsqd`ï¼Œ`nsqlookupd`ä»¥åŠ`nsqadmin`å…±åŒä½¿ç”¨`docker-compose`ï¼Œç„¶ååˆ›å»ºä¸€ä¸ª`docker-compose.yml`ã€‚

```yaml
version: '3'
services:
  nsqlookupd:
    image: nsqio/nsq
    command: /nsqlookupd
    ports:
      - "4160"
      - "4161"
  nsqd:
    image: nsqio/nsq
    command: /nsqd --lookupd-tcp-address=nsqlookupd:4160
    depends_on:
      - nsqlookupd
    ports:
      - "4150"
      - "4151"
  nsqadmin:
    image: nsqio/nsq
    command: /nsqadmin --lookupd-http-address=nsqlookupd:4161
    depends_on:
      - nsqlookupd  
    ports:
      - "4171"
```

ä»åˆ›å»º`docker-compose.yml`ç›¸åŒçš„ç›®å½•ä¸­å¼€å§‹è¿è¡Œä»¥ä¸‹å‘½ä»¤ã€‚

```shell
docker-compose up -d
```

å°†åˆ›å»ºä¸€ä¸ªä¸“ç”¨ç½‘ç»œï¼Œå¹¶ä½¿ç”¨è¯¥ä¸“ç”¨ç½‘ç»œå¯åŠ¨ä¸‰ä¸ªå®¹å™¨ã€‚åœ¨æœ¬åœ°ä¸»æœºä¸Šï¼Œæ¯ä¸ªå®¹å™¨å°†å…·æœ‰ä¸€ä¸ªéšæœºç«¯å£ï¼Œè¯¥ç«¯å£æ˜ å°„åˆ°`docker-compose.yml`ä¸­æš´éœ²çš„ç«¯å£ã€‚

æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„å®¹å™¨çŠ¶æ€å’Œæ˜ å°„çš„ç«¯å£ã€‚

```shell
docker-compose ps
```

æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„å®¹å™¨ä¸­çš„æ—¥å¿—ã€‚

```shell
docker-compose logs
```

å‡è®¾`nsqlookupd`å·²å°†ä¸»æœºç«¯å£31001æ˜ å°„åˆ°å®¹å™¨ç«¯å£4161ï¼Œåˆ™å¯ä»¥ä½¿ç”¨è¿›è¡Œç®€å•çš„ping `curl`ã€‚

```shell
curl http://127.0.0.1:31001/ping
```

# é“¾æ¥

## TALKS AND SLIDES

- 2012-11-08 - **NYC Golang Meetup** [slides](https://speakerdeck.com/snakes/nsq-nyc-golang-meetup) ([@imsnakes](https://twitter.com/imsnakes) & [@jehiah](https://twitter.com/jehiah) of Bitly)
- 2013-02-13 - **PHP UK 2013, Planning To Fail** [slides](https://speakerdeck.com/davegardnerisme/planning-to-fail) ([@davegardnerisme](https://twitter.com/davegardnerisme) of Hailo)
- 2013-04-03 - **PhillyETE 2013, Stream Processing: Philosophy, Concepts, and Technologies** [video](https://www.infoq.com/presentations/data-streaming-nsq) [slides](https://speakerdeck.com/danielhfrank/stream-processing-philosophy-concepts-and-technologies) ([@danielhfrank](https://twitter.com/danielhfrank) of Bitly)
- 2013-05-15 - **NYC Data Engineering Meetup** [slides](https://speakerdeck.com/snakes/nsq-nyc-data-engineering-meetup) [video](https://www.youtube.com/watch?v=IkU8JsxdCAM) ([@imsnakes](https://twitter.com/imsnakes) & [@jehiah](https://twitter.com/jehiah) of Bitly)
- 2013-06-17 - **C\* Summit 2013, Big Architectures for Big Data** [slides](https://www.slideshare.net/planetcassandra/2-eric-lubow) [video](https://www.youtube.com/watch?v=dT0A0bh_CLw) ([@elubow](https://twitter.com/elubow) of simplereach)
- 2013-06-19 - **SF Golang Meetup** [video](https://plus.google.com/u/0/events/ckpnkggt52aoc7vagkctqsjg6v8) ([@imsnakes](https://twitter.com/imsnakes) of Bitly)
- 2014-01-11 - **Data Days Texas 2014** [slides](https://eric.lubow.org/presentations/data-day-texas-2014/) ([@elubow](https://twitter.com/elubow) of SimpleReach)
- 2014-04-24 - **GopherCon 2014** [video](https://confreaks.com/videos/3429-gophercon2014-spray-some-nsq-on-it) [slides](https://speakerdeck.com/snakes/spray-some-nsq-on-it) ([@imsnakes](https://twitter.com/imsnakes) of Torando Labs)
- 2015-06-02 - **Berlin Buzzwords 2015** [video](https://www.youtube.com/watch?v=OwD-W7uU2zU) [slides](https://georgi.io/scale-with-nsq) ([@GeorgiCodes](https://twitter.com/GeorgiCodes) of Bitly)
- 2015-07-30 - **Munich Node.js User Group** [video](https://www.youtube.com/watch?v=xhNapGc6SsU) ([@juliangruber](https://twitter.com/juliangruber) of NowSecure)
- 2018-06-12 - Building a distributed message processing system in Go using NSQ [slides](https://bit.ly/nsqslides) ([@GBrayUT][https://twitter.com/GBrayUT] of Walmart Labs)

## [Release Notes](https://github.com/nsqio/nsq/releases)

## [Github Repo](https://github.com/nsqio/nsq)

## [Issues](https://github.com/nsqio/nsq/issues)

## [Google Group](https://groups.google.com/group/nsq-users)
